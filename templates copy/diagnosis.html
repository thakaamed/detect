{% extends 'base.html' %}
{% load static %}
{% load i18n %}
{% block customCss %}
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="{% static 'css/bootstrap.css' %}">
    <link rel="stylesheet" href="{% static 'css/fontawesome.css' %}">
    <link rel="stylesheet" href="{% static 'css/diagnosis.css' %}">
    <link rel="stylesheet" href="{% static 'css/patients_exstra.css' %}">
    <link rel="stylesheet" href="{% static 'css/dropzone.css' %}">
    <link rel="stylesheet" href="{% static 'css/leaflet-geoman.css' %}"/>
    <title>{{specs.title}} - Diagnosis</title>
    <link rel="icon" type="image/png" href="{% static specs.favicon %}" />
    <link rel="stylesheet" href="{% static 'css/drawing.css' %}"/>
    <link rel="stylesheet" href="{% static 'css/exstra.css' %}"/>
    <link rel="stylesheet" href="{% static 'css/leaflet-geoman.css' %}"/>
    <link rel="stylesheet" href="{% static 'css/leaflet.css' %}"/>
    <link rel="stylesheet" href="{% static 'css/leaflet.draw.css' %}"/>
    <link rel="stylesheet" href="{% static 'css/leaflet-ruler.css' %}"/>
    <link rel="stylesheet" href="{% static 'css/papaya.css' %}"/>
    <link rel="stylesheet" href="{% static 'css/toastify.css' %}"/>
    <link rel="stylesheet" href="{% static 'css/filepond.css' %}" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
    <script src="{% static 'js/filepond.js' %}"></script> <!--  dropzone alternatifi dosya yükleme -->
    <script src="{% static 'js/jquery.js' %}"></script>


    <!-- <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/dropzone/5.9.3/dropzone.css" integrity="sha512-7uSoC3grlnRktCWoO4LjHMjotq8gf9XDFQerPuaph+cqR7JC9XKGdvN+UwZMC14aAaBDItdRj3DcSDs4kMWUgg==" crossorigin="anonymous" referrerpolicy="no-referrer" /> -->
    <style>
        * {
            user-select: none;
        }
        .text-label-healthy {
            color: #FF5050;
        }
        .text-label-unhealthy {
            color: #5bff58;
        }
        .text-success-i {
            color: #A8FFAC!important;
        }
        .text-danger-i {
            color: #FF5050!important;
        }
        .icon * {
            white-space: nowrap;
        }
        .imgToChange {
            cursor: pointer;
        }
        .weekstrong-checkbox {
            inset: 0;
            cursor: pointer;
            opacity: 0;
        }
        .weekstrong-checkbox + p + p {
            color: #6c757d;
        }
        .weekstrong-checkbox:checked + p + p{
            color: #eee!important;
        }
        .search-input,
        .search-input::placeholder {
            color: rgba(255, 255, 255, .7)!important;
        }
        .modal-container .checkbox {
            position: relative;
            background-color: #6479c0;
            border-radius: 3px;
            width: 16px;
            height: 16px;
            overflow: hidden;
        }
        .modal-container .checkbox i {
            display: none;
            font-size: 12px;
        }
        .modal-container .checkbox input[type=checkbox] {
            position: absolute;
            inset: 0;
            opacity: 0;
            cursor: pointer;
        }
        .modal-container .checkbox input[type=checkbox]:checked + i {
            display: flex;
            width: 100%;
            height: 100%;
            justify-content: center;
            align-items: center;
        }
        .ck-editor__editable[role="textbox"] {
            color: #111;
            min-height: 300px;
        }
        .ck.ck-powered-by {
            display: none;
        }
        .ck.ck-editor {
            flex: 1;
            display: flex;
            flex-direction: column;
        }
        .ck.ck-editor__main,
        .ck-restricted-editing_mode_standard {
            height: 100%;
        }
        .map-hover-popup {
            background-color: rgba(56, 71, 122, 0.7);
            backdrop-filter: blur(2px);
            border-left: 2px solid white;
            color: #eee;
            padding: 10px 20px;
            display: inline-flex;
            position: absolute;
            z-index: 999;
            top: 0;
            left: 0;
            display: none;
        }
        .map-hover-popup .like,
        .map-hover-popup .unlike {
            cursor: pointer;
        }
        .map-hover-popup__root {
            background-color: #eee;
            position: absolute;
            outline: 1px solid #eee;
            outline-offset: 2px;
        }
        .dropzone.dz-started .dz-message {
            display: block !important;
        }

        #dropZone {
            padding: 10px;
            width: 100%;
            border-radius: 10px;
            background-color: transparent;
        }

        .dropzone {
            border: 2px dashed #526092!important;
            background-color: transparent;
            border-radius: 10px;
            cursor: pointer;
        }
        .dropzone .dz-preview:not(.dz-processing) .dz-progress {
            display: none;
        }
        .dropzone .dz-preview.dz-image-preview {
            background-color: transparent;
            margin: 5px 0;
        }
        .planning-item-box:hover {
            background-color: rgb(231, 231, 231);
        }
        .planning-item-box p:nth-of-type(1) {
            cursor: pointer;
        }
        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }
            100% {
                transform: rotate(360deg);
            }
        }
        #back-img-frame .loading{
            background-color: rgba(0, 0, 0, .7);
        }
        #back-img-frame .loading i,
        #page-loading i{
            animation: spin 1s linear infinite;
        }
        #back-img-frame {
            height: auto!important;
        }
        .leaflet-bottom.leaflet-right {
            display: none;
        }
        .tooth-percent:hover {
            text-decoration: underline;
            cursor: pointer!important;
        }
        .tooth-menu.active.left-opened::before {
            /* diagnosis sayfasındaki diş menüsünün açıldığında taşmamasını sağlamak */
            content: '';
            right: auto!important;
            left: 100%!important;
            transform: translateY(-50%) rotate(180deg)!important;
        }
        #doctor-comment-area {
            border-radius: 5px;
            transition: top ease-in-out 500ms;
        }

        #doctor-comment-save-btn:hover,
        #doctor-comment-cancel-btn:hover {
            color: #fff!important;
        }

        /* fişler için diş kutusu stillendirmesi */
        .root {
            border-radius: 50%;
            width: 10px;
            height: 10px;
            background-color: #eee;
            outline: 1px solid #eee;
            outline-offset: 4px;
            display: none;
        }

        .line {
            height: 0;
            width: 1px;
            background-color: #eee;
            transform: translateX(-50%);
        }

        .tooth-number-value {
            width: 30px;
            height: 30px;
            border: 1px solid #eee;
            opacity: 0;
        }

        @keyframes increaseHeightTopTooth {
            0% {
                height: 0;
                margin-top: 0;
            }

            100% {
                height: 100px;
                margin-top: -100px;
            }
        }

        @keyframes increaseHeightBottomTooth {
            0% {
                height: 0;
            }

            100% {
                height: 100px;
            }
        }
        /* dişler için diş kutusu stillendirmesi end */
        #teethDrawSvg-eng {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0);
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 99999;
        }
        .tooth .item img {
            max-width: 100%;
            height: 55px;
            max-height: 55px;
            margin-top: 5px;
        }
        .tooth .item img.auto-height {
            height: auto!important;
            max-height: 55px;
        }

        path.drawsElement[data-pointer-events="false"] {
            pointer-events: none!important;
        }

        .draw-icon-item img.active {
            background-color: rgba(255, 255, 255, .2);
        }
        #page-loading {
        backdrop-filter: blur(8px);
        -webkit-backdrop-filter: blur(8px); /* Safari desteği için gerekli */
        display: flex;
        }
        .doctorAddedIllnessCircle {
            width: 17px;
            height: 17px;
            border-radius: 50%;
            background-color: #0057FF;
            display: flex;
            justify-content: center;
            align-items: center;
            position: absolute;
            z-index: 9;
            cursor: pointer;
            transform: translate(-50%, -50%);
        }

        .doctorAddedIllnessCircle i {
            font-size: 10px;
        }

        /* labelling stillendirme start */
        #labeling-box {
            min-width: 250px;
            height: 200px;
            position: absolute;
            z-index: 90;
            color: #aaa;
        }

        #diseases-list-container {
            overflow-y: auto;
            gap: 5px;
        }

        .diseases-item {
            gap: 7px;
        }

        .check-container {
            width: 17px;
            height: 17px;
            border-radius: 50%;
            overflow: hidden;
            cursor: pointer;
        }

        .check-container .check-container-bg {
            background-color: #898989;
            inset: 0;
        }

        .check-container input[type="radio"] {
            position: absolute;
            inset: 0;
            opacity: 0;
            z-index: 12;
            cursor: pointer;
        }

        .check-container input[type="radio"]:checked  + .check-container-bg{
            background-color: #0057FF;
        }

        .check-container input[type="radio"]:checked  + div + i {
            opacity: 1;
            transform: rotate(0deg);
        }

        .check-container i {
            font-size: 10px;
            color: white;
            position: absolute;
            inset: 0;
            z-index: 3;
            text-align: center;
            line-height: 17px;
            transform: rotate(-360deg);
            transition: ease-in-out 300ms transform;
            opacity: 0;
        }

        .check-container + label {
            cursor: pointer;
            user-select: none;
        }
        /* labelling stillendirme end */
        #modal-report .icon-container,
        #modalReportForMail .icon-container {
            border: 1px solid #303030;
            border-radius: 5px;
            width: 85px;
            height: 85px;
        }
        input[data-type="reporting-custom-radio-input"] {
            pointer-events: none;
            position: absolute;
            opacity: 0;
        }
        #modal-report .icon-container img.selected,
        #modalReportForMail .icon-container img.selected,
        input[data-type="reporting-custom-radio-input"]:checked + label img.not-selected {
            display: none;
        }

        input[data-type="reporting-custom-radio-input"]:checked + label img + img.selected {
            display: block!important;
        }

        input[data-type="reporting-custom-radio-input"]:checked + label .icon-container {
            border: 1px solid #5071C8!important;
        }

        input[data-type="reporting-custom-radio-input"]:checked + label + p {
            color: #5071C8;
        }
        #measurement {
                position: absolute;
                    background-color: rgba(0, 0, 255, 0.3);
                    pointer-events: none;
                    font-family: Arial, sans-serif;
                    font-size: 14px;
                    padding: 5px;
                    display: none;
            z-index: 99999;
        }
        #back-value {
            width: 30px;
            height: 15px;
            z-index: 99;
            background-color: #5071C8;
            transition: width ease-in-out 300ms;
        }
        #background-base {
            width: 240px;
            height: 15px;
            z-index: -1;
            background-color: #364064;
        }
        #back-marked {
            width: 20px;
            height: 20px;
            border: 2px solid white;
            z-index: 999;
            border-radius: 50%;
            left: 12.5%;
            transform: translate(-50%, -50%);
            transition: left ease-in-out 300ms;
            background-color: #5071C8;
        }
        #triangele-back {
            height: 20px;
            width: 60px;
            top: 7px;
            background-color: #5071C8;
            border-radius: 2px;
            left: 0%;
            transition: left ease-in-out 300ms;
        }
        #triangele-back::before {
            content: '';
            display: block;
            width: 5px;
            height: 5px;
            position: absolute;
            left: 50%;
            top: 100%;
            transform: translateX(-50%);
            border: 2.5px solid #5071C8;
            border-left-color: transparent;
            border-right-color: transparent;
            border-bottom-color: transparent;
        }
        .treatment-section {
            position: absolute;
            width: 100%;
            height: 100%;
            overflow-y: auto;
            border-radius: 10px;
        }
        .treatment-section.chapter-1,
        .treatment-section.chapter-2 {
            transition: top ease-in-out 500ms;
        }
        .treatment-section.chapter-1 {
            top: -200%;
        }
        .treatment-section.chapter-1 .half {
            background-color: #1A264E;
        }
        .treatment-section.chapter-1 .half:not(:first-child) {
            background-color: white;
        }
        .treatment-section.chapter-1.active {
            top: 0;
        }

        .treatment-section.chapter-2 {
            top: 200%;
        }

        .treatment-section.chapter-2.active {
            top: 0;
        }
        #exam_questions {
            padding: 27px;
        }
        .custom-hr {
            width: 100%;
            height: 1px;
            background-color: #3B4978;
            margin: 20px 0;
        }
        .slider input[type="range"] {
            position: absolute;
            inset: 0;
            z-index: 9999999999999999;
            cursor: pointer;
            opacity: 0;
        }

        .diagnosis_expand_btn{
            width: fit-content;
            padding: 8px;
            float: right;
            background-color: #111C43;
            border-radius: 8px;
            line-height: 1;
        }


        
    </style>
    
{% endblock %}
{% block headerButtons %}
    <a href="{% url 'diagnosisNewPage' image_report_id %}">
        <button class="custom transparent blue-hover text-light">
            <img src="{% static 'img/treatment-planning-icon.svg' %}" class="" height="14" alt="">
            <span>{% trans 'Treatment Wizard' %}</span>
        </button>
    </a>
    <button class="custom transparent blue-hover text-light" data-open-modal-pk="modal-radyografy-upload">
        <img src="{% static 'img/upload-rg-icon.svg' %}" class="" height="12" alt="">
        <span style="pointer-events: none;">{% trans 'Upload Radiography' %}</span>
    </button>
    <button class="custom transparent blue-hover text-light" data-open-modal-pk="modal-report">
        <img src="{% static 'img/export-report-icon.svg' %}" class="" height="12" alt="">
        <span style="pointer-events: none;">{% trans 'Export Report' %}</span>
    </button>
    <button class="custom transparent blue-hover text-light" data-open-modal-pk="modalReportForMail">
        <img src="{% static 'img/send-mail-icon.svg' %}" class="" height="10" alt="">
        <span style="pointer-events: none;">{% trans 'Send Mail' %}</span>
    </button>
    <button class="custom transparent blue-hover text-light" data-open-treatment>
        <img src="{% static 'img/treatment-planning-icon.svg' %}" class="" height="14" alt="">
        <span>{% trans 'Treatment Planning' %}</span>
    </button>
    
{% endblock %}
{% block content %}
<div id="labeling-box" class="bg-light rounded p-2 d-none flex-column flex-wrap">
    <input type="search" class="form-control" style="height: 30px; font-size: 12px" placeholder="{% trans 'Search' %}" oninput="liveSearch(event, $('.labeling-box_content label'), '{% trans "The disease you are looking for was not found" %}', $('.labeling-box_search-error'), 1)">
    <div id="diseases-list-container" class="d-flex flex-column p-2 mt-2" style="flex: 1">
        <div class="labeling-box_search-error"></div>
        <div class="labeling-box_content d-flex flex-column" style="gap: 5px;"></div>
    </div>
</div>

<svg id="teethDrawSvg-eng"></svg>
<div id="page-loading" class="position-fixed align-items-center justify-content-center" style="inset: 0; z-index: 9999999999;">
    <i class="fa-solid fa-spinner fs-1"></i>
</div>
<div class="teeth-draw-container" style="position: fixed; inset: 0; z-index: 999; pointer-events: none;"></div>
<div id="modal-delete-treatment" class="modal-container">
    <div class="modal-box">
        <div class="modal-box__close">
            <div class="close-icon" data-modal-close>
                <i class="fa-solid fa-xmark"></i>
            </div>
        </div>
        <div class="modal-big-icon">
            <i class="fa-regular fa-trash-can shadow"></i>
        </div>
        <p class="main-text w-75 mx-auto text-center">{% trans 'Are you sure you want to delete treatment?' %}</p>
        <div class="modal-container__buttons d-flex justify-content-center">
            <button class="custom yes" data-btn-operation="delete-treatment" data-modal-close>{% trans 'Yes' %}</button>
            <button class="custom no" data-modal-close>{% trans 'No' %}</button>
        </div>
    </div>
</div>
<div id="modalDeleteRadiography" class="modal-container">
    <div class="modal-box">
        <div class="modal-box__close">
            <div class="close-icon" data-modal-close>
                <i class="fa-solid fa-xmark"></i>
            </div>
        </div>
        <p class="main-text w-75 mx-auto text-center">{% trans 'Are you sure you want to delete radiography?' %}</p>
        <div class="modal-container__buttons d-flex justify-content-center">
            <button class="custom yes" data-btn-operation="delete-radiography" data-modal-close>{% trans 'Yes' %}</button>
            <button class="custom no" data-modal-close>{% trans 'No' %}</button>
        </div>
    </div>
</div>
<div id="modal-remove-doctor-draw" class="modal-container">
    <div class="modal-box">
        <div class="modal-box__close">
            <div class="close-icon" data-modal-close>
                <i class="fa-solid fa-xmark"></i>
            </div>
        </div>
        <div class="modal-big-icon">
            <i class="fa-regular fa-trash-can shadow"></i>
        </div>
        <p class="main-text w-75 mx-auto text-center">{% trans 'Are you sure you want to remove this section?' %}</p>
        <div class="modal-container__buttons d-flex justify-content-center">
            <button id="removeThisDoctorDraw" class="custom yes" data-modal-close>{% trans 'Yes' %}</button>
            <button class="custom no" data-modal-close>{% trans 'No' %}</button>
        </div>
    </div>
</div>
<div id="modalReportForMail" class="modal-container">
    <div class="modal-box">
        <div class="modal-box__close">
            <div class="close-icon" data-modal-close>
                <i class="fa-solid fa-xmark"></i>
            </div>
        </div>
        <p class="fs-4 mb-4">{% trans 'Send Mail' %}</p>
        <p class="fs-6 mb-1">{% trans '1. Mail Information' %}</p>
        <p class="text-muted">{% trans 'Enter the information of the person you are sending the email to.' %}</p>
        <div class="d-flex">
            <label for="" class="me-3">
                {% trans 'Name Surname' %}
                <input id="nameForSendMail" type="text" class="my-2" name="shadow-none border" value="{{patient_full_name}}" placeholder="{% trans 'Write name..' %}">
            </label>
            <label for="">
                {% trans 'E-Mail' %}
                <input id="emailForSendMail" type="email" class="my-2" name="report-email-input" value="{% if patient_email%}{{patient_email}}{%else%}{%endif%}" placeholder="{% trans 'Write e-mail' %}">
            </label>
        </div>
        <p class="fs-6 mb-1">{% trans '2. Report Format' %}</p>
        <p class="text-muted">{% trans 'Choose in which format you will create the report' %}</p>
        <div class="d-flex mb-4" style="gap: 20px">
            <div class="report-radio-container">
                <input checked type="radio" name="reporting-area-mail" data-type="reporting-custom-radio-input" value="PATIENT" id="patient-input-mail">
                <label for="patient-input-mail" class="m-0">
                    <div class="icon-container d-flex align-items-center justify-content-center">
                        <img src="{% static 'img/report-icon2.svg' %}" class="not-selected" alt="" width="35">
                        <img src="{% static 'img/report-icon2-active.svg' %}" class="selected" alt="" width="35">
                    </div>
                </label>
                <p class="my-1 text-center">{% trans 'Patient Format' %}</p>
            </div>
        </div>
        <p class="fs-6 mb-1">{% trans '3. Information to Display' %}</p>
        <p class="text-muted">{% trans 'Select the information you want to displayed in the report' %}</p>
        <div class="d-flex align-items-start mt-1 mb-2">
            <input {% if doctor_choices_dict.patient_infos %} checked {% endif %} type="checkbox" name="report-modal-checkbox" id="report-ch-mail-1" class="me-2">
            <label class="input-text d-flex flex-column m-0" for="report-ch-mail-1">
                <p class="fw-bold m-0">{% trans 'Patient Informations' %}</p>
                <p class="m-0 text-muted">{% trans 'Include patient information in the report' %}</p>
            </label>
        </div>
        <div class="d-flex align-items-start mt-1 mb-2">
            <input {% if doctor_choices_dict.undrawed_radiography %} checked {% endif %} type="checkbox" name="report-modal-checkbox" id="report-ch-mail-2" class="me-2">
            <label class="input-text d-flex flex-column m-0" for="report-ch-mail-2">
                <p class="fw-bold m-0">{% trans 'Radiography' %}</p>
                <p class="m-0 text-muted">{% trans 'Include radiography information in the report' %}</p>
            </label>
        </div>
        <div class="d-flex align-items-start mt-1 mb-2">
            <input {% if doctor_choices_dict.drawed_radiography %} checked {% endif %} type="checkbox" name="report-modal-checkbox" id="report-ch-mail-3" class="me-2">
            <label class="input-text d-flex flex-column m-0" for="report-ch-mail-3">
                <p class="fw-bold m-0">{% trans 'Drawed Radiography' %}</p>
                <p class="m-0 text-muted">{% trans 'Include drawed radiography information in the report' %}</p>
            </label>
        </div>
        <div id="additional-mail-options" style="margin-left:40px; {% if doctor_choices_dict.drawed_radiography %} display: block; {% else %} display: none; {% endif %}">
        {% if doctor_choices_dict.selected_drawed_radiography == False and doctor_choices_dict.all_drawed_radiography == False %}
        <div class="d-flex align-items-start mt-1 mb-2">
            <input type="radio" name="additional-mail-option" id="additional-ch-mail-1" class="me-2">
            <label class="input-text d-flex flex-column m-0" for="additional-ch-mail-1">
                <p class="fw-bold m-0">{% trans 'Draw the Diseases I chose' %}</p>
            </label>
        </div>
        <div class="d-flex align-items-start mt-1 mb-2">
            <input type="radio" name="additional-mail-option" id="additional-ch-mail-2" class="me-2" checked>
            <label class="input-text d-flex flex-column m-0" for="additional-ch-mail-2">
                <p class="fw-bold m-0">{% trans 'Draw all Diseases' %}</p>
            </label>
        </div>
        {% else %}
        <div class="d-flex align-items-start mt-1 mb-2">
            <input type="radio" name="additional-mail-option" id="additional-ch-mail-1" class="me-2" {% if doctor_choices_dict.selected_drawed_radiography %} checked {% endif %}>
            <label class="input-text d-flex flex-column m-0" for="additional-ch-mail-1">
                <p class="fw-bold m-0">{% trans 'Draw the Diseases I chose' %}</p>
            </label>
        </div>
        <div class="d-flex align-items-start mt-1 mb-2">
            <input type="radio" name="additional-mail-option" id="additional-ch-mail-2" class="me-2" {% if doctor_choices_dict.all_drawed_radiography %} checked {% endif %}>
            <label class="input-text d-flex flex-column m-0" for="additional-ch-mail-2">
                <p class="fw-bold m-0">{% trans 'Draw all Diseases' %}</p>
            </label>
        </div>
        {% endif %}
        <div class="d-flex align-items-start mt-1 mb-2">
            <input type="checkbox" name="additional-mail-option" id="additional-ch-mail-3" class="me-2" {% if doctor_choices_dict.draw_numbering %} checked {% endif %}>
            <label class="input-text d-flex flex-column m-0" for="additional-ch-mail-3">
                <p class="fw-bold m-0">{% trans 'Draw Teeth Numbering' %}</p>
            </label>
        </div>
        </div>
        <div class="d-flex align-items-start mt-1 mb-2">
            <input {% if doctor_choices_dict.doctor_note %} checked {% endif %} type="checkbox" name="report-modal-checkbox" id="report-ch-mail-4" class="me-2">
            <label class="input-text d-flex flex-column m-0" for="report-ch-mail-4">
                <p class="fw-bold m-0">{% trans 'Doctor Note' %}</p>
                <p class="m-0 text-muted">{% trans 'Include doctor note in the report' %}</p>
            </label>
        </div>
        <div class="d-flex align-items-start mt-1 mb-2">
            <input {% if doctor_choices_dict.treatment_plannings %} checked {% endif %} type="checkbox" name="report-modal-checkbox" id="report-ch-mail-5" class="me-2">
            <label class="input-text d-flex flex-column m-0" for="report-ch-mail-5">
                <p class="fw-bold m-0">{% trans 'Treatment Plannigs' %}</p>
                <p class="m-0 text-muted">{% trans 'Include treatment plannings in the report' %}</p>
            </label>
        </div>
        <div class="d-flex align-items-start mt-1 mb-2">
            <input {% if doctor_choices_dict.doctor_signature %} checked {% endif %} type="checkbox" name="report-modal-checkbox" id="report-ch-mail-6" class="me-2">
            <label class="input-text d-flex flex-column m-0" for="report-ch-mail-6">
                <p class="fw-bold m-0">{% trans 'Doctor Signature' %}</p>
                <p class="m-0 text-muted">{% trans 'Include doctor signature in the report' %}</p>
            </label>
        </div>
        <div class="d-flex align-items-start mt-1 mb-2">
            <input type="checkbox" name="report-modal-checkbox" id="report-ch-mail-7" class="me-2">
            <label class="input-text d-flex flex-column m-0" for="report-ch-mail-7">
                <p class="fw-bold m-0">{% trans 'Generate QR Code' %}</p>
                <p class="m-0 text-muted">{% trans 'Generate QR Code for Patient Mail' %}</p>
            </label>
        </div>
        <p class="fs-6 mb-1">{% trans '4. Choose Your Report Filter' %}</p>
        <p class="text-muted">{% trans 'Choose on what basis your report will be based' %}</p>
        <div class="d-flex" style="gap: 20px">

            <div class="report-radio-container">
                <input checked type="radio" name="report-data-mail" data-type="reporting-custom-radio-input" value="TOOTH" id="tooth-based-input-mail">
                <label for="tooth-based-input-mail" class="m-0">
                    <div class="icon-container d-flex align-items-center justify-content-center">
                        <img src="{% static 'img/report-icon5.svg' %}" class="not-selected" alt="" width="35">
                        <img src="{% static 'img/report-icon5-active.svg' %}" class="selected" alt="" width="35">
                    </div>
                </label>
                <p class="my-1 text-center">{% trans 'Tooth Based' %}</p>
            </div>
        </div>
        <div class="d-flex justify-content-between">
            <label for="save-choices-for-mail" class="d-flex align-items-center">
                <input type="checkbox" name="save-choices-for-mail" id="save-choices-for-mail" class="me-2">
                {% trans 'Save my choices' %}
            </label>
            <div class="modal-container__buttons ms-5 me-2">
                <button class="custom no" data-modal-close>{% trans 'Cancel' %}</button>
            </div>
            <div class="modal-container__buttons">
                <button id="sendReportMail" class="custom yes" data-modal-close>{% trans 'Send Mail' %}</button>
            </div>
        </div>

    </div>
</div>
<div id="modal-report" class="modal-container">
    <div class="modal-box">
        <div class="modal-box__close">
            <div class="close-icon" data-modal-close>
                <i class="fa-solid fa-xmark"></i>
            </div>
        </div>
        <p class="fs-4 mb-4">{% trans 'Export Report' %}</p>
        <p class="fs-6 mb-1">{% trans '1. Report Format' %}</p>
        <p class="text-muted">{% trans 'Choose in which format you will create the report' %}</p>
        <div class="d-flex mb-4" style="gap: 20px">
            <div class="report-radio-container">
                <input checked type="radio" name="reporting-area" data-type="reporting-custom-radio-input" value="PATIENT" id="patient-input">
                <label for="patient-input" class="m-0">
                    <div class="icon-container d-flex align-items-center justify-content-center">
                        <img src="{% static 'img/report-icon2.svg' %}" class="not-selected" alt="" width="35">
                        <img src="{% static 'img/report-icon2-active.svg' %}" class="selected" alt="" width="35">
                    </div>
                </label>
                <p class="my-1 text-center">{% trans 'Patient Format' %}</p>
            </div>
        </div>
        <p class="fs-6 mb-1">{% trans '2. Information to Display' %}</p>
        <p class="text-muted">{% trans 'Select the information you want to displayed in the report' %}</p>
        <div class="d-flex align-items-start mt-1 mb-2">

            <input {% if doctor_choices_dict.patient_infos %} checked {% endif %} type="checkbox" name="report-modal-checkbox" id="report-ch-1" class="me-2">
            <label class="input-text d-flex flex-column m-0" for="report-ch-1">
                <p class="fw-bold m-0">{% trans 'Patient Informations' %}</p>
                <p class="m-0 text-muted">{% trans 'Include patient information in the report' %}</p>
            </label>
        </div>
        <div class="d-flex align-items-start mt-1 mb-2">
            <input {% if doctor_choices_dict.undrawed_radiography %} checked {% endif %} type="checkbox" name="report-modal-checkbox" id="report-ch-2" class="me-2">
            <label class="input-text d-flex flex-column m-0" for="report-ch-2">
                <p class="fw-bold m-0">{% trans 'Radiography' %}</p>
                <p class="m-0 text-muted">{% trans 'Include radiography information in the report' %}</p>
            </label>
        </div>
        <div class="d-flex align-items-start mt-1 mb-2">
    <input {% if doctor_choices_dict.drawed_radiography %} checked {% endif %} type="checkbox" name="report-modal-checkbox" id="report-ch-3" class="me-2">
    <label class="input-text d-flex flex-column m-0" for="report-ch-3">
        <p class="fw-bold m-0">{% trans 'Drawed Radiography' %}</p>
        <p class="m-0 text-muted">{% trans 'Include drawed radiography information in the report' %}</p>
    </label>
    </div>

    <div id="additional-options" style="margin-left:40px; {% if doctor_choices_dict.drawed_radiography %} display: block; {% else %} display: none; {% endif %}">
        {% if not doctor_choices_dict.selected_drawed_radiography and not doctor_choices_dict.all_drawed_radiography %}
        <div class="d-flex align-items-start mt-1 mb-2">
            <input type="radio" name="additional-option" id="additional-ch-1" class="me-2">
            <label class="input-text d-flex flex-column m-0" for="additional-ch-1">
                <p class="fw-bold m-0">{% trans 'Draw the Diseases I chose' %}</p>
            </label>
        </div>
        <div class="d-flex align-items-start mt-1 mb-2">
            <input type="radio" name="additional-option" id="additional-ch-2" class="me-2" checked>
            <label class="input-text d-flex flex-column m-0" for="additional-ch-2">
                <p class="fw-bold m-0">{% trans 'Draw all Diseases' %}</p>
            </label>
        </div>
        {% else %}
        <div class="d-flex align-items-start mt-1 mb-2">
            <input type="radio" name="additional-option" id="additional-ch-1" class="me-2" {% if doctor_choices_dict.selected_drawed_radiography %} checked {% endif %}>
            <label class="input-text d-flex flex-column m-0" for="additional-ch-1">
                <p class="fw-bold m-0">{% trans 'Draw the Diseases I chose' %}</p>
            </label>
        </div>
        <div class="d-flex align-items-start mt-1 mb-2">
            <input type="radio" name="additional-option" id="additional-ch-2" class="me-2" {% if doctor_choices_dict.all_drawed_radiography %} checked {% endif %}>
            <label class="input-text d-flex flex-column m-0" for="additional-ch-2">
                <p class="fw-bold m-0">{% trans 'Draw all Diseases' %}</p>
            </label>
        </div>
        {% endif %}
        <div class="d-flex align-items-start mt-1 mb-2">
            <input type="checkbox" name="additional-option" id="additional-ch-3" class="me-2" {% if doctor_choices_dict.draw_numbering %} checked {% endif %}>
            <label class="input-text d-flex flex-column m-0" for="additional-ch-3">
                <p class="fw-bold m-0">{% trans 'Draw Teeth Numbering' %}</p>
            </label>
        </div>

    </div>
        <div class="d-flex align-items-start mt-1 mb-2">
            <input {% if doctor_choices_dict.doctor_note %} checked {% endif %} type="checkbox" name="report-modal-checkbox" id="report-ch-4" class="me-2">
            <label class="input-text d-flex flex-column m-0" for="report-ch-4">
                <p class="fw-bold m-0">{% trans 'Doctor Note' %}</p>
                <p class="m-0 text-muted">{% trans 'Include doctor note in the report' %}</p>
            </label>
        </div>
        <div class="d-flex align-items-start mt-1 mb-2">
            <input {% if doctor_choices_dict.treatment_plannings %} checked {% endif %} type="checkbox" name="report-modal-checkbox" id="report-ch-5" class="me-2">
            <label class="input-text d-flex flex-column m-0" for="report-ch-5">
                <p class="fw-bold m-0">{% trans 'Treatment Plannigs' %}</p>
                <p class="m-0 text-muted">{% trans 'Include treatment plannings in the report' %}</p>
            </label>
        </div>
        <div class="d-flex align-items-start mt-1 mb-2">
            <input {% if doctor_choices_dict.doctor_signature %} checked {% endif %} type="checkbox" name="report-modal-checkbox" id="report-ch-6" class="me-2">
            <label class="input-text d-flex flex-column m-0" for="report-ch-6">
                <p class="fw-bold m-0">{% trans 'Doctor Signature' %}</p>
                <p class="m-0 text-muted">{% trans 'Include doctor signature in the report' %}</p>
            </label>
        </div>
        <p class="fs-6 mb-1">{% trans '3. Choose Your Report Filter' %}</p>
        <p class="text-muted">{% trans 'Choose on what basis your report will be based' %}</p>
        <div class="d-flex" style="gap: 20px">

            <div class="report-radio-container">
                <input checked type="radio" name="report-data" data-type="reporting-custom-radio-input" value="TOOTH" id="tooth-based-input">
                <label for="tooth-based-input" class="m-0">
                    <div class="icon-container d-flex align-items-center justify-content-center">
                        <img src="{% static 'img/report-icon5.svg' %}" class="not-selected" alt="" width="35">
                        <img src="{% static 'img/report-icon5-active.svg' %}" class="selected" alt="" width="35">
                    </div>
                </label>
                <p class="my-1 text-center">{% trans 'Tooth Based' %}</p>
            </div>
        </div>
        <div class="d-flex justify-content-between">
            <label for="report-save-choice" class="d-flex align-items-center">
                <input type="checkbox" name="report-save-choices" id="report-save-choice" class="me-2">
                {% trans 'Save my choices' %}
            </label>
            <div class="modal-container__buttons ms-5 me-2">
                <button class="custom no" data-modal-close>{% trans 'Cancel' %}</button>
            </div>
            <div class="modal-container__buttons">
                <button id="createReport" class="custom yes" data-modal-close>{% trans 'Report' %}</button>
            </div>
        </div>

    </div>
</div>
<div id="delete-illness-from-tooth" class="modal-container">
    <div class="modal-box">
        <div class="modal-box__close">
            <div class="close-icon" data-modal-close>
                <i class="fa-solid fa-xmark"></i>
            </div>
        </div>
        <div class="modal-big-icon">
            <i class="fa-regular fa-trash-can shadow"></i>
        </div>
        <p class="main-text w-75 mx-auto text-center">{% trans 'Are you sure you want to delete illness from tooth?' %}</p>
        <div class="modal-container__buttons d-flex justify-content-center">
            <button class="custom yes" data-modal-close data-delete-illness-btn>{% trans 'Yes' %}</button>
            <button class="custom no" data-modal-close>{% trans 'No' %}</button>
        </div>
    </div>
</div>
<div id="delete-treatment-from-tooth" class="modal-container">
    <div class="modal-box">
        <div class="modal-box__close">
            <div class="close-icon" data-modal-close>
                <i class="fa-solid fa-xmark"></i>
            </div>
        </div>
        <div class="modal-big-icon">
            <i class="fa-regular fa-trash-can shadow"></i>
        </div>
        <p class="main-text w-75 mx-auto text-center">{% trans 'Are you sure you want to delete treatment from tooth?' %}</p>
        <div class="modal-container__buttons d-flex justify-content-center">
            <button class="custom yes" data-modal-close data-delete-treatment-btn>{% trans 'Yes' %}</button>
            <button class="custom no" data-modal-close>{% trans 'No' %}</button>
        </div>
    </div>
</div>
<div class="map-hover-popup__root"></div>
<div class="flex-column map-hover-popup single">
    <div class="item d-flex justify-content-between align-items-center">
        <i class="fa-solid fa-tooth me-2" style="color:#0dcaf0"></i>
        <strong>
            <span class="illness-name-span">Bone Loss </span>
            <span class="text-primary illness-proba-span" style="color: #0dcaf0 !important">(33%)</span>
        </strong>
        <span class="ms-4">
            <i class="fa-solid fa-thumbs-up me-2 like" id="single_map_like"></i>
            <i class="fa-solid fa-thumbs-down unlike" id="single_map_unlike"></i>
        </span>
        <span class="ms-2">
            <i class="fa fa-times-circle delete" id="single_map_delete" aria-hidden="true"></i>
        </span>
    </div>
</div>
<!-- <div class="flex-column map-hover-popup doctor-draw">
    <div class="item d-flex justify-content-between align-items-center">
        <i class="fa-solid fa-tooth me-2" style="color:#0dcaf0"></i>
        <strong><span class="illness-name-doctor">Bone Loss </span></strong>
        <i class="fa-solid fa-xmark ms-2 text-light" data-close-doctor-draw style="cursor: pointer;"></i>
    </div>
</div> -->
<div class="flex-column map-hover-popup multiple">
    <div class="tooth-name mb-2">
        <i class="fa-solid fa-tooth text-primary"></i>
        Tooth 45
    </div>
    <div id="multiple-card-body">
    </div>
</div>
<div id="modal-add-diagnosis" class="modal-container">
    <div class="modal-box px-4 d-flex flex-column text-light" style="min-width: 350px; height: auto; max-height: 100vh; max-width: 100vw; background-color: #1A264E;">
        <div class="modal-box__close">
            <div class="close-icon" data-modal-close>
                <i class="fa-solid fa-xmark"></i>
            </div>
        </div>
        <p class="my-2" style="font-size: 22px;">{% trans 'Add Diagnosis' %}</p>
        <input type="text" class="search-input w-100 py-3" style="color:#fff!important" placeholder="{% trans 'Search' %}" oninput="liveSearchingForAddDiagnosis(event)">
        <div style="overflow: auto; height: 300px;" class="my-4 add-diagnosis-patient-container">
            <div class="not-found-current-patient text-muted"></div>
            {% for key, value in illness_dict.items %}

            <div class="patient-item px-2 mb-2 rounded align-items-center" style="background-color: #2B3863; display: flex;">
                <div class="checkbox d-flex">
                    <input type="checkbox" name="AddDiagnosis"  id="{{key}}">
                    <i class="fa-solid fa-check"></i>
                </div>
                {% if '/uz/' in request.path %}
                    <label class="w-100 py-2 ps-2 m-0 patient-text" for="{{key}}" style="user-select: none">{{value.uz_disease_name}}</label>
                {% elif '/en/' in request.path %}
                    <label class="w-100 py-2 ps-2 m-0 patient-text" for="{{key}}" style="user-select: none">{{value.en_disease_name}}</label>
                {% elif '/ru/' in request.path %}
                    <label class="w-100 py-2 ps-2 m-0 patient-text" for="{{key}}" style="user-select: none">{{value.ru_disease_name}}</label>
                {% elif '/nl/' in request.path %}
                    <label class="w-100 py-2 ps-2 m-0 patient-text" for="{{key}}" style="user-select: none">{{value.nl_disease_name}}</label>
                {% else %}
                    <label class="w-100 py-2 ps-2 m-0 patient-text" for="{{key}}" style="user-select: none">{{value.tr_disease_name}}</label>
                {% endif %}
            </div>
            {% endfor %}
        </div>
        <button class="save-diagnosis custom btn-blue">{% trans 'Add Diagnosis' %}</button>
    </div>

</div>
<div id="modal-add-treatment" class="modal-container">
    <div class="modal-box px-4 d-flex flex-column text-light" style="min-width: 350px; height: auto; max-height: 100vh; max-width: 100vw; background-color: #1A264E;">
        <div class="modal-box__close">
            <div class="close-icon" data-modal-close>
                <i class="fa-solid fa-xmark"></i>
            </div>
        </div>
        <p class="my-2" style="font-size: 22px;">{% trans 'Add Treatment' %}</p>
        <input type="text" class="search-input w-100 py-3" placeholder="{% trans 'Search' %}" oninput="liveSearchingForAddDiagnosis(event)">
        <div style="overflow: auto; height: 300px;" id="modalAddTreatment" class="my-4 add-diagnosis-patient-container">
            <div class="not-found-current-patient text-muted"></div>
        </div>
        <button id="saveTreatment" class="save-treatment custom btn-blue">{% trans 'Add Treatment' %}</button>
    </div>
</div>
<div id="modal-radyografy-upload" class="modal-container">
    <div class="modal-box px-4 d-flex flex-column text-light" style="min-width: 350px; height: auto; max-height: 100vh; max-width: 100vw; background-color: #1A264E;">
        <div class="modal-box__close">
            <div class="close-icon" data-modal-close>
                <i class="fa-solid fa-xmark"></i>
            </div>
        </div>
        <p class="my-2" style="font-size: 22px;">{% trans 'Add Radiography' %}</p>
        <select name="radiography_types" id="radiography_types">
            <option value="" selected>{% trans 'Select Radiography Type...' %}</option>
            {% for type_id, type_name in image_type_dict.items %}
                
                <!--<option {% if type_name == "CBCT" %} style="background-color: grey; color:white;" disabled {% endif %} value="{{type_id}}">{%if 'Lateral Cephalometric' in type_name %}{{type_name}} (BETA){%else%}{{type_name}}{%endif%}</option>-->
                <option value="{{type_id}}">{%if 'Lateral Cephalometric' in type_name %}{{type_name}} (BETA) {%elif 'CBCT' in type_name%}{{type_name}} (BETA) {%else%}{{type_name}}{%endif%}</option>
            {% endfor %}
        </select>
        <!-- <div id="dropZone" class="d-none">
            <form action="{% url 'upload_radyografi' %}" class="dropzone" id="my-great-dropzone"></form>
        </div> -->
        <div id="uploadFilepond" class="px-2">
            <div class="custom-filepond-container">
                <input type="file" id="filepond" accept=".png">
                <div id="previewFilePond"></div>
                </div>
        </div>
        <form enctype='multipart/form-data' method="post" class="dropzone dz my-0 d-none" id="dicomDropzone" style="margin: 10px;">
            {% csrf_token %}
            <div class="fallback">
                <input name="file" type="file" multiple class="bg-primary">
            </div>
            <div class="dz-message needsclick"></div>
            <div class="dz-default dz-message text-light my-0" style="pointer-events: none">
                <i class="fa-solid fa-upload border" style="border-radius: 50%; padding: 10px;"></i>
                <p class="m-0 my-2">{% trans 'Drag and drop files or select files' %}</p>
                <p class="m-0">DCM</p>
            </div>
        </form>
        <div id="cbtcContainer" class="mt-3 mb-4" style="display: none;">
            a.r.k will insert content
        </div>
        <button id="filepondUploadButton" class="custom btn-blue my-2">{% trans 'Start Upload' %}</button>
        <button id="CBCTUpload" class="custom btn-blue my-2 d-none">{% trans 'CBCT Upload' %}</button>
        <div id="progress" style="display: none; width: 100%; background-color: #f0f0f0; border-radius: 4px;" class="custom btn-blue mb-2">
            <div id="progressBar" style="width: 0;height: 20px;background-color: #5071C8;border-radius: 4px;">
                <div id="progressText" style="text-align: right; line-height: 20px; color: black; padding-right:5px;"></div>
            </div>
        </div>
        <button id="close-upload-modal" class="save-treatment custom no" data-modal-close>{% trans 'Cancel' %}</button>
        <button id="open-new-tab" class="d-none custom no" data-open-new-page="/">{% trans 'Open in New Tab' %}</button>
    </div>
</div>
<div id="deleteCrownImage" class="modal-container" data-crown-id="">
    <div class="modal-box px-4 d-flex flex-column" style="min-width: 350px; height: auto; max-height: 100vh; max-width: 100vw;;">
        <div class="modal-box__close">
            <div class="close-icon" data-modal-close>
                <i class="fa-solid fa-xmark"></i>
            </div>
        </div>
        <p class="my-3 text-center" style="font-size: 16px;">{% trans 'Are you sure you want to remove crown?' %}</p>
        <div class="d-flex align-items-center justify-content-end gap-2">
            <button class="custom btn-blue" data-modal-close="yes">{% trans 'Delete' %}</button>
            <button class="custom" data-modal-close>{% trans 'Cancel' %}</button>
        </div>
    </div>
</div>
<main class="d-flex">
    <div class="container-fluid">
        <div class="adjustable-content py-1" style="overflow: hidden;">
            <div class="row h-100 g-0">
                <div class="h-100 diagnosis-content-wrapper" style="max-width:348px;transition: all ease-in-out 500ms;">
                  
                    <div class="diagnosis-content h-100 px-3 py-4 me-2" style="transition: all ease-in-out 500ms;">
                        <div  class="collapse-for-diagnosis-area icon diagnosis_expand_btn" data-event-type="collapse-section-diagnosis-list">
                            <i style="color:grey" class="collapse-icon fa-solid fa-angles-left translate" style="font-size: 16px;"></i>
                        </div>
                        <div class="diagnosis-content-area">
                            <div class="d-flex align-items-center mb-2" style="justify-content:space-between; align-items:self-end">
                                <p style="font-size: 15px; font-weight: 500; margin:0">Diagnosis</p>
                                
                            </div>
                            
                            <div class="mb-3">
                                <input type="text" class="search-input ms-auto" placeholder="{% trans 'Search' %}"
                                    oninput="liveSearchingForDiagnosis(event)" id="search-diagnosis">
                            </div>
                            <div class="warning-message" style="display: none;">
                                <p class="not-found-messeage m-0 p-1 text-center text-muted"></p>
                            </div>
                            <div class="tree-view">
                                <div class="parent-view">
                                    <div class="title grouped-diagnoses-dark d-flex gap-2">
                                        <div id="drawTeethContainer" class="py-1 grouped-diagnoses-dark d-flex align-items-center" style="
                                        gap: 4px;
                                        padding: 5px 10px;
                                        border-radius: 6px;
                                        ">
                                        <div class="checkbox">
                                            <input type="checkbox" name="" id="drawTeethBoxesDraw">
                                            <i class="fa-solid fa-check"></i>
                                        </div>
                                        <label for="drawTeethBoxesDraw">{% trans 'Show Teeth Numbering' %}</label>
                                    </div>
                                </div>
                            </div>
                                {% for label_type, main_labels in diagnosis_section.labels.items %}
                                
                                    <div class="parent-view">
                                        <div class="title grouped-diagnoses-dark d-flex gap-2">
                                            <img src="{% static 'img/arrow-bottom-icon.svg' %}" width="14" alt="" class="block-icon" style="cursor: pointer;">
                                            <div class="checkbox">
                                                <input type="checkbox" name="" checked>
                                                <i class="fa-solid fa-check"></i>
                                            </div>
                                            <label for="{{main_label}}">{{label_type}}</label>
                                        </div>
                            
                                        <div class="child-view items">
                                            {% for main_label, sub_and_data in main_labels.illness.items %}
                                                <div class="title d-flex grouped-diagnoses-dark justify-content-between">
                                                    <div class="d-flex justify-content-start align-items-center gap-2">
                            
                                                        {% if sub_and_data.label_dict %}
                                                            <img src="{% static 'img/arrow-bottom-icon.svg' %}" width="14" alt="" class="block-icon" style="cursor: pointer;">
                                                        {% else %}
                                                            <i class="fa-solid fa-circle section-dot" style="color: white; font-size: 8px; margin-right: 1px; margin-left: 4px;"></i>
                                                        {% endif %}
                            
                                                        <div class="checkbox">
                                                            <input type="checkbox" name="" id="{{main_label}}" checked>
                                                            <i class="fa-solid fa-check"></i>
                                                        </div>
                                                        <label data-parameter-for-slider = "{{main_label}}" class="label-element" for="{{main_label}}" title="{{main_label}}" data-disease-name="{{main_label}}">{{main_label}}</label>
                                                    </div>
                            
                                                    <div class="d-flex justify-content-center align-items-center gap-2">
                                                        {% if not sub_and_data.label_dict %}
                                                            <div class="d-flex justify-content-end">
                                                                <div class="d-flex justify-content-center align-items-center rounded" style="width: 16px; height: 16px; background-color: rgb(11, 224, 231); color: #303030 !important;">{{sub_and_data.count}}</div>
                                                            </div>
                                                            {% comment %} oninput="changeOpacityForDiagnosisPage(event, `.pointer[data-id='{{forloop.counter}}']`)" {% endcomment %}
                                                            <div class="slider">
                                                                
                                                                <input type="range" name="" id="" min="0" max="1" step="0.1"
                                                                    data-id="{{ forloop.counter }}"
                                                                    data-illness-name="{{main_label}}" style="">
                                                                <div class="transparent-img"></div>
                                                                <div class="gradient" data-id="{{ forloop.counter }}" style="background: linear-gradient(90deg, rgba(0, 0, 0, 0) 0%, {{sub_and_data.main_label_data.color}} 100%);"></div>
                                                                <div class="pointer-container">
                                                                    <div class="pointer" data-id="{{ forloop.counter }}" style="background-color: {{sub_and_data.main_label_data.color}};"></div>
                                                                </div>
                                                            </div>
                                                            <div class="color pt-1" data-id="{{ forloop.counter }}">
                                                                <input class="rounded" type="color" value="{{sub_and_data.main_label_data.color}}" name=""
                                                                    oninput="changeColorForDiagnosisPage(event, {{ forloop.counter }})"
                                                                    data-illness-name="{{main_label}}">
                                                            </div>
                                                        {% endif %}
                                                    </div>
                                                </div>
                                                <div class="child-view">
                                                    {% for sub_label, sub_label_data in sub_and_data.label_dict.items %}
                                                        <div class="title d-flex justify-content-between">
                                                            <div class="d-flex justify-content-start align-items-center gap-2">
                                                                <div class="checkbox">
                                                                    <input type="checkbox" name="" id="{{sub_label}}" checked>
                                                                    <i class="fa-solid fa-check"></i>
                                                                </div>
                                                                <label data-parameter-for-slider = "{{sub_label}}" class="label-element" for="{{sub_label}}" title="{{sub_label}}" data-disease-name="{{sub_label}}">{{sub_label}}</label>
                                                                </div>
                                                                
                                                                <div class="d-flex justify-content-center align-items-center gap-2">
                                                                    <div class="d-flex justify-content-end">
                                                                        <div class="d-flex justify-content-center align-items-center rounded" style="width: 16px; height: 16px; background-color: rgb(11, 224, 231); color: #303030 !important;">{{sub_label_data.count}}</div>
                                                                    </div>
                                                                    {% comment %} oninput="changeOpacityForDiagnosisPage(event, `.pointer[data-id='{{forloop.counter}}']`)" {% endcomment %}
                                                                    <div class="slider">
                                                                        {% if '/nl/' in request.path %}
                                                                        <input type="range" name="" id="" min="0" max="1" step="0.1"
                                                                            data-id="{{ forloop.counter }}"
                                                                            data-illness-name="{{sub_label_data.nl_name}}" style="">
                                                                        {% elif '/uz/' in request.path %}
                                                                        <input type="range" name="" id="" min="0" max="1" step="0.1"
                                                                            data-id="{{ forloop.counter }}"
                                                                            data-illness-name="{{sub_label_data.uz_name}}" style="">
                                                                        {% elif '/ru/' in request.path %}
                                                                        <input type="range" name="" id="" min="0" max="1" step="0.1"
                                                                            data-id="{{ forloop.counter }}"
                                                                            data-illness-name="{{sub_label_data.ru_name}}" style="">
                                                                        {% elif '/tr/' in request.path %}
                                                                        <input type="range" name="" id="" min="0" max="1" step="0.1"
                                                                            data-id="{{ forloop.counter }}"
                                                                            data-illness-name="{{sub_label_data.tr_name}}" style="">
                                                                        {% else %}
                                                                        <input type="range" name="" id="" min="0" max="1" step="0.1"
                                                                            data-id="{{ forloop.counter }}"
                                                                            data-illness-name="{{sub_label}}" style="">
                                                                        {% endif %}
                                                                        <div class="transparent-img"></div>
                                                                        <div class="gradient" data-id="{{ forloop.counter }}" style="background: linear-gradient(90deg, rgba(0, 0, 0, 0) 0%, {{sub_label_data.color}} 100%);"></div>
                                                                        <div class="pointer-container">
                                                                            <div class="pointer" data-id="{{ forloop.counter }}" style="background-color: {{sub_label_data.color}};"></div>
                                                                        </div>
                                                                    </div>
                                                                    <div class="color pt-1" data-id="{{ forloop.counter }}">
                                                                        <input class="rounded" type="color" value="{{sub_label_data.color}}" name=""
                                                                            oninput="changeColorForDiagnosisPage(event, {{ forloop.counter }})"
                                                                            data-illness-name="{{sub_label}}">
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        {% endfor %}
                                                    </div>                                    
                                                {% endfor %}
                                            </div>
                                        </div>
                                    {% endfor %}
                                </div>
                            
                        </div>
                            
                        
                </div>
            </div>
           
                <div id="parent-back-img-frame" class="d-flex align-items-center" style="flex: 4; overflow: hidden">
                    <div id="back-img-frame" class="patient-radiography d-flex align-items-start justify-content-center" style="overflow: hidden; transform-origin: 0px 0px; background: transparent;">
                        {% if "media/dental/radio/" in radiography_section.image_path|safe %}
                            <img class="mb-2" id="back-img" src="{{radiography_section.image_path}}"
                            style="{% if image_type == 'Periapical'%}max-width:970px; max-height:791px;{%endif%}width: 100%; z-index: 9; margin: 0 !important; padding: 0 !important;">
                        {% else %}
                            <img class="mb-2" id="back-img" src="https://aiv2.craniocatch.com/media/{{radiography_section.image_path}}"
                             style="width: 100%; z-index: 9; margin: 0 !important; padding: 0 !important;">
                        {% endif %}

                        <div class="loading d-none d-flex align-items-center justify-content-center position-absolute" style="inset: 0; z-index: 999;">
                            <i class="fa-solid fa-spinner fs-1"></i>
                            <div id="continues" class="d-none">
                                <span style="position: absolute;top: 60%;left: 50%;transform: translate(-50%, -50%);">Analiz Devam Ediyor...</span>
                            </div>
                        </div>
                    </div>
                    <div id="measurement"></div>
                </div>
            <div id="mini-icon-bar">
                    <div class="icon" data-event-type="collapse-section">
                        <i class="fa-solid fa-angles-left translate" style="font-size: 16px;"></i>
                    </div>
                    <div class="icon" id="zoomin-btn" data-bs-toggle="tooltip" data-bs-placement="top" title="{% trans 'Zoom In' %}">
                        <i class="fa-solid fa-magnifying-glass-plus translate" style="font-size: 16px;"></i>
                    </div>
                    <div class="icon" id="zoomout-btn" data-bs-toggle="tooltip" data-bs-placement="top" title="{% trans 'Zoom Out' %}">
                        <i class="fa-solid fa-magnifying-glass-minus translate" style="font-size: 16px;"></i>
                    </div>
                    <div class="icon" id="reset-btn"  data-bs-toggle="tooltip" data-bs-placement="top" title="{% trans 'Reset' %}">
                        <i class="fa-solid fa-rotate-right translate" style="font-size: 16px;"></i>
                    </div>
                    <div class="icon">
                        <i class="fa-solid fa-sun translate" style="font-size: 16px;"></i>
                        <div class="dropdown-section flex-column align-items-stretch justify-content-between">
                            <div class="d-flex justify-content-between dropdown-section-item">
                                <span>
                                    <i class="fa-solid fa-sun" style="font-size: 16px;"></i>
                                    <span class="text" style="white-space: nowrap;">{% trans 'Brightness Level' %}</span>
                                </span>
                                <span class="text" id="brightness-value">+ 100</span>
                            </div>
                            <div class="dropdown-section-item range-container brightness">
                                <input type="range" name="" min="0" max="300" id="brightness-btn" value="100">
                                <div class="range-bg"></div>
                                <div class="range-value" style="width: 33.3%;"></div>
                                <div class="range-marker shadow" style="left: 33.3%;"></div>
                            </div>
                        </div>
                    </div>
                    <div class="icon">
                        <i class="fa-solid fa-circle-half-stroke translate" style="font-size: 16px;"></i>
                        <div class="dropdown-section flex-column align-items-stretch justify-content-between">
                            <div class="d-flex justify-content-between dropdown-section-item">
                                <span>
                                    <i class="fa-solid fa-circle-half-stroke" style="font-size: 16px;"></i>
                                    <span class="text" style="white-space: nowrap;">{% trans 'Contrast Level' %}</span>
                                </span>
                                <span class="text" id="contrast-value">+ 100</span>
                            </div>
                            <div class="dropdown-section-item range-container contrast">
                                <input type="range" name="" min="0" max="500" value="100" id="contrast-btn">
                                <div class="range-bg"></div>
                                <div class="range-value" style="width: 20%;"></div>
                                <div class="range-marker shadow" style="left: 20%;"></div>
                            </div>
                        </div>
                    </div>
                    <div class="icon" id="implantCrownDropdown">
                        <img src="{% static 'img/implant-img.png' %}" alt="" width="10">
                        <div class="dropdown-section flex-column gap-1 py-2" style="height: auto; top: -2px;">
                            <div class="d-flex align-items-stretch justify-content-between">
                                <div class="close-section">
                                    <i class="fa-solid fa-xmark"></i>
                                </div>
                                <div class="draw-icon-item d-flex align-items-center justify-content-center me-2" data-put-icon-type="implant">
                                    <img src="{% static 'img/moving.png' %}" alt="" class="moving-img">
                                    <img src="{% static 'img/implant-img.png' %}" height="35" alt="" class="p-2" id="draw-implant" data-bs-toggle="tooltip" data-bs-placement="bottom" title="{% trans 'Add Implant' %}">
                                </div>
                                <div class="draw-icon-item d-flex align-items-center justify-content-center" data-put-icon-type="crown">
                                    <img src="{% static 'img/moving.png' %}" alt="" class="moving-img">
                                    <img src="{% static 'img/crown-img.png' %}" width="40" alt="" class="p-2" id="draw-crown" data-bs-toggle="tooltip" data-bs-placement="bottom" title="{% trans 'Add Crown' %}">
                                    <div class="tooth-menu-container">
                                        <div class="item draw-crown-img top-align">
                                            <img src="{% static 'img/crown-teeth/crown-17.png' %}" alt="" class="img-fluid">
                                        </div>
                                       <div class="item draw-crown-img top-align">
                                            <img src="{% static 'img/crown-teeth/crown-15.png' %}" alt="" class="img-fluid">
                                        </div>
                                       <div class="item draw-crown-img top-align">
                                            <img src="{% static 'img/crown-teeth/crown-13.png' %}" alt="" class="img-fluid">
                                        </div>
                                       <div class="item draw-crown-img top-align">
                                            <img src="{% static 'img/crown-teeth/crown-11.png' %}" alt="" class="img-fluid">
                                        </div>
                                       <div class="item draw-crown-img top-align">
                                            <img src="{% static 'img/crown-teeth/crown-21.png' %}" alt="" class="img-fluid">
                                        </div>
                                       <div class="item draw-crown-img top-align">
                                            <img src="{% static 'img/crown-teeth/crown-23.png' %}" alt="" class="img-fluid">
                                        </div>
                                       <div class="item draw-crown-img top-align">
                                            <img src="{% static 'img/crown-teeth/crown-25.png' %}" alt="" class="img-fluid">
                                        </div>
                                       <div class="item draw-crown-img top-align">
                                            <img src="{% static 'img/crown-teeth/crown-27.png' %}" alt="" class="img-fluid">
                                        </div>
                                        <div class="item draw-crown-img">
                                            <img src="{% static 'img/crown-teeth/crown-47.png' %}" alt="" class="img-fluid">
                                        </div>
                                        <div class="item draw-crown-img">
                                            <img src="{% static 'img/crown-teeth/crown-45.png' %}" alt="" class="img-fluid">
                                        </div>
                                        <div class="item draw-crown-img">
                                            <img src="{% static 'img/crown-teeth/crown-43.png' %}" alt="" class="img-fluid">
                                        </div>
                                        <div class="item draw-crown-img">
                                            <img src="{% static 'img/crown-teeth/crown-41.png' %}" alt="" class="img-fluid">
                                        </div>
                                        <div class="item draw-crown-img">
                                            <img src="{% static 'img/crown-teeth/crown-31.png' %}" alt="" class="img-fluid">
                                        </div>
                                        <div class="item draw-crown-img">
                                            <img src="{% static 'img/crown-teeth/crown-33.png' %}" alt="" class="img-fluid">
                                        </div>
                                        <div class="item draw-crown-img">
                                            <img src="{% static 'img/crown-teeth/crown-35.png' %}" alt="" class="img-fluid">
                                        </div>
                                        <div class="item draw-crown-img">
                                            <img src="{% static 'img/crown-teeth/crown-37.png' %}" alt="" class="img-fluid">
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div>
                                <div class="d-flex align-items-center gap-3 justify-content-between">
                                    <label for="" style="min-width: 75px;">{% trans 'Dimension' %}</label>
                                    <div class="dropdown-section-item range-container">
                                        <input type="range" name="" min="20" max="300" id="dimension-btn" value="100">
                                        <div class="range-bg"></div>
                                        <div class="range-value" style="width: 33.3%;"></div>
                                        <div class="range-marker shadow" style="left: 33.3%;"></div>
                                    </div>
                                    <span id="dimensionValue" style="min-width: 25px;">100</span>
                                </div>
                                <div class="d-flex align-items-center gap-3 justify-content-between">
                                    <label for="" style="min-width: 75px;">{% trans 'Rotate Value' %}</label>
                                    <div class="dropdown-section-item range-container">
                                        <input type="range" name="" min="0" max="360" id="rotate-implant-btn" value="0">
                                        <div class="range-bg"></div>
                                        <div class="range-value" style="width: 0;"></div>
                                        <div class="range-marker shadow" style="left: 0;"></div>
                                    </div>
                                    <span id="rotateImplantValue" style="min-width: 25px;">0</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="icon" id="pencilke">
                        <i class="fa-solid fa-pen translate" style="font-size: 16px;"></i>
                        <div class="dropdown-section align-items-stretch justify-content-between">
                            <div class="draw-icon-item d-flex align-items-center me-2">
                                <img src="{% static 'img/polygon.png' %}" alt="" class="p-2" id="draw-polygon" data-bs-toggle="tooltip" data-bs-placement="top" title="{% trans 'Make Markup' %}">
                            </div>
                            <div class="draw-icon-item d-flex align-items-center">
                                <img src="{% static 'img/rectangle.png' %}" alt="" class="p-2" id="draw-rectangle" data-bs-toggle="tooltip" data-bs-placement="top" title="{% trans 'Add Diagnosis' %}">
                            </div>
                            <div class="draw-icon-item"></div>
                        </div>
                    </div>
                    <div class="icon" id="download-btn" data-bs-toggle="tooltip" data-bs-placement="top" title="{% trans 'Download' %}">
                        <i class="fa-solid fa-download translate" style="font-size: 16px;"></i>
                    </div>
                    <div class="icon" id="reset-btn">
                        <i class="fa-solid fa-eye translate" style="font-size: 16px;"></i>
                        <div class="dropdown-section align-items-stretch justify-content-between" style="height: 100px; top : -2px;">
                            <span id="back-value" class="pe-none position-absolute top-50 translate-middle-y"></span>
                            <span id="background-base" class="pe-none position-absolute top-50 translate-middle-y"></span>
                            <div class="position-absolute h-100" style="width: 240px">
                                <span id="triangele-back" class="position-absolute"></span>
                            </div>
                            <div class="position-absolute h-100" style="width: 240px">
                                <span id="back-marked" class="pe-none position-absolute top-50"></span>
                            </div>
                            <div class="d-flex flex-column align-items-center justify-content-between position-relative p-2" style="width: 60px">
                                <input type="radio" name="weakstrongradio" id="" checked class="position-absolute weekstrong-checkbox" data-type="dentist" value="dentist">
                                <p class="m-0">{% trans 'Dentist' %}</p>
                                <p class="m-0 mt-4 px-2">{{filter_by_proba_dict.dentist.length}}</p>
                            </div>
                            <div class="d-flex flex-column align-items-center justify-content-between position-relative p-2" style="width: 60px">
                                <input type="radio" name="weakstrongradio" id="" class="position-absolute weekstrong-checkbox" data-type="strong" value="strong">
                                <p class="m-0">{% trans 'Strong' %}</p>
                                <p class="m-0 mt-4 px-2">{{filter_by_proba_dict.strong.length}}</p>
                            </div>
                            <div class="d-flex flex-column align-items-center justify-content-between position-relative p-2" style="width: 60px">
                                <input type="radio" name="weakstrongradio" id="" class="position-absolute weekstrong-checkbox" data-type="medium" value="medium">
                                <p class="m-0">{% trans 'Medium' %}</p>
                                <p class="m-0 mt-4 px-2">{{filter_by_proba_dict.medium.length}}</p>
                            </div>
                            <div class="d-flex flex-column align-items-center justify-content-between position-relative p-2" style="width: 60px">
                                <input type="radio" name="weakstrongradio" id="" class="position-absolute weekstrong-checkbox" data-type="weak" value="weak">
                                <p class="m-0">{% trans 'Weak' %}</p>
                                <p class="m-0 mt-4 px-2">{{filter_by_proba_dict.weak.length}}</p>
                            </div>
                        </div>
                    </div>
                    {% if iamge_type == "Bitewing" %}
                    <div class="icon" id="measure-btn" data-bs-toggle="tooltip" data-bs-placement="top" title="{% trans 'Measure' %}">
                        <i class="fa-solid fa-pen-ruler translate" style="font-size: 16px;"></i>
                    </div>
                    {% endif %}
                </div>
                <div class="h-100 teeth-and-treatment-section position-relative" style="transition: width ease-in-out 500ms;">
                    <div class="tooth-chart-illnesses-by-tooth px-2 py-3" style="position: relative; opacity: 0;">
                        <h3 class="heading d-flex">
                            <span>{% trans 'Tooth Chart' %}</span>
                            <div class="ms-auto me-2 doctor-comment">
                                {% if not doctor_note %}
                                    <i class="fa-regular fa-comment" style="cursor: pointer"></i>
                                {% else %}
                                <!-- NOTTTTTTT : eğerki içinde yorum varsa aşağıdaki ikon gözüksün yorum yoksa yukarıdaki -->
                                    <i class="fa-solid fa-comment" style="cursor: pointer"></i>
                                {% endif %}
                            </div>
                            <i class="fa-solid fa-eye-slash see-all-teeth-detail" data-eye="open"></i>
                        </h3>
                        <div class="position-relative overflow-hidden py-2">
                            <div id="doctor-comment-area" class="position-absolute bg-light d-flex flex-column p-2" style="width: 100%; height: 100%; overflow-y: auto; z-index: 99; top: -100%">
                                <p class="text-dark mb-1">{% trans 'Doctor Comment' %}</p>
                                <textarea name="" id="doctorNoteArea" rows="4" class="form-control" style="overflow-y: auto!important; font-size: 12px!important; flex:1;">{% if doctor_note %}{{doctor_note}}{%else%} {%endif%}</textarea>
                                <div class="py-2 d-flex justify-content-end" style="gap: 7px;">
                                    <button id="doctor-comment-save-btn" class="custom transparent blue-hover" style="color: #111;">
                                        <i class="fa-solid fa-floppy-disk"></i>
                                        {% trans 'Save' %}
                                    </button>
                                    <button id="doctor-comment-cancel-btn" class="custom transparent blue-hover" style="color: #111;">
                                        <i class="fa-solid fa-xmark"></i>
                                        {% trans 'Close' %}
                                    </button>
                                </div>
                            </div>
                            <div class="teeth child-1 {% if is_kid_status %}{% else %}d-none{% endif %}">
                                {% for tooth_number, value in tooth_chart_section.section_upper.items %}
                                    <div class="tooth" data-tooth="{{tooth_number}}">
                                        <div class="item">
                                            {% if value.current_icon == None %}
                                                <img src="" class="imgToChange" alt="">
                                            {% else %}
                                                <img src="{{value.current_icon.path}}" class="imgToChange" alt="" data-tooth-type="{{value.current_icon.name}}">
                                            {% endif %}
                                            <span class="tooth-cursor" onclick="toggleToothDiv({{tooth_number}})">{{tooth_number}}</span>
                                            <div class="pencil" onclick="toggleToothMenu({{tooth_number}})">
                                                <i style="font-size: 7px;" class="fa-solid fa-pencil tooth-edit"></i>
                                            </div>
                                            <div class="tooth-menu" data-tooth-menu="{{tooth_number}}">
                                                {% for other_icon in value.other_icons %}
                                                    <div data-icon-type="{{other_icon.name}}" onclick="changeToothType({{tooth_number}} ,'{{other_icon.path}}',this, '', '{{other_icon.name}}')">
                                                        <img src="{{other_icon.path}}" class="" alt="">
                                                    </div>
                                                {% endfor %}
                                                <div data-icon-type="None" onclick="changeToothType({{tooth_number}} , `{% static 'img/Vector.png' %}`,this, 'auto-height')">
                                                    <img src="{% static 'img/Vector.png' %}" class="auto-height" alt="">
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                {% endfor %}

                            </div>
                            <div class="teeth adult">
                                {% for tooth_number, value in tooth_chart_section.section_adult.items %}
                                    <div class="tooth" data-tooth="{{tooth_number}}">
                                        <div class="item">
                                            {% if value.current_icon == None %}
                                                <img src="{% static 'img/Vector.png' %}" class="imgToChange auto-height" alt="">
                                            {% else %}
                                                <img {% if value.current_icon.name == 'Pontic' and tooth_number < 30 %} class="mt-5" {% elif value.current_icon.name == 'Pontic' and tooth_number > 30 %}class="mb-5"{% endif %} src="{{value.current_icon.path}}" class="imgToChange" alt="" data-tooth-type="{{value.current_icon.name}}">
                                            {% endif %}
                                            <span class="tooth-cursor" onclick="toggleToothDiv({{tooth_number}})">{{tooth_number}}</span>
                                            <div class="pencil" onclick="toggleToothMenu({{tooth_number}})">
                                                <i style="font-size: 7px;" class="fa-solid fa-pencil tooth-edit"></i>
                                            </div>
                                            <div class="tooth-menu" data-tooth-menu="{{tooth_number}}">
                                                {% for other_icon in value.other_icons %}
                                                    <div class="d-flex align-items-center" data-icon-type="{{other_icon.name}}" onclick="changeToothType( '{{tooth_number}}' ,'{{other_icon.path}}', this, '', '{{other_icon.name}}' )">
                                                        <img src="{{other_icon.path}}" class="" alt="">
                                                    </div>
                                                {% endfor %}
                                                <div data-icon-type="None" onclick="changeToothType({{tooth_number}} ,`{% static 'img/Vector.png' %}`,this, 'auto-height')">
                                                    <img src="{% static 'img/Vector.png' %}" class="auto-height" alt="">
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                {% endfor %}

                            </div>
                            <div class="teeth child-2 {% if is_kid_status %}{% else %}d-none{% endif %}">
                                {% for tooth_number, value in tooth_chart_section.section_lower.items %}
                                    <div class="tooth" data-tooth="{{tooth_number}}">
                                        <div class="item">
                                            {% if value.current_icon == None %}
                                                <img src="" class="imgToChange" alt="">
                                            {% else %}
                                                <img src="{{value.current_icon.path}}" class="imgToChange" alt=""  data-tooth-type="{{value.current_icon.name}}">
                                            {% endif %}
                                            <span class="tooth-cursor" onclick="toggleToothDiv({{tooth_number}})">{{tooth_number}}</span>
                                            <div class="pencil" onclick="toggleToothMenu({{tooth_number}})">
                                                <i style="font-size: 7px;" class="fa-solid fa-pencil tooth-edit"></i>
                                            </div>
                                            <div class="tooth-menu" data-tooth-menu="{{tooth_number}}">
                                                {% for other_icon in value.other_icons %}
                                                    <div data-icon-type="{{other_icon.name}}" onclick="changeToothType({{tooth_number}} ,'{{other_icon.path}}',this, '', '{{other_icon.name}}')">
                                                        <img src="{{other_icon.path}}" class="img-fluid" alt="">
                                                    </div>
                                                {% endfor %}
                                                <div data-icon-type="None" onclick="changeToothType({{tooth_number}} ,`{% static 'img/Vector.png' %}`,this, 'auto-height')">
                                                    <img src="{% static 'img/Vector.png' %}" class="auto-height" alt="">
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                {% endfor %}
                            </div>
                        </div>
                            <div class="tooth-details">
                                {% for tooth_number, tooth_detail in tooth_cards_section.items %}
                                    <div class="tooth-detail" data-tooth-id="{{tooth_number}}" style="display: block">
                                        <div class="d-flex">
                                            <div class="left-content">
                                                <div class="d-flex">
                                                    <div class="tooth-img">
                                                        <img width="80" src="{% if 'static/img/teeth' in tooth_detail.path %} {{tooth_detail.path}} {% else %} {{tooth_detail.path}}{% endif %}" class="" alt="">
                                                    </div>
                                                    <div class="tooth-text">
                                                        <p  class="my-0">{% trans 'Tooth' %} {{tooth_number}}</p>
                                                        <div class="diseases">
                                                            {% for illness in tooth_detail.illness %}
                                                                {% if '/tr/' in request.path %}
                                                                    <span class="delete-illness-parent">{{illness.tr_name}} <span data-tooth-id="{{tooth_detail.id}}" data-open-modal-pk="delete-illness-from-tooth" data-delete-illness="{{illness.name}}" data-tooth-number-for-illness-delete="{{tooth_number}}" data-illness-slug="{{illness.slug}}" class="tooth-percent {% if illness.probability < 81 %}low{% elif illness.probability < 91 %}normal{% else %}high{% endif %}">{% if illness.probability == 101 %}(-){% else %} (%{{illness.probability}}) {% endif %}</span></span>
                                                                {% else %}
                                                                    <span class="delete-illness-parent">{{illness.name}} <span data-tooth-id="{{tooth_detail.id}}" data-open-modal-pk="delete-illness-from-tooth" data-delete-illness="{{illness.name}}" data-tooth-number-for-illness-delete="{{tooth_number}}" data-illness-slug="{{illness.slug}}" class="tooth-percent {% if illness.probability < 81 %}low{% elif illness.probability < 91 %}normal{% else %}high{% endif %}">{% if illness.probability == 101 %}(-){% else %} (%{{illness.probability}}) {% endif %}</span></span>
                                                                {% endif %}
                                                            {% endfor %}
    
                                                        </div>
                                                        <hr>
                                                        <div class="treatments treatmentForTooth">
                                                            {% for treatment_method in tooth_detail.treatment_methods %}
                                                                {% if '/tr/' in request.path %}
                                                                    <span data-delete-treatment-id="treatmentDeleteForTooth" style="cursor:pointer" data-open-modal-pk="delete-treatment-from-tooth" data-tooth-number-for-treatment-delete="{{tooth_number}}" data-tooth-id="{{tooth_detail.id}}" data-method-slug="{{ treatment_method.slug }}">{{ treatment_method.tr_name }} {% if not forloop.last %},{% endif %}</span>
                                                                {% else %}
                                                                    <span data-delete-treatment-id="treatmentDeleteForTooth" style="cursor:pointer" data-open-modal-pk="delete-treatment-from-tooth" data-tooth-number-for-treatment-delete="{{tooth_number}}" data-tooth-id="{{tooth_detail.id}}" data-method-slug="{{ treatment_method.slug }}">{{ treatment_method.en_name }} {% if not forloop.last %},{% endif %}</span>
                                                                {% endif %}
                                                            {% endfor %}
                                                        </div>
    
                                                    </div>
                                                </div>
                                                <div class="tw-btn">
                                                    <button id="add-diagnosis-btn" class="add-diagnosis custom transparent blue-hover text-light" data-open-modal-pk="modal-add-diagnosis" onclick="setDiagnosisId({{tooth_number}})">
                                                        <i class="fa-solid fa-plus" style="pointer-events: none"></i>
                                                        <span style="pointer-events: none">{% trans 'Add Diagnosis' %}</span>
                                                    </button>
                                                    <button class="custom transparent blue-hover text-light"  data-open-modal-pk="modal-add-treatment" onclick="setTreatmentId({{tooth_number}})">
                                                        <i style="pointer-events: none" class="fa-solid fa-plus"></i>
                                                        <span style="pointer-events: none">{% trans 'Add Treatments' %}</span>
                                                    </button>
                                                </div>
                                            </div>
                                            <div class="right-content">
                                                <div>
                                                    {% if tooth_detail.approved == "1" %}
                                                    <img style="cursor: pointer;" src="{% static 'img/like-active.png' %}" class="img-fluid" alt="like butonu" data-id="{{tooth_number}}" data-icon-status="1" data-approve-status="{{tooth_detail.approved}}" onclick="approve_status_change(event)">
                                                    <img style="cursor: pointer;" src="{% static 'img/dislike.png' %}" class="img-fluid" alt="dislike butonu" data-id="{{tooth_number}}" data-icon-status="2" data-approve-status="{{tooth_detail.approved}}" onclick="approve_status_change(event)">
                                                    {% elif tooth_detail.approved == "2" %}
                                                    <img style="cursor: pointer;" src="{% static 'img/like.png' %}" class="img-fluid" alt="like butonu" data-id="{{tooth_number}}" data-icon-status="1" data-approve-status="{{tooth_detail.approved}}" onclick="approve_status_change(event)">
                                                    <img style="cursor: pointer;" src="{% static 'img/like-passive.png' %}" class="img-fluid" alt="dislike butonu" data-id="{{tooth_number}}" data-icon-status="2" data-approve-status="{{tooth_detail.approved}}" onclick="approve_status_change(event)">
                                                    {% else %}
                                                    <img style="cursor: pointer;" src="{% static 'img/like.png' %}" class="img-fluid" alt="like butonu" data-id="{{tooth_number}}" data-icon-status="1" data-approve-status="{{tooth_detail.approved}}" onclick="approve_status_change(event)">
                                                    <img style="cursor: pointer;" src="{% static 'img/dislike.png' %}" class="img-fluid" alt="dislike butonu" data-id="{{tooth_number}}" data-icon-status="2" data-approve-status="{{tooth_detail.approved}}" onclick="approve_status_change(event)">
                                                    {% endif %}
                                                </div>
                                                <i class="fa-regular fa-comments comment-icon" data-id="{{tooth_number}}"
                                                   onclick="toggleCommentArea({{tooth_number}})"></i>
                                            </div>
                                        </div>
                                        <div class="comment-area" data-id="{{tooth_number}}">
                                                <textarea name="" id="tooth_note_{{tooth_number}}" rows="3"
                                                          placeholder="{% trans 'You can enter a  description here...'%}">{% if tooth_detail.note == None %}{% else %}{{tooth_detail.note}}{% endif %}</textarea>
                                            <button onclick="save_tooth_note({{tooth_number}})" class="custom transparent blue-hover text-light">
                                                <i class="fa-solid fa-floppy-disk"></i>
                                                {% trans 'Save' %}
                                            </button>
                                            <button class="custom transparent blue-hover text-light"
                                                    onclick="toggleCommentArea({{tooth_number}})">
                                                <i class="fa-solid fa-xmark"></i>
                                                {% trans 'Close' %}
                                            </button>
                                        </div>
                                    </div>
                                {% endfor %}
                            </div>
                        </div>
                        {% if not grouped_treatments %}
                            <div id="first-planning" class="treatment-section d-flex flex-column chapter-1">
                                <div class="half d-flex align-items-center justify-content-center py-4">
                                    <img src="{% static 'img/panel-circle.png' %}" class="img-fluid" alt="">
                                </div>
                                <div id="emptyView" class="half d-flex flex-column align-items-center justify-content-center" style="gap: 10px; flex: 1;">
                                    <p class="m-0 text-dark font-weight-bold fs-5">{% trans 'Treatment Planning' %}</p>
                                    <p class="m-0 text-dark fs-6 text-muted text-center">{% trans 'Here you can add and view treatment planning' %}</p>
                                    <button class="custom text-light" style="background: linear-gradient(90deg, #0E2D58 0%, #203F6C 100%);" data-pass-two-chapter>{% trans 'Start Planning' %}</button>
                                </div>
                                <div id="planning-item-container" class="px-3 w-100 bg-light" style="overflow-y: auto;">
                                    <div></div>
                                </div>
                            </div>
                        {% else %}
                            <div id="other-plannings" class="treatment-section d-flex flex-column chapter-1">
                                <div class="half d-flex flex-column align-items-center justify-content-center py-4">
                                    <img src="{% static 'img/panel-circle.png' %}" class="img-fluid" alt="">
                                    <p class="m-0 font-weight-bold fs-5 text-light my-2">{% trans 'Treatment Planning' %}</p>
                                    <p class="m-0 fs-6 text-muted text-center">{% trans 'Here you can add and view treatment planning' %}</p>
                                </div>
                                <div class="half d-flex flex-column align-items-center justify-content-center" style="gap: 10px; flex: 1;">
                                    <div class="position-sticky d-flex justify-content-end w-100 top-0" style="background-color: white;">
                                        <button class="custom text-light m-2" style="background: linear-gradient(90deg, #0E2D58 0%, #203F6C 100%);" data-pass-two-chapter>{% trans 'Start Planning' %}</button>
                                    </div>

                                    <div id="planning-item-container" class="px-3 py-1 w-100" style="flex: 1; overflow-y: auto;">
                                        {% if 'Today' in grouped_treatments %}
                                            <div class="planning-item">
                                                <p class="m-0 text-dark fs-6"><strong>Today</strong></p>
                                            </div>
                                            {% for item in grouped_treatments.Today %}
                                                    <div class="planning-item">
                                                        <div class="rounded p-3 text-dark my-3 d-flex planning-item-box" style="box-shadow: 0 0 30px rgba(0, 0, 0, .15);">
                                                            <span style="width: 12px; height: 12px; border-radius: 50%; background-color: lime;"></span>
                                                            <div class="mx-3">
                                                                <p data-treatment-id="{{ item.id }}" class="m-0 mb-1" data-pass-two-chapter=""><strong>{% trans 'Treatments Plan' %} {{item.counter}} </strong></p>
                                                                <p class="m-0">{{ item.modified_date }}</p>
                                                            </div>
                                                            <span class="ms-auto d-flex align-items-end">
                                                                <i data-open-modal-pk="modal-delete-treatment"
                                                                data-modal-type="treatment-delete" class="fa-solid fa-trash fs-6" style="cursor: pointer;"></i>
                                                            </span>
                                                        </div>
                                                    </div>
                                            {% endfor %}
                                        {% endif %}
                                        {% for date, items in grouped_treatments.items %}
                                            {% if date != 'Today' %}
                                                <div class="planning-item">
                                                    <p class="m-0 text-dark fs-6"><strong>{{ date }}</strong></p>
                                                </div>
                                                {% for item in items %}
                                                        <div class="planning-item">
                                                            <div class="rounded p-3 text-dark my-3 d-flex planning-item-box" style="box-shadow: 0 0 30px rgba(0, 0, 0, .15);">
                                                                <span style="width: 12px; height: 12px; border-radius: 50%; background-color: lightgray;"></span>
                                                                <div class="mx-3">
                                                                    <p data-treatment-id="{{ item.id }}" class="m-0 mb-1" data-pass-two-chapter=""><strong>{% trans 'Treatments Plan' %} {{ item.counter }}</strong></p>
                                                                    <p class="m-0">{{ item.modified_date }}</p>
                                                                </div>
                                                                <span class="ms-auto d-flex align-items-end">
                                                                    <i data-open-modal-pk="modal-delete-treatment"
                                                                    data-modal-type="treatment-delete" class="fa-solid fa-trash fs-6" style="cursor: pointer;"></i>
                                                                </span>
                                                            </div>
                                                        </div>
                                                {% endfor %}
                                            {% endif %}
                                        {% endfor %}
                                        <div id="planning-items-list"></div>
                                    </div>

                                </div>
                            </div>
                        {% endif %}
                        <div class="treatment-section bg-light chapter-2 p-3 d-flex flex-column">
                            <h3 class="text-dark fs-3">{% trans 'Treatment Planning' %}</h3>
                            <p class="text-muted">{% trans 'You can add or update treatment planning' %}</p>
                            <form id="treatment-planning">
                                <textarea name="ck-editor" id="editor"></textarea>
                                <div class="d-flex justify-content-end mt-2">
                                    <button class="custom text-dark me-2" data-pass-one-chapter type="button">{% trans 'Cancel' %}</button>
                                    <button type="submit" class="save-treatment-planning custom btn-blue" data-treatment-save>{% trans 'Save' %}</button>
                                </div>
                            </form>
                        </div>
                    </div>
                   
                        </div>
                </div>
                
                </div>
            </div>
        </div>
    </div>
</main>
<section id="bottom-drop-section">
    <div class="open-section-icon" onclick="toggleDropSection(event)">
        <i class="fa-solid fa-angle-up"></i>
    </div>
    <div class="content">
        {% for image_report_id, value in other_radiographys_section.radiography.items %}
            <div class="radyografi-img-container position-relative" style="cursor: pointer;" data-delete-this-radiography>
                {% if value.status2 == 'success' %}
                    <i class="fa-solid fa-trash delete-icon-for-radioraphy" onclick="bottomDropSectionDeleteItem(this, {{image_report_id}})"></i>
                    <a href="{{value.href}}">
                        <div class="main-overlay">
                            <span class="position-absolute text-light" style="bottom: 7px; left: 7px; z-index: 13; font-size: 10px;">{{value.date}}</span>
                        </div>
                        <div class="hover-section {{value.status1}}"></div>
                        <div class="status-circle {{value.status2}}"></div>
                        {% if "media/dental/radio/" in radiography_section.image_path|safe %}
                            <img style="width:205px; height: 100px;" src="{{value.path}}"
                                 alt="" class="radyografi rounded">
                        {% else %}
                            <img style="width:205px; height: 100px;" src="https://aiv2.craniocatch.com/media{{value.path}}"
                                 alt="" class="radyografi rounded">
                        {% endif %}
                    </a>
                {% else %}
                    <i class="fa-solid fa-trash delete-icon-for-radioraphy" onclick="bottomDropSectionDeleteItem(this, {{image_report_id}})"></i>
                    <a data-image-path="{{value.path}}" style="cursor:pointer" data-image-id="{{value.image_id}}" onclick="start_analyze(this)">
                        <div class="main-overlay">
                            <span class="position-absolute text-light" style="bottom: 7px; left: 7px; z-index: 13; font-size: 10px;">{{value.date}}</span>
                        </div>
                        <div class="hover-section {{value.status1}}"></div>
                        <div data-image-id-div="{{value.image_id}}" class="status-circle {{value.status2}}"></div>
                        {% if "media/dental/radio/" in value.path %}
                            <img style="width:205px; height: 100px;" src="{{value.path}}"
                                 alt="" class="radyografi rounded">
                        {% else %}
                            <img style="width:205px; height: 100px;" src="https://aiv2.craniocatch.com/media{{value.path}}"
                                 alt="" class="radyografi rounded">
                        {% endif %}
                    </a>
                {% endif %}
            </div>
        {% endfor %}
    </div>
    {% csrf_token %}
</section>


{% endblock %}

{% block customJs %}
<script src="{% static 'js/bootstrap.js' %}"></script>
<script src="{% static 'js/toastify.js' %}"></script>
<script src="{% static 'js/annotorious.min.js' %}"></script>
<script src="{% static 'js/leaflet.js' %}"></script>
<script src="{% static 'js/leaflet.draw.js' %}"></script>
<script src="{% static 'js/leaflet-geoman.min.js' %}"></script>
<script src="{% static 'js/leaflet-ruler.js' %}"></script>
<!-- <script src="{% static 'js/wheelzoom.js' %}"></script> -->
<script src="{% static 'js/app.js' %}"></script>
<script src="{% static 'js/dragZoom.js' %}"></script>
<script src="{% static 'js/sweatalert.js' %}"></script>
<script src="{% static 'js/dropzone.js' %}"></script>
<script src="{% static 'js/ckeditor2.js' %}"></script>
<script src="{% static 'js/drawing2.js' %}"></script>
<script src="{% static 'js/diagnosis_exstra.js' %}"></script>
<script>
    function kisalt(labelElement) {
        labelElement.each(function() {
        var labelContent = $(this).text(); // Doğru kullanım: $(this).text()
        if (labelContent.length > 16) {
            $(this).text(labelContent.substring(0, 16) + '...');
        }
    });
}

kisalt($(".label-element"));

</script>

<script>
    // opacity için olan kod buradadır
    $(".slider input[type='range']").on("input", function() {
        let value_of_range = $(this).val()
        let illness_name = $(this).attr("data-illness-name") // illness
        $(this).closest(".slider").find(".pointer-container .pointer").css({left: value_of_range * 100 + "%"}) // cubukcuk kaydırma kodu
        $(`.drawsElement[data-illness-name="${illness_name}"]`).attr("fill-opacity", value_of_range)
    })
</script>
<script>
    // $(".block-icon").click(function(){
    //     $(".items-one").slideToggle("d-block")
    //     $(".block-icon").toggleClass("items-icon-rotate")
    // })
    // $(".block-icon-two").click(function(){
    //     $(".items-two").slideToggle("d-block")
    //     $(".block-icon-two").toggleClass("items-icon-rotate")
    // })
    // $(".block-icon-tree").click(function(){
    //     $(".items-tree").slideToggle("d-block")
    //     $(".block-icon-tree").toggleClass("items-icon-rotate")
    // })
  $("#ilabel").click(function(){
    
  })
  $("#anatomyIcon").click(function(){
    $(".popup-two").slideToggle("d-block")
  })
  $("#popupTree").click(function(){
    $(".diagnosis-two").slideToggle("d-block")
  })

  $(document).ready(function() {
    $("img[data-target-popup]").click(function() {
        var targetPopupId = $(this).data("target-popup");
        $("#" + targetPopupId).slideToggle("d-block");
    });
});
</script>

<script>
    var image_report_id = "{{image_report_id}}"
    let csrfToken = $('input[name=csrfmiddlewaretoken]').val()
    var myCkEditor
    var diagnosis_labels
</script>

<script>
    $(document).ready(function () {
        // Düğmeye tıklanma olayını yakalayın
        $('#sendReportMail').click(function () {
            // Tıklanma olayı gerçekleştiğinde çalışacak kodu buraya yazabilirsiniz
            // Tüm inputları döngüye alarak seçili olanı bulun
            var formatInputs = $('input[name="reporting-area-mail"]:checked');
            var formatType = formatInputs.val();
            var hasta = $('#report-ch-mail-1').prop('checked');
            var radiography = $('#report-ch-mail-2').prop('checked');
            var drawed_radiography = $('#report-ch-mail-3').prop('checked');
            var draw_selected = $('#additional-ch-mail-1').prop('checked');
            var draw_all = $('#additional-ch-mail-2').prop('checked');
            var draw_numbering =$('#additional-ch-mail-3').prop('checked');
            var hekim = $('#report-ch-mail-4').prop('checked');
            var hekim_imzasi = $('#report-ch-mail-6').prop('checked');
            var qr_code = $('#report-ch-mail-7').prop('checked');
            var tedavi_planlari = $('#report-ch-mail-5').prop('checked');
            var nameForSendMail = $('#nameForSendMail').val()
            var emailForSendMail = $('#emailForSendMail').val()
            var emailInputError = document.getElementById("emailForSendMail");
            var emailPattern = /^[a-zA-Z0-9._-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,4}$/;
            if(!emailPattern.test(emailForSendMail)){
                emailInputError.style.border = "1px solid red"; // Geçersiz bir e-posta adresi girildiği için çerçeve kırmızı renkli olacak.
                Swal.fire({
                        position: 'top-end',
                        icon: 'error',
                        title: '{% trans "Please enter a valid e-mail address" %}',
                        showConfirmButton: false,
                        timer: 2000
                    })
                return false
            }
            if (window.location.href.includes("/en/")) {
                var lang = "en"
            }
            else if (window.location.href.includes("/uz/")) {
                var lang = "uz"
            }
            else if (window.location.href.includes("/ru/")) {
                var lang = "ru"
            }
            else if (window.location.href.includes("/nl/")) {
                var lang = "nl"
            }
            else{
                var lang = "tr"
            }
            var filterBasedInputs = $('input[name="report-data-mail"]:checked');
            var saveChoices = $('input[name="save-choices-for-mail"]').is(':checked');
            var filterBasedType = filterBasedInputs.val();
            let csrfToken = $('input[name=csrfmiddlewaretoken]').val()
            $.ajax({
                url: '{% url "createReportForPatient" %}', // AJAX isteğinin gönderileceği URL
                method: 'POST', // İstek yöntemi (GET, POST, PUT, DELETE vb.)
                headers: {'X-CSRFToken': csrfToken},
                data: {
                    formatType: formatType,
                    hasta: hasta,
                    radiography: radiography,
                    drawed_radiography: drawed_radiography,
                    draw_selected: draw_selected,
                    draw_all: draw_all,
                    draw_numbering: draw_numbering,
                    selected_items: selectedItems,
                    hekim: hekim,
                    qr_code: qr_code,
                    hekim_imzasi: hekim_imzasi,
                    tedavi_planlari: tedavi_planlari,
                    filterBasedType: filterBasedType,
                    save_choices: saveChoices,
                    imageReportID: "{{image_report_id}}",
                    nameForSendMail: nameForSendMail,
                    emailForSendMail: emailForSendMail,
                }, // Gönderilecek veriler
                success: function (response) {
                    $.ajax({
                        url:'{% url "sendReportMail" %}',
                        method:"POST",
                        headers: {'X-CSRFToken': csrfToken},
                        data : {
                            nameForSendMail:nameForSendMail,
                            emailForSendMail:emailForSendMail,
                            slug:response.slug,
                            lang:lang,
                            image_report_id:{{image_report_id}},
                            qr_code: qr_code
                        },
                        success:function(response){
                            swal.fire({
                                position: 'top-end',
                                icon: 'success',
                                title:"{% trans 'Report sent as e-mail' %}",
                                showConfirmButton: false,
                                timer: 2000
                            })
                        },
                        error:function(xhr, status, error){
                        }
                    })
                }, // İstek başarılı olduğunda çalışacak işlev
                error: function (xhr, status, error) {
                    console.error('İstek sırasında bir hata oluştu.');
                    console.error('Hata durumu:', status);
                    console.error('Hata detayı:', error);
                } // İstek başarısız olduğunda çalışacak işlev
            });

        });
    });
    function setCustomCkEditor(id, csrfToken, editor) {
        $("#editor").attr("data-editor-treatment-id",id)
        $.ajax({
            url:"{% url 'get_content_of_treatment_planning' %}",
            type:"GET",
            headers: { 'X-CSRFToken': csrfToken },
            data:{'id':id},
            success:function(response){
                myCkEditor.setData(response.content)
            },
            error:function(xhr, status, error){
            }
        })
    }
</script>
<script>
    $("#pencilke .draw-icon-item img").click(function() {
        // toolbardaki kalem ikonun içindeki polygon ve rectangle ikonlarına tıklanınca active class verir
        $(".draw-icon-item img.active") ? $(".draw-icon-item img.active").removeClass("active") : null
        $(this).addClass("active")
        // $("#implantCrownDropdown .dropdown-section").addClass("d-flex")
        impCrwEditModeStatus = true;
    })
    $(document).keyup(function (e) {
        if (e.key === "Escape") { // escape key maps to keycode `27`
            if($("#implantCrownDropdown .dropdown-section").hasClass("d-flex")) {
                $(".draw-icon-item img").removeClass("active");
                $("#implantCrownDropdown .dropdown-section").removeClass("d-flex");
                $(".leaflet-marker-pane img").removeClass("active_impcrw_img");
                impCrwEditModeStatus = false;
                map.pm.disableGlobalDragMode();
            }
        }
    });
</script>

<script>
    $(document).ready(function () {
        var editableLayers = new L.FeatureGroup();
        map.addLayer(editableLayers);
     })
</script>

<script>
    $("input[name='kalem']").change(function(event) {
        if($(event.target).val() === "rectangele") {
            // rectangele çizilmek isteniyor
            // console.log("rect çiz")
        } else if($(event.target).val() === "polygon")  {
            // ploygon çizilmek isteniyor 
            // console.log("poly çiz")
        }
    })
</script>

<script>
    var time = 0
    function drawTeeth(toothNumber, toothCoord, toothPosition, stepByStep = false) {
        stepByStep ? $("#drawTeethBoxesDraw").css("pointer-events", "none") : null
        let template = `
            <div class="tooth-number-draw ${toothPosition} tooth-${toothNumber}" style="z-index: 9999">
                <div class="line position-fixed"></div>
                <div class="root position-fixed"></div>
                <div class="tooth-number-value position-fixed d-flex justify-content-center align-items-center">${toothNumber}</div>
            </div>
        `
        setTimeout(function () {
            $(".teeth-draw-container").append(template) // git template i html e göm
            $(`.tooth-${toothNumber} .root`).css({
                "left": toothCoord[0],
                "top": toothCoord[1],
                "display": "block"
            }) // kökün koordinatlarını ver ve yerleştir - görünürlüğünü aç

            let rootCircle = $(`.tooth-${toothNumber} .root`) // kökü yakala
            let line = $(`.tooth-${toothNumber} .line`) // çizgiyi yakala
            let rootCircleLeft = rootCircle.offset().left // kökün soldan konumunu al
            let rootCircleTop = rootCircle.offset().top // kökün yukardan konumunu al
            let lineLeft = rootCircleLeft + (rootCircle.width() / 2) // çizginin soldan olması gereken boşluğu al
            let lineTop = rootCircleTop - line.height() //çizginin yukardan olması gereken boşluğu al

            if (toothPosition === "top") {
                // çizdirilecek diş numarası üst diş ise
                $(`.tooth-${toothNumber} .line`).css({
                    "left": `${lineLeft}px`,
                    "top": `${lineTop - 5}px`
                }) // line circle ile aynı hizaya getir
                $(`.tooth-${toothNumber} .tooth-number-value`).css({
                    "left": `${lineLeft - 15}px`,
                    "top": `${lineTop - 5 - 100 - 31}px`,
                })
            } else {
                // çizdirilecek diş numarası alt diş ise
                $(`.tooth-${toothNumber} .line`).css({
                    "left": `${lineLeft}px`,
                    "top": `${lineTop + 15}px`
                }) // line circle ile aynı hizaya getir
                $(`.tooth-${toothNumber} .tooth-number-value`).css({
                    "left": `${lineLeft - 15}px`,
                    "top": `${lineTop + 15 + 100}px`,
                })
            }
            setTimeout(function () {
                $(`.tooth-${toothNumber} .tooth-number-value`).css("opacity", "1")
            }, 500)
            $(".tooth-number-draw.top .line").css("animation", "increaseHeightTopTooth 500ms forwards")
            $(".tooth-number-draw.bottom .line").css("animation", "increaseHeightBottomTooth 500ms forwards")
        }, time)
        stepByStep ? time += 500 : null
    }
    function getCoordinatesAndDrawTeeth() {
        const teethCoords = []
        $(".toothCardElement").map((index, item) => {
            const bbox = $(item)[0].getBBox();
            const toothNumber = $(item).attr("tooth-name");
            const toothCoord = [$(item).offset().left + bbox.width / 2, $(item).offset().top + bbox.height / 2];
            let toothPosition = "bottom";

            const topToothNumbers = [55, 54, 53, 52, 51, 61, 62, 63, 64, 65, 18, 17, 16, 15, 14, 13, 12, 11, 21, 22, 23, 24, 25, 26, 27, 28];
            if (topToothNumbers.includes(parseInt(toothNumber))) {
                toothPosition = "top";
            }

            teethCoords.push({
                "toothNumber": parseInt(toothNumber),
                "toothCoord": toothCoord,
                "toothPosition": toothPosition
            });
        });
        teethCoords.map(item => {
            drawTeeth(item.toothNumber, item.toothCoord, item.toothPosition)
        })
    }
    function clearTeethDraw() {
        $(".teeth-draw-container").html("")
    }
    $("#drawTeethBoxesDraw").click(function (event) {
        if ($(event.target).is(":checked")) {
            getCoordinatesAndDrawTeeth()
        } else {
            clearTeethDraw()
        }
    })
</script>

<script>
    // 'Drawed Radiography' checkbox'unu seçin
    var drawedRadiographyCheckbox = document.getElementById('report-ch-3');

    // 'Drawed Radiography' checkbox'unun durumunu kontrol eden iş

    // 'Drawed Radiography' checkbox'unun durumunu kontrol eden işlevi tanımlayın
    function toggleAdditionalOptions() {
        var additionalOptionsDiv = document.getElementById('additional-options');

        // 'Drawed Radiography' seçildiyse ek seçenekleri görüntüle, aksi takdirde gizle
        if (drawedRadiographyCheckbox.checked) {
            additionalOptionsDiv.style.display = 'block';
        } else {
            additionalOptionsDiv.style.display = 'none';
        }
    }

    // 'Drawed Radiography' checkbox'unun durumu değiştiğinde toggleAdditionalOptions işlevini çağırın
    drawedRadiographyCheckbox.addEventListener('change', toggleAdditionalOptions);
    // SEND MAİL
    // 'Drawed Radiography' checkbox'unu seçin
    var drawedMailRadiographyCheckbox = document.getElementById('report-ch-mail-3');

    // 'Drawed Radiography' checkbox'unun durumunu kontrol eden iş

    // 'Drawed Radiography' checkbox'unun durumunu kontrol eden işlevi tanımlayın
    function toggleAdditionalMailOptions() {
        var additionalMailOptionsDiv = document.getElementById('additional-mail-options');

        // 'Drawed Radiography' seçildiyse ek seçenekleri görüntüle, aksi takdirde gizle
        if (drawedMailRadiographyCheckbox.checked) {
            additionalMailOptionsDiv.style.display = 'block';
        } else {
            additionalMailOptionsDiv.style.display = 'none';
        }
    }
        window.onload = function() {
        toggleAdditionalOptions();
        toggleAdditionalMailOptions();
    };

    // 'Drawed Radiography' checkbox'unun durumu değiştiğinde toggleAdditionalOptions işlevini çağırın
    drawedMailRadiographyCheckbox.addEventListener('change', toggleAdditionalMailOptions);
</script>

<script>
    // Doktor notu kaydetme apisine istek atan yer
    document.getElementById("doctor-comment-save-btn").addEventListener("click", function() {
        // textarea içeriğini alıyor
        var doctorNote = document.getElementById("doctorNoteArea").value;
        let csrfToken = $('input[name=csrfmiddlewaretoken]').val()
        // AJAX isteği için veri objesini oluşturuyor
        var data = {
            doctor_note: doctorNote,
            image_report_id:{{image_report_id}}
        };

        // AJAX isteği yapıyor
        $.ajax({
            url: "{% url 'save_doctor_note' %}",
            type: "POST",
            headers: {'X-CSRFToken': csrfToken},
            data: data,
            success: function(response) {
                swal.fire({
                    position: 'top-end',
                    icon: 'success',
                    title:"{% trans 'Doctor note has been saved' %}",
                    showConfirmButton: false,
                    timer: 2000
                })
            },
            error: function(error) {
            }
        });
    });
</script>
<script>
    var saveChoiceCheckboxForMail = document.getElementById("save-choices-for-mail");
    saveChoiceCheckboxForMail.addEventListener("change",function(){
        //checkbox seçiliyse
        if (saveChoiceCheckboxForMail.checked){
            var formatInputs = $('input[name="reporting-area-mail"]:checked');
            var formatType = formatInputs.val();
            var hasta = $('#report-ch-mail-1').prop('checked');
            var radiography = $('#report-ch-mail-2').prop('checked');
            var drawed_radiography = $('#report-ch-mail-3').prop('checked');
            var draw_selected = $('#additional-ch-mail-1').prop('checked');
            var draw_all = $('#additional-ch-mail-2').prop('checked');
            var draw_numbering =$('#additional-ch-3').prop('checked');
            var hekim_notu = $('#report-ch-mail-4').prop('checked');
            var hekim_imzasi = $('#report-ch-mail-5').prop('checked');
            var tedavi_planlari = $('#report-ch-mail-6').prop('checked');
            var filterBasedInputs = $('input[name="report-data-mail"]:checked');
            var filterBasedType = filterBasedInputs.val();
            let csrfToken = $('input[name=csrfmiddlewaretoken]').val()
            var data = {
                formatType: formatType,
                hasta: hasta,
                radiography: radiography,
                drawed_radiography: drawed_radiography,
                draw_selected: draw_selected,
                draw_all: draw_all,
                draw_numbering: draw_numbering,
                selected_items: selectedItems,
                hekim_notu: hekim_notu,
                hekim_imzasi: hekim_imzasi,
                tedavi_planlari: tedavi_planlari,
                filterBasedType: filterBasedType,
                csrfmiddlewaretoken: csrfToken,
                image_report_id:{{image_report_id}},
            };
            $.ajax({
                url: "{% url 'save_doctor_choices' %}",
                type: "POST",
                headers: {'X-CSRFToken': csrfToken},
                data: JSON.stringify(data),
                success: function(response) {
                    // console.log("choices success")
                },
                error: function(error) {
                    // console.log("choices error")
                }
            })
        } else {
            // console.log("Checkbox is unchecked");
        }
    })
    var saveChoiceCheckbox = document.getElementById("report-save-choice");
    saveChoiceCheckbox.addEventListener("change",function(){
        //checkbox seçiliyse
        if (saveChoiceCheckbox.checked){
            var formatInputs = $('input[name="reporting-area"]:checked');
            var formatType = formatInputs.val();
            var hasta = $('#report-ch-1').prop('checked');
            var radiography = $('#report-ch-2').prop('checked');
            var drawed_radiography = $('#report-ch-3').prop('checked');
            var draw_selected = $('#additional-ch-1').prop('checked');
            var draw_all = $('#additional-ch-2').prop('checked');
            var draw_numbering =$('#additional-ch-3').prop('checked');
            var hekim_notu = $('#report-ch-4').prop('checked');
            var hekim_imzasi = $('#report-ch-5').prop('checked');
            var tedavi_planlari = $('#report-ch-6').prop('checked');
            var filterBasedInputs = $('input[name="report-data"]:checked');
            var filterBasedType = filterBasedInputs.val();
            let csrfToken = $('input[name=csrfmiddlewaretoken]').val()
            var data = {
                formatType: formatType,
                hasta: hasta,
                radiography: radiography,
                drawed_radiography: drawed_radiography,
                draw_selected: draw_selected,
                draw_all: draw_all,
                draw_numbering: draw_numbering,
                selected_items: selectedItems,
                hekim_notu: hekim_notu,
                hekim_imzasi: hekim_imzasi,
                tedavi_planlari: tedavi_planlari,
                filterBasedType: filterBasedType,
                csrfmiddlewaretoken: csrfToken,
                image_report_id:{{image_report_id}},
            };
            $.ajax({
                url: "{% url 'save_doctor_choices' %}",
                type: "POST",
                headers: {'X-CSRFToken': csrfToken},
                data: JSON.stringify(data),
                success: function(response) {
                    // console.log("choices success")
                },
                error: function(error) {
                    // console.log("choices error")
                }
            })
        } else {
            // console.log("Checkbox is unchecked");
        }
    })
</script>

<script>
    $(document).ready(function () {
        // Düğmeye tıklanma olayını yakalayın
        $('#createReport').click(function () {
            // Tıklanma olayı gerçekleştiğinde çalışacak kodu buraya yazabilirsiniz

            // Tüm inputları döngüye alarak seçili olanı bulun
            var formatInputs = $('input[name="reporting-area"]:checked');
            var formatType = formatInputs.val();

            var hasta = $('#report-ch-1').prop('checked');
            var radiography = $('#report-ch-2').prop('checked');
            var drawed_radiography = $('#report-ch-3').prop('checked');
            var draw_selected = $('#additional-ch-1').prop('checked');
            var draw_all = $('#additional-ch-2').prop('checked');
            var draw_numbering =$('#additional-ch-3').prop('checked');
            var hekim = $('#report-ch-4').prop('checked');
            var hekim_imzasi = $('#report-ch-6').prop('checked');
            var tedavi_planlari = $('#report-ch-5').prop('checked');

            var filterBasedInputs = $('input[name="report-data"]:checked');
            var saveChoices = $('input[name="save-choices"]').is(':checked');
            var filterBasedType = filterBasedInputs.val();
            let csrfToken = $('input[name=csrfmiddlewaretoken]').val()
            $.ajax({
                url: '{% url "createReportForPatient" %}', // AJAX isteğinin gönderileceği URL
                method: 'POST', // İstek yöntemi (GET, POST, PUT, DELETE vb.)
                headers: {'X-CSRFToken': csrfToken},
                data: {

                    formatType: formatType,
                    hasta: hasta,
                    radiography: radiography,
                    drawed_radiography: drawed_radiography,
                    draw_selected: draw_selected,
                    draw_all: draw_all,
                    draw_numbering: draw_numbering,
                    selected_items: selectedItems,
                    hekim: hekim,
                    hekim_imzasi: hekim_imzasi,
                    tedavi_planlari: tedavi_planlari,
                    filterBasedType: filterBasedType,
                    save_choices: saveChoices,
                    imageReportID: {{image_report_id}},

                }, // Gönderilecek veriler
                success: function (response) {
                    let slug = response["slug"]
                    if (window.location.href.includes("/tr/")) {
                        language = 'tr';
                    }else if (window.location.href.includes("/uz/")) {
                        language = 'uz';
                    }else if (window.location.href.includes("/ru/")) {
                        language = 'ru';
                    }else if (window.location.href.includes("/nl/")) {
                        language = 'nl';
                    } else {
                        language = 'en';
                    }
                    let redirectURL = "/" + language + "/report/" + slug;
                    // Yeni sekmede yönlendirme yap
                    window.open(redirectURL, '_blank');
                }, // İstek başarılı olduğunda çalışacak işlev
                error: function (xhr, status, error) {
                    console.error('İstek sırasında bir hata oluştu.');
                    console.error('Hata durumu:', status);
                    console.error('Hata detayı:', error);
                } // İstek başarısız olduğunda çalışacak işlev
            });

        });
    });
</script>

<script>
    $(document).ready(function() {
        $("#page-loading").hide()
    })
</script>

<script>
    // doctor comment alanı
    $(".doctor-comment i").click(function() {
        $(".doctor-comment").toggleClass("active")
        if($(".doctor-comment").hasClass("active")) {
            // panel açılmak isteniyor o halde aç
            $("#doctor-comment-area").css({
                "top" : "0%"
            })
        } else {
            $("#doctor-comment-area").css({
                "top" : "-100%"
            })
        }
    })
    $("#doctor-comment-cancel-btn").click(function() {
        $("#doctor-comment-area").css({
            "top" : "-100%"
        })
    })
</script>


<script>
    $("input[name='weakstrongradio']").change(function(event) {
        // weak strong medium strong kısmı ui
        let inputVal = event.target.value
        let marked = $("#back-marked")
        let backOfMarked = $("#back-value")
        let triangeleBack = $("#triangele-back")
        if(inputVal === "dentist") {
            marked.css("left", "12.5%")
            triangeleBack.css("left", "0%")
            backOfMarked.css("width", "30px")
        } else if(inputVal === "strong") {
            marked.css("left", "37.5%")
            triangeleBack.css("left", "25%")
            backOfMarked.css("width", "90px")
        } else if(inputVal === "medium") {
            marked.css("left", "62.5%")
            triangeleBack.css("left", "50%")
            backOfMarked.css("width", "150px")
        }else if(inputVal === "weak") {
            marked.css("left", "87.5%")
            triangeleBack.css("left", "75%")
            backOfMarked.css("width", "210px")
        }
    })
</script>

<script>
    $("[data-delete-illness-btn]").click(function() {
        // dişteki hastalığa tıklayınca açılan modalda evete tıklayınca silme işlemi yapar
        let toothNumber = $("#delete-illness-from-tooth").attr("data-tooth-number-modal")
        let illnessName = $("#delete-illness-from-tooth").attr("data-ilness-name-modal")
        let illnessSlug = $("#delete-illness-from-tooth").attr("data-illness-slug")
        let toothID = $("#delete-illness-from-tooth").attr("data-tooth-id")
        let csrfToken = $('input[name=csrfmiddlewaretoken]').val()
        let targetElement = $(`.tooth-percent[data-delete-illness='${illnessName}'][data-tooth-number-for-illness-delete='${toothNumber}'][data-illness-slug='${illnessSlug}'][data-tooth-id='${toothID}']`).closest(".delete-illness-parent")
        $.ajax({
            url:"{% url 'delete_illness_from_tooth' %}",
            type:"POST",
            headers: { 'X-CSRFToken': csrfToken },
            data:{
                toothNumber:toothNumber,
                illnessSlug:illnessSlug,
                imageReportID:{{image_report_id}},
                toothId:toothID
            },
            success:function(response){
                draw_leaflet()
                swal.fire({
                    position: 'top-end',
                    icon: 'success',
                    title:"{% trans 'Disease removed from tooth' %}",
                    showConfirmButton: false,
                    timer: 2000
                }).then(function(){
                    targetElement.delay(400).fadeOut(400) // sakince elementi sil
                    $(`.drawsElement[data-slug='${illnessSlug}']`).remove();
                })
                },
            error:function(xhr,errmsg,err){
            }
        })

    })
</script>

<script>
    $("[data-delete-treatment-btn]").click(function() {
        // dişteki hastalığa tıklayınca açılan modalda evete tıklayınca silme işlemi yapar
        let toothNumber = $("#delete-treatment-from-tooth").attr("data-tooth-number-modal")
        let treatmentSlug = $("#delete-treatment-from-tooth").attr("data-method-slug")
        let toothID = $("#delete-treatment-from-tooth").attr("data-tooth-id")
        let csrfToken = $('input[name=csrfmiddlewaretoken]').val()
        let targetElement = $(`.tooth-detail[data-tooth-id=${toothNumber}] span[data-method-slug=${treatmentSlug}]`)
        $.ajax({
            url:"{% url 'delete_treatment_from_tooth' %}",
            type:"POST",
            headers: { 'X-CSRFToken': csrfToken },
            data:{
                toothNumber:toothNumber,
                treatmentSlug:treatmentSlug,
                imageReportID:{{image_report_id}},
                toothId:toothID
            },
            success:function(response){
                swal.fire({
                    position: 'top-end',
                    icon: 'success',
                    title:"{% trans 'Treatment removed from tooth' %}",
                    showConfirmButton: false,
                    timer: 2000
                }).then(function(){
                    // window.location.reload()
                    targetElement.delay(300).fadeOut(600)
                })


                },
            error:function(xhr,errmsg,err){
            }
        })

    })
</script>

<script>

    $(".diseases").click(function(event) {
        // sayfaya sonradan eklenen diagnosis elementini jquery dom da direk kendini görmediğinden parent elementten yakalamak gerekiyor
        let spanThatClicked = $(event.target)
        if(spanThatClicked.hasClass("tooth-percent")) {
            let illnessName = spanThatClicked.attr("data-delete-illness")
            let toothNumber = spanThatClicked.attr("data-tooth-number-for-illness-delete")
            let toothSlug = spanThatClicked.attr("data-illness-slug")
            let toothID = spanThatClicked.attr("data-tooth-id")
            // console.log("@@@@", illnessName, toothNumber, toothSlug, toothID)
            $("#delete-illness-from-tooth").addClass("active")
            $("#delete-illness-from-tooth").attr({
                "data-ilness-name-modal" : illnessName,
                "data-tooth-number-modal" : toothNumber,
                "data-illness-slug" : toothSlug,
                "data-tooth-id": toothID
            })
        }
    })
</script>

<script>
    $(".treatmentForTooth").click(function(event) {
        if($(event.target).attr("data-delete-treatment-id")) {
          $("#delete-treatment-from-tooth").addClass("active")
          let toothNumber = $(event.target).attr("data-tooth-number-for-treatment-delete")
          let methodSlug = $(event.target).attr("data-method-slug")
          let toothID = $(event.target).attr("data-tooth-id")
          $("#delete-treatment-from-tooth").attr({
            "data-tooth-number-modal" : toothNumber,
            "data-method-slug" : methodSlug,
            "data-tooth-id": toothID
          })
        }
    })
</script>

<script>
    // Trash ikonuna tıklanınca modal açma
    var treatmentId;
    $('.fa-trash').on('click', function() {
    var planningItem = $(this).closest('.planning-item');
    treatmentId = planningItem.find('[data-treatment-id]').data('treatment-id');

    // Modalı açarken treatmentId'yi veri olarak ekleme
    $('#modal-delete-treatment').attr('data-modal-treatment-id', treatmentId);

    // Modalı açma kodları buraya gelecek
    });

    // Yes düğmesine tıklanınca AJAX isteği gönderme ve treatment planningi silme
    $('[data-btn-operation="delete-treatment"]').on('click', function() {
        // console.log("buradan sil KAYBOLL")
        // var treatmentId = $(this).closest('.modal-container').data('modal-treatment-id');
        var planningItem = $('.planning-item').find('[data-treatment-id="' + treatmentId + '"]').closest('.planning-item');
        var csrfToken = $('input[name=csrfmiddlewaretoken]').val();
        $.ajax({
            url: "{% url 'delete_treatment_plan' %}",
            method: 'POST',
            headers: { 'X-CSRFToken': csrfToken },
            data: {
            treatmentId: treatmentId
            },
            success: function(response) {
                planningItem.delay(300).fadeOut(600)
                Toastify({
                    gravity:"top",
                    position:"right",
                    duration:1000,
                    icon: "<i class='fa-solid fa-check'></i>",
                    backgroundColor: "green",
                    text: "{% trans 'Treatment planning successfully deleted' %}"
                }).showToast()
            },
            error: function(xhr, status, error) {
            // Hata durumunda yapılacak işlemler
            }
    });
    });
</script>

<script>
    function initCkEditor(data = '') {
        ClassicEditor
            .create( document.querySelector( '#editor', {
                toolbar: [
                'heading', 'bold', 'italic', 'link', 'bulletedList', 'numberedList',
                'blockQuote', 'imageUpload', 'insertTable', 'undo', 'redo'
            ],
            }))
            .then( newEditor => {
                myCkEditor = newEditor
                $("[data-pass-two-chapter]").click(function() {
                    // newEditor.setData("<p style='color:red;'>2.<strong>adım</strong> a geçildi</p>")
                    let id = $(this).attr("data-treatment-id")
                    var csrfToken = $('input[name=csrfmiddlewaretoken]').val();
                    if(id !== undefined){
                        setCustomCkEditor(id, csrfToken, myCkEditor)
                        // aslında bir id geldi
                        // $("#editor").attr("data-editor-treatment-id",id)
                        // $.ajax({
                        //     url:"{% url 'get_content_of_treatment_planning' %}",
                        //     type:"GET",
                        //     headers: { 'X-CSRFToken': csrfToken },
                        //     data:{'id':id},
                        //     success:function(response){
                        //         newEditor.setData(response.content)
                        //     },
                        //     error:function(xhr, status, error){
                        //     }

                        // })
                    } else {
                        // start planning diyip yeni ekleme yapılcağı zaman
                        if (selectedItemsCount > selectedItems.length){
                            items_for_send = selectedItems
                        }else{
                            items_for_send = null
                        }
                        $.ajax({
                            url:"{% url 'get_content_of_ai_treatment_planning' %}",
                            type:"GET",
                            headers: { 'X-CSRFToken': csrfToken },
                            data:{"image_report_id":image_report_id, "selected_items": items_for_send
                            },
                            success:function(response){
                                
                                $("#editor").attr("data-editor-treatment-id", "null");

                                // let treatment_recommendations_from_AI = {{treatment_planning_from_AI|safe}};
                                let content = '';

                                for (var key in response.treatment_planning_from_AI) {
                                    var treatmentMethods = response.treatment_planning_from_AI[key];
                                    content += `<p><strong>${key}</strong> - `;

                                    if (window.location.href.includes("/tr/")) {
                                        treatmentMethod = treatmentMethods['tr_treatment_method'];
                                    } else if (window.location.href.includes("/uz/")) {
                                        treatmentMethod = treatmentMethods['uz_treatment_method'];
                                    } else if (window.location.href.includes("/ru/")) {
                                        treatmentMethod = treatmentMethods['ru_treatment_method'];
                                    } else if (window.location.href.includes("/nl/")) {
                                        treatmentMethod = treatmentMethods['nl_treatment_method'];
                                    } else {
                                        treatmentMethod = treatmentMethods['en_treatment_method'];
                                    }
                                    content += treatmentMethod;
                                    content += '</p>';
                                }

                                newEditor.setData(content);
                            },
                            error:function(xhr, status, error){
                            }

                        })
                        

                    }
                })
            })
            .catch( error => {
                console.error( error );
            } );
    }
    initCkEditor()



</script>

<script>
    function closeTreatment() {
            $("[data-open-treatment]").toggleClass("transparent btn-blue")
            $(".treatment-section.chapter-2").removeClass("active")
        }
        function openTreatment() {
            $("[data-open-treatment]").toggleClass("transparent btn-blue")
            $(".treatment-section.chapter-1").toggleClass("active")
        }
        function passSecondChapter() {
            $(".treatment-section.chapter-1").removeClass("active")
            $(".treatment-section.chapter-2").addClass("active")
        }
        function passFirstChapter() {
            $(".treatment-section.chapter-2").removeClass("active")
            $(".treatment-section.chapter-1").addClass("active")
        }
        $("[data-open-treatment]").click(function() {
            if($(".treatment-section.chapter-2").hasClass("active")) {
                // aslında ikinci adım açıksa ve yukarıdaki treatment butonunua tıklanırsa
                // kompkle kapat aslında
                closeTreatment()
            } else {
                // hiçbişey açık değilse treatmentı aç
                if(!$(".teeth-and-treatment-section").hasClass("active")) {
                    // treatment butonuna tıklandıysa ve sağ panel açık değilse paneli de aç
                    $(".teeth-and-treatment-section").toggleClass("active ")
                    $("[data-event-type='collapse-section'] i").toggleClass("active")
                    $("svg.leaflet-zoom-animated").remove()
                    $("#back-img-frame .loading").removeClass("d-none")
                    if($(".teeth-and-treatment-section").hasClass("active")) {
                        setTimeout(function() {
                        $(".tooth-chart-illnesses-by-tooth").css("opacity", "1")
                        }, 500)
                    } else {
                        $(".tooth-chart-illnesses-by-tooth").css("opacity", "0")
                    }
                    setTimeout(function (){
                        draw_leaflet()
                    },500)
                }
                openTreatment()
            }
        })
        $("[data-pass-one-chapter]").click(function() {
            passFirstChapter()
        })
        $("[data-pass-two-chapter]").click(function() {
            passSecondChapter()
        })
        $("[data-treatment-close]").click(function() {
            closeTreatment()
        })
        $("[data-treatment-save]").click(function() {
            passFirstChapter()
        })
</script>

<!-- TREATMENT EKLEME VEYA GÜNCELLEME SCRIPTI -->
<script>
    $("#treatment-planning").on("submit", function(event) {
        event.preventDefault();
        let image_report_id = {{image_report_id}}
        let data = decodeURIComponent($(event.target).serialize()).replace("ck-editor=", "")
        let csrfToken = $('input[name=csrfmiddlewaretoken]').val()
        let id = $("#editor").attr("data-editor-treatment-id")
        var planningItem = $('#planning-items-list');
        var firstPlanningItem = $('#first-planning')

        $.ajax({
            url : "{% url 'add_treatment_planning' %}",
            type:"POST",
            headers:{'X-CSRFToken':csrfToken},
            data:{
                content:data,
                image_report_id: image_report_id,
                treatment_id:id
            },
            success:function(response){
                // swal.fire({
                //     position: 'top-end',
                //     icon: 'success',
                //     title:"{% trans 'Treatment planning successfully saved' %}",
                //     showConfirmButton: false,
                //     timer: 2000
                // }).then(function(){
                //     // window.location.reload()
                // })
                Toastify({
                        gravity:"top",
                        position:"right",
                        duration:1000,
                        icon: "<i class='fa-solid fa-check'></i>",
                        backgroundColor: "green",
                        text: "{% trans 'Treatment planning successfully saved' %}"
                    }).showToast()

                if(response.status === "new-treatment") {
                    // yeni bir treatment eklenmiş ise DOM a ekle
                    if($("#emptyView").length) {
                        $("#emptyView p").remove()
                        $("#planning-item-container").css("flex","1")
                        $("#emptyView").css("flex","0").addClass("p-2 justify-content-end").removeClass("justify-content-center flex-column")
                        $("#planning-item-container > :first-child").html("<p class='m-0 my-2 text-dark'><strong>Today</strong></p>")
                    }
                    $(`
                    <div class="planning-item">
                        <div class="rounded p-3 text-dark my-3 d-flex planning-item-box" style="box-shadow: 0 0 30px rgba(0, 0, 0, .15);">
                            <span style="width: 12px; height: 12px; border-radius: 50%; background-color: lime;"></span>
                            <div class="mx-3">
                                <p data-treatment-id="${response.treatment_id}" class="m-0 mb-1" data-pass-two-chapter=""><strong style="pointer-events: none">{% trans 'Treatments Plan' %} </strong></p>
                                <p class="m-0">${response.modified_date}</p>
                            </div>
                            <span class="ms-auto d-flex align-items-end">
                                <i data-open-modal-pk="modal-delete-treatment" data-modal-type="treatment-delete" class="fa-solid fa-trash fs-6" style="cursor: pointer;"></i>
                            </span>
                        </div>
                    </div>
                    `).insertAfter("#planning-item-container > :first-child");
                }
            },

            error:function(xhr, errmsg, err){
                // console.log("ckeditörden data gitti geldi ama hata")
            }
        })
    })

</script>

<script>
    $("#planning-item-container").click(function(event) {
        let targetElementType = $(event.target).prop('tagName')
        if(targetElementType === 'P' && $(event.target).attr("data-treatment-id")) {
            // console.log("aç işlemi")
            let id = $(event.target).attr("data-treatment-id")
            let csrfToken = $('input[name=csrfmiddlewaretoken]').val();
            setCustomCkEditor(id, csrfToken, myCkEditor)
            passSecondChapter()
        } else if(targetElementType === 'I') {
            // console.log("silme işlemi")
            let dataTreatmentId = $(event.target).closest(".planning-item").find("p[data-treatment-id]").attr("data-treatment-id")
            treatmentId = dataTreatmentId
            $("#modal-delete-treatment").addClass("active").attr("data-modal-treatment-id", dataTreatmentId)
        }

    })
</script>

<script>
    if(!rectangle_state) {
        $('#back-img-frame').dragZoom({
            zoom: 1,
            onWheelStart: function(event) {
            },
        });
    }
    // $('#back-img-frame').dragZoom({
    //         zoom: 1,
    //     });

    // burası diagnosis kısmındaki select all kısmı - tıklanınca münkün olan checkboxları seçer
    $('[data-select-all-diagnosis]').change(function () {
        if ($(this).is(':checked')) {
            $(".diagnosis-content .item:not(.empty) input[type='checkbox']").prop('checked', true);
        } else {
            $(".diagnosis-content .item:not(.empty) input[type='checkbox']").prop('checked', false);
        }
    });
</script>

<script>
    function closeModal() {
        var modal = document.querySelector(".modal-container.active");
        modal.classList.remove("active");
        var checkboxesForDiagnosis = document.querySelectorAll('.patient-item input[type="checkbox"]:checked');
        checkboxesForDiagnosis.forEach(function(checkbox) {
            checkbox.checked = false;
        })
    }
</script>
<script>
    var alveoler_bone_point = [];
    var toothCardLayerArray = [];
    function removeToothCardLayer() {
        var layersToRemove = map._layers;
            Object.keys(layersToRemove).forEach(layerId => {
                var layer = layersToRemove[layerId];
                if(layer._path) {
                    if (layer._path.className.baseVal === 'toothCardElement') {
                        map.removeLayer(layer);
                    }
                }
            });
    }

    function getToothCardLayer() {
        toothCardLayerArray.forEach(layer => {
            layer.addTo(map);
        });
    }

    function removeEveryOtherPointFromDB(dbCoordinates) {
    var newCoordinates = [];

    for (var i = 0; i < dbCoordinates.length; i += 2) {
        newCoordinates.push(dbCoordinates[i]);
    }

    return newCoordinates;
}

function drawWithCoordinates(
    original_shape,
    xy_array,
    colorCode,
    is_poly = false,
    is_polynomial = false,
    data_illness_name = null,
    data_illness_proba = null,
    tooth_card_status = false,
    illness_list = null,
    data_pointer = false,
    measurement_position = false,
    data_approve_status = false,
    data_slug = false,
    dimension = false,
    rotate = false,
    icon_id = false,
    item_type = false,
    restorations_original_shape = false) { //edit mod iken bununla tekrar çizdirelebilir
    if (!xy_array) {
        null;
    }
    var point_array = []
    var original_point_array = []
    // width_rate = $("#back-img").width() / original_shape['width'];
    // height_rate = ($("#back-img").height() - 5) / original_shape['height'];
    // console.log(width_rate)
    // console.log(height_rate)
    width_rate = original_shape["width_rate"]
    height_rate = original_shape["height_rate"]
    // if (original_shape["bitewing_status"] && data_illness_name == "Dental Pulp"){
    //     width_rate = 1.0025
    //     height_rate = 1.0025
    // }
    if (is_poly && xy_array.length > 20) {
        xy_array = removeEveryOtherPointFromDB(xy_array)
    }

    for (let i = 0; i < xy_array.length; i++) {
        point_array.push(map.layerPointToLatLng(L.point(xy_array[i][0] * width_rate, xy_array[i][1] * height_rate)))
    }

    if (point_array.length < 4) {
        if(item_type) {
            if(Number(restorations_original_shape) !== width_rate) {
                dimension = dimension / Number(restorations_original_shape)
                dimension = dimension * width_rate;
            }
            if(item_type == "implant") {
                implantIcon.options.iconSize[0] = Number(dimension);
                implantIcon.options.iconSize[1] = Number(dimension);
                var implantMarker = L.marker(point_array[0],{
                    icon: implantIcon,
                }).addTo(map);
            }else {
                crownIcon.options.iconUrl = '/static/img/crown-teeth/'+'crown' +"-"+icon_id + '.png';
                crownIcon.options.iconSize[0] = Number(dimension);
                crownIcon.options.iconSize[1] = Number(dimension);
                var crownMarker = L.marker(point_array[0],{
                    icon: crownIcon,
                }).addTo(map);
            }
            $(".leaflet-interactive").last().attr({
                    "data-slug" : data_slug
                });
            var implantRotateValue = rotate;
            degree = implantRotateValue;
            $(".leaflet-interactive").last().addClass("active_impcrw_img");
            var nowTransform = $(".active_impcrw_img")[0].style.transform.split("rotate")[0];
            $(".active_impcrw_img").css('transform', nowTransform + " rotate(" + implantRotateValue + "deg)");
            $(".active_impcrw_img").css('-moz-transform-origin', '50% 50%');
            $(".active_impcrw_img").css('-webkit-transform-origin', '50% 50%');
            $(".active_impcrw_img").css('-o-transform-origin', '50% 50%');
            $(".active_impcrw_img").css('-ms-transform-origin', '50% 50%');
            $(".leaflet-interactive").last().removeClass("active_impcrw_img");
            impCrwnTotalEditFunc();
        } else if(data_pointer == "false") {
            var circleMarker = L.circleMarker(point_array[0]).addTo(map).setStyle({
                color: "#000000",
                fill: true,
                fillColor: colorCode,
                fillOpacity: 1,
                opacity: 1,
                radius: 1.5,
                repeatMode: false,
                stroke: true,
                weight: 1
            });
            $("#back-img-frame svg path").last().attr("data-circle-name", data_illness_name)
            $("#back-img-frame svg path").last().addClass("path_circle")
            // allPoints.push(data_illness_name)
            // if(getPointCategoryByPoint(data_illness_name)) {
            //     $("#back-img-frame svg path").last().attr("data-point-category",getPointCategoryByPoint(data_illness_name))
            // }
            return null
        }else {
            if(data_pointer > 3) {
                dataPointDrawer(point_array[0],point_array[1],measurement_position,is_healthy = false);
            }else {
                dataPointDrawer(point_array[0],point_array[1],measurement_position,is_healthy = true);
            }
        }

    } else if (is_poly) {
        var poly = L.polygon(point_array).addTo(map).setStyle({
            color: colorCode,
            fill: true,
            fillOpacity: 0.3,
            weight: 0,
            stroke: false
        });
        $(".leaflet-interactive").last().attr({
            "data-slug" : data_slug,
            "data-illness-name" : data_illness_name,
            "data-proba-val" : data_illness_proba,
            "data-pointer-events": data_pointer,
            "data-approve-status": data_approve_status});
        $(".leaflet-interactive").last().addClass("drawsElement");
    } else if (is_polynomial) {
        L.polyline(point_array).addTo(map).setStyle({
            color: colorCode,
            fill: true,
            fillOpacity: 0.3,
            weight: 0,
            stroke: false
        });
    } else if (tooth_card_status){
        L.rectangle(point_array).addTo(map).setStyle({
            // color: "transparent",
            color: colorCode,
            fill: true,
            fillOpacity: 0,
            weight: 1,
        });
        $(".leaflet-interactive").last().attr({"tooth-name" : data_illness_name});
        $(".leaflet-interactive").last().addClass("toothCardElement");
        var data_ilness_name_list;
        var data_illness_proba_list;
        var data_illness_slug_list;
        var data_illness_approve_list;
        for (let i = 0; i < illness_list.length; i++) {
            if(i === 0) {
                data_ilness_name_list = illness_list[i]["name"];
                data_illness_proba_list = illness_list[i]["probability"];
                data_illness_slug_list = illness_list[i]["slug"];
                data_illness_approve_list = illness_list[i]["approve_status"];
            }else {
                data_ilness_name_list += "*" + illness_list[i]["name"];
                data_illness_proba_list += "*" + illness_list[i]["probability"];
                data_illness_slug_list += "*" + illness_list[i]["slug"];
                data_illness_approve_list += "*" + illness_list[i]["approve_status"];
            }

        }
        $(".leaflet-interactive").last().attr({
                "data-illness-name" : data_ilness_name_list,
                "data-illness-proba" : data_illness_proba_list,
                "data-illness-slug" : data_illness_slug_list,
                "data-illness-approve" : data_illness_approve_list}
            )
    } else {
        L.rectangle(point_array).addTo(map).setStyle({
            color: colorCode,
            fill: true,
            fillOpacity: 0.3,
            weight: 0,
            stroke: false
        });
    }

    function dataPointDrawer(point_array1,point_array2,measurement_position, is_healthy) {
        if(!is_healthy) {
            var point1 = L.circleMarker(point_array1).addTo(map).setStyle({
            color: '#FF5050',
            fill: true,
            fillColor: '#FF5050',
            fillOpacity: 1,
            opacity: 1,
            radius: 4,
            repeatMode: false,
            stroke: true,
            weight: 1
        });
        var point2 = L.circleMarker(point_array2).addTo(map).setStyle({
            color: '#FF5050',
            fill: true,
            fillColor: '#FF5050',
            fillOpacity: 1,
            opacity: 1,
            radius: 4,
            repeatMode: false,
            stroke: true,
            weight: 1
        });
            var line = L.polyline([point1.getLatLng(), point2.getLatLng()], {color: '#FF5050', weight: 2}).addTo(map);
            var latlng1 = point1.getLatLng();
            var latlng2 = point2.getLatLng();

            if(measurement_position == "right_points") {
                var midLatLng = L.latLng((latlng1.lat + latlng2.lat) / 2, ((latlng1.lng + latlng2.lng) - 0.08)  / 2);
                var textMarker = L.marker(midLatLng, {
                    icon: L.divIcon({
                        className: 'text-label-healthy',
                        html: data_pointer.toFixed(2) + 'mm',
                        iconSize: [50, 20]
                    })
                }).addTo(map);
            }else {
                var midLatLng = L.latLng((latlng1.lat + latlng2.lat) / 2, ((latlng1.lng + latlng2.lng) + 0.1)  / 2);
                var textMarker = L.marker(midLatLng, {
                    icon: L.divIcon({
                        className: 'text-label-healthy',
                        html: data_pointer.toFixed(2) + 'mm',
                        iconSize: [50, 20]
                    })
                }).addTo(map);
            }

        }else {
            var point1 = L.circleMarker(point_array1).addTo(map).setStyle({
            color: "#5bff58",
            fill: true,
            fillColor: '#5bff58',
            fillOpacity: 1,
            opacity: 1,
            radius: 4,
            repeatMode: false,
            stroke: true,
            weight: 1
        });
        var point2 = L.circleMarker(point_array2).addTo(map).setStyle({
            color: "#5bff58",
            fill: true,
            fillColor: '#5bff58',
            fillOpacity: 1,
            opacity: 1,
            radius: 4,
            repeatMode: false,
            stroke: true,
            weight: 1
        });
            var line = L.polyline([point1.getLatLng(), point2.getLatLng()], {color: '#5bff58', weight: 2}).addTo(map);
            var latlng1 = point1.getLatLng();
            var latlng2 = point2.getLatLng();

            if(measurement_position == "right_points") {
                var midLatLng = L.latLng((latlng1.lat + latlng2.lat) / 2, ((latlng1.lng + latlng2.lng) - 0.08)  / 2);
                var textMarker = L.marker(midLatLng, {
                    icon: L.divIcon({
                        className: 'text-label-unhealthy',
                        html: data_pointer.toFixed(2) + 'mm',
                        iconSize: [50, 20]
                    })
                }).addTo(map);
            }else {
                var midLatLng = L.latLng((latlng1.lat + latlng2.lat) / 2, ((latlng1.lng + latlng2.lng) + 0.1)  / 2);
                var textMarker = L.marker(midLatLng, {
                    icon: L.divIcon({
                        className: 'text-label-unhealthy',
                        html: data_pointer.toFixed(2) + 'mm',
                        iconSize: [50, 20]
                    })
                }).addTo(map);
            }
        }

        point1.bringToFront();
        point2.bringToFront();
        $(point1._path).attr("data-illness-name","Alveolar Bone Loss");
        $(point2._path).attr("data-illness-name","Alveolar Bone Loss");
        $(line._path).attr("data-illness-name","Alveolar Bone Loss");
        $(textMarker._path).attr("data-illness-name","Alveolar Bone Loss");

        alveoler_bone_point.push(point1);
        alveoler_bone_point.push(point2);
        return null

    }
    // SAYFA RESİZE KAYMA KODLARI SİLME
    // paths = $("g")[0].children
    // paths_d.push(paths[paths.length-1].attributes.d.value)
}
    var original_shape
    function draw_function(res) {
        // console.log("DRAW FUNCTION ÇALIŞIYOR")
        let illness_coords_colors = res['illness_coords_colors']
        let measurement_results = res['measurement_results']
        let tooth_illness_coords = res['tooth_illness_coords']
        let restorations = res['restorations']
        // console.log("illness_coords_colors", illness_coords_colors)
        // console.log("measurement_results", measurement_results)
        // console.log("tooth_illness_coords", tooth_illness_coords)
        var imageElement = document.getElementById("back-img"); // Resmin HTML öğesini seçin veya uygun bir seçici kullanın
        var originalHeight = imageElement.naturalHeight;
        var originalWidth = imageElement.naturalWidth;
        original_shape = {width_rate: $("#back-img").width() / originalWidth, height_rate: ($("#back-img").height()) / originalHeight, bitewing_status: false}
        g_original_shape = original_shape;
        map.eachLayer((layer) => {
            layer.remove();
        });
        if (illness_coords_colors) {
            for (let i = 0; i < illness_coords_colors.length; i++) {
                drawWithCoordinates(
                    original_shape,
                    illness_coords_colors[i]['coords'],
                    illness_coords_colors[i]['color'],
                    true,
                    false,
                    illness_coords_colors[i]['name'],
                    illness_coords_colors[i]['proba'],
                    false,
                    null,
                    illness_coords_colors[i]['data-pointer'],
                    false,
                    illness_coords_colors[i]['approve_status'],
                    illness_coords_colors[i]['slug']
                    );
                // ilk çizdirmede tüm hastalıkları çizen if
            }
        }
        // console.log("@@@@@@@@@",illness_coords_colors,tooth_illness_coords)
        if (tooth_illness_coords) {
            // hastalığın çizdirmesini ekleme çıkarma ifi
            for (let i = 0; i < tooth_illness_coords.length; i++) {
                // tooth_illness_coords[i]["illness"].map(item=>console.log("itms : ", item.approve_status))
                if(illness_coords_colors.length > 0 ) {
                    drawWithCoordinates(
                    original_shape,
                    tooth_illness_coords[i]['coordinates'],
                    false,
                    false,
                    false,
                    tooth_illness_coords[i]["tooth_number"],
                    tooth_illness_coords[i]['probability'],
                    true,
                    tooth_illness_coords[i]["illness"],
                    illness_coords_colors[0]['data-pointer'],
                    false,
                    illness_coords_colors[0]['approve_status'],
                    );
                }else {
                    drawWithCoordinates(
                    original_shape,
                    tooth_illness_coords[i]['coordinates'],
                    false,
                    false,
                    false,
                    tooth_illness_coords[i]["tooth_number"],
                    tooth_illness_coords[i]['probability'],
                    true,
                    tooth_illness_coords[i]["illness"],
                    false,
                    false,
                    false,
                    );
                }

            }
        }

        if (measurement_results) {
            for (let i = 0; i < measurement_results.length; i++) {
                drawWithCoordinates(
                    original_shape,
                    measurement_results[i]['coordinates'],
                    measurement_results[i]['color'],
                    false,
                    false,
                    measurement_results[i]['label_tr_name'],
                    null,
                    false,
                    null,
                    measurement_results[i]['measure'],
                    measurement_results[i]['position'],
                    false,
                    );
                // ilk çizdirmede tüm hastalıkları çizen if
            }
        }
        if (restorations) {
            for (let i = 0; i < restorations.length; i++) {
                drawWithCoordinates(
                    original_shape,
                    [JSON.parse(restorations[i]['coordinate'])],
                    false,
                    false,
                    false,
                    false,
                    null,
                    false,
                    null,
                    false,
                    false,
                    false,
                    restorations[i]['slug'],
                    restorations[i]['dimension'],
                    restorations[i]['rotate'],
                    restorations[i]['icon_id'],
                    restorations[i]['item_type'],
                    restorations[i]['original_shape'],
                    );
            }
        }
        var leafs = $(".leaflet-interactive")
        for (let i = 0; i < leafs.length; i++) {
            if(parseInt($(leafs[i]).attr("data-proba-val")) == 101) {
                $(leafs[i]).attr({
                    "stroke-dasharray": "0",
                    "data-pointer-events": ""
                });
            }else {
                leafs[i].classList.remove("leaflet-interactive");
            }
        }
        $("#loading").hide()
        toggleMapPopup()
        map.addLayer(editableLayers);
    }
</script>

<script>
    var checkboxes = document.querySelectorAll('.title:not(.empty) input[type="checkbox"]');
    var selectAllCheckbox = document.querySelector('[data-select-all-diagnosis]');
    var selectedItems = [];
    var selectedItemsCount = 0;

    $(".title input[type='checkbox']").click(function(event){
        event.stopPropagation();
        $(this).closest('.title').next('.child-view').find('input[type="checkbox"]').prop('checked', this.checked);
    });

    $(".tree-view .title").click(function(event){
        if ($(event.target).is('input[type="checkbox"]')) {
            event.stopPropagation();
            return;
        }
        $(this).next(".child-view").toggleClass("d-block");
    });

    function updateSelectedItems() {
        selectedItems = [];
        checkboxes.forEach(function (checkbox) {
            if (checkbox.checked) {
                var label = checkbox.parentNode.nextElementSibling;
                selectedItems.push(label.getAttribute('data-disease-name'));
            }
        });
    }

    checkboxes.forEach(function (checkbox) {
        checkbox.addEventListener('change', function () {

            updateSelectedItems();

            // AJAX isteğini burada gerçekleştir
            // sendAJAXRequest(selectedItems); //önceden her bir etiket açma kapama işlemi olduğunda api isteği atılıyordu, daha hızlı olması için ön tarafdan bu işlemin yapılması üzere kapatıldı
            prepareiIllnessForDraw(selectedItems)
        });

        if (checkbox.checked) {
            var label = checkbox.parentNode.nextElementSibling;
            selectedItems.push(label.textContent);
        }
    });

    try {
        selectAllCheckbox.addEventListener('change', function () {
            if (this.checked) {
                $(".diagnosis-content .item:not(.empty) input[type='checkbox']").prop('checked', true);
            } else {
                $(".diagnosis-content .item:not(.empty) input[type='checkbox']").prop('checked', false);
            }
            updateSelectedItems();
            prepareiIllnessForDraw(selectedItems)
            // AJAX isteğini burada gerçekleştir
            // sendAJAXRequest(selectedItems); //önceden her bir etiket açma kapama işlemi olduğunda api isteği atılıyordu, daha hızlı olması için ön tarafdan bu işlemin yapılması üzere kapatıldı
        });
    } catch (error) {
        console.log(error)
    }

    

    // Sayfa yüklendikten sonra hemen AJAX isteğini gerçekleştir
    updateSelectedItems();
    var currentLanguageForDraw = window.location.href.includes("/en/") ? "en" : window.location.href.includes("/uz/") ? "uz" : window.location.href.includes("/ru/") ? "ru" : window.location.href.includes("/nl/") ? "nl" : "tr"
    function sendAJAXRequest(selectedItems) {
        $.ajax({
            url: "/api/illness-draw/?image_report_id=" + image_report_id + "&illness_list=" + selectedItems+ "&lang=" +currentLanguageForDraw,
            method: "GET",
            data: {selectedItems, image_report_id},
            success: function (response) {
                draw_function(response)
            },
            error: function (xhr, status, error) {
            }
        });
    }

    function prepareiIllnessForDraw(selectedItems) {
        // console.log("diagnosis_labels", diagnosis_labels);

        // diagnosis_labels'ın kopyasını oluşturmak
        var new_diagnosis_labels = Object.assign({}, diagnosis_labels);

        // Veriyi kopyalayarak yeni bir dizi oluştur
        let new_illness_coords_colors = [...new_diagnosis_labels.illness_coords_colors];
        // console.log("selectedItems", selectedItems);

        // Seçilen öğeleri filtreleyerek kopyalanan diziden çıkar
        new_illness_coords_colors = new_illness_coords_colors.filter(label_dict => selectedItems.includes(label_dict.name));

        // console.log("new_illness_coords_colors", new_illness_coords_colors);
        new_diagnosis_labels["illness_coords_colors"] = new_illness_coords_colors;
        // console.log("new_diagnosis_labels", new_diagnosis_labels);
        draw_function(new_diagnosis_labels)
    }
    selectedItemsCount = selectedItems.length
</script>

<!--ZOOM IN ZOOM OUT MAUSE WHELL-->
<script>
    var scale = 1,
        panning = false,
        pointX = 0,
        pointY = 0,
        start = {x:0, y:0},
        zoomElement = document.getElementById("back-img-frame"),
        maxScale = 9, // maksimum yakınlaştırma düzeyi
        minScale = 1; // minimum yakınlaştırma düzeyi

    function setTransform(){
        zoomElement.style.transform = "translate("+pointX+"px,"+pointY+"px) scale("+scale+")";
    }

    zoomElement.onmousedown = function(e){
        e.preventDefault();
        start = {x: e.clientX - pointX, y:e.clientY - pointY}
        // panning = true;
    }

    zoomElement.onmouseup = function(e) {
        panning = false;
    }

    zoomElement.onmousemove = function(e){
        if(!panning){
            return;
        }
        pointX = (e.clientX - start.x)
        pointY = (e.clientY - start.y)
        setTransform()
    }

    zoomElement.onwheel = function(e) {
        e.preventDefault();


        if($("#drawTeethBoxesDraw").is(":checked")) {
            // eğer ki diş numaraları açıksa kapat bitince geri açarsın
            $("#drawTeethBoxesDraw").click()
        }
        var xs = (e.clientX - pointX) / scale,
            ys = (e.clientY - pointY) / scale,
            delta = (e.wheelDelta ? e.wheelDelta : -e.deltaY),
            prevScale = scale;

        (delta > 0) ? (scale *= 1.1) : (scale /= 1.1);

        // Yakınlaştırma sınır kontrolü
        if (scale > maxScale) {
            scale = maxScale;
        } else if (scale < minScale) {
            scale = minScale;
        }

        pointX = e.clientX - xs * scale;
        pointY = e.clientY - ys * scale;

        // Yakınlaştırma düzeyi değiştiyse transform işlemini gerçekleştir
        if (scale !== prevScale) {
            setTransform();
        }
    }

</script>

<script>
    var image_report_id = {{image_report_id}}
    
    draw_leaflet()
    function draw_leaflet() {
        var currentLanguageForDraw = window.location.href.includes("/en/") ? "en" : window.location.href.includes("/uz/") ? "uz" : window.location.href.includes("/ru/") ? "ru" : window.location.href.includes("/nl/") ? "nl" : "tr"
        $("#back-img-frame .loading").removeClass("d-none")
        $.ajax({
            url: "/api/illness-draw/?image_report_id=" + image_report_id+ "&first_draw=" + "True"+"&lang=" +currentLanguageForDraw,
            method: "GET",
            success: function (res) {
                diagnosis_labels = res
                if (res["status"] === "continues"){
                    $('#continues').removeClass("d-none")
                    $("#back-img-frame .loading").removeClass("d-none")
                    var intervalId = setInterval(function () {
                        $.ajax({
                            url: "{% url 'is_analyze_finished' %}", // İkinci isteğin gönderileceği URL'yi buraya ekleyin
                            method: "GET",
                            data: {image_report_id: image_report_id}, // İkinci isteğin verilerini burada belirtin
                            success: function (res) {
                                var divElement = document.querySelector(`div[data-image-id-div='${image_id}']`);
                                var divAElement = document.querySelector(`a[data-image-id='${image_id}']`);
                                var TextElement = document.querySelector(`a[data-image-id='${image_id}'] .not-completed`);
                                if (res.status === true && res.success === true) {
                                    // window.location.reload()

                                } else if (res.status === true && res.success === false) {
                                    clearInterval(intervalId)
                                    divElement.classList.add('error');
                                    divElement.classList.remove('spinner-border');
                                }
                            },
                            error: function (xhr, status, error) {
                                // İkinci isteğin hata durumunda yapılacak işlemleri burada gerçekleştirin
                            }
                        });
                    }, 3000);
                }else{
                    $("#back-img-frame .loading").addClass("d-none")
                    if($("#drawTeethBoxesDraw").is(":checked")) {
                        // draw teeth checkbox ı seçili ise önce kaldır zaten kalkık ise bişey olmaz ama sonradan da çizdirmen lazım
                        clearTeethDraw()
                        getCoordinatesAndDrawTeeth()
                    }
                    draw_function(res)
                }
            }
        })
    }
</script>

<script>
    function start_analyze(element) {
    var image_path = element.getAttribute("data-image-path");
    var image_id = element.getAttribute("data-image-id");
    $.ajax({
        url: "{% url 'startAnalyze' %}",
        method: "GET",
        data: {
        "image_report_id": image_report_id,
        "image_path": image_path,
        "image_id": image_id
        },
                success: function (res) {
        if (res["code"] === "analyse_limit_exceeded") {
            Swal.fire({
            position: 'top-end',
            icon: 'error',
            title: res["message"],
            showConfirmButton: false,
            timer: 3000
                        }).then(function () {
            window.location.href = "{% url 'profile_page' %}";
            });
        } else if (res["code"] === "package_expired") {
            Swal.fire({
            position: 'top-end',
            icon: 'error',
            title: res["message"],
            showConfirmButton: false,
            timer: 3000
                        }).then(function () {
            window.location.href = "{% url 'profile_page' %}";
            });
        } else if (res.status === true) {
            var divElement = document.querySelector(`div[data-image-id-div='${image_id}']`);
            // Class çıkarma
            divElement.classList.remove('error');
            // Class ekleme
            divElement.classList.add('spinner-border');

            var image_report_id = res["image_report_id"];
            // İkinci AJAX isteğini belirli aralıklarla göndermek için setInterval kullanın
            var intervalId = setInterval(function () {
            $.ajax({
                url: "{% url 'is_analyze_finished' %}", // İkinci isteğin gönderileceği URL'yi buraya ekleyin
                method: "GET",
                data: {image_report_id: image_report_id}, // İkinci isteğin verilerini burada belirtin
                success: function (res) {
                    var divElement = document.querySelector(`div[data-image-id-div='${image_id}']`);
                    var divAElement = document.querySelector(`a[data-image-id='${image_id}']`);
                    var TextElement = document.querySelector(`a[data-image-id='${image_id}'] .not-completed`);
                    if (res.status === true && res.success === true) {
                        clearInterval(intervalId)
                        divElement.classList.add('success');
                        divElement.classList.remove('spinner-border');
                        divAElement.setAttribute('href', `/diagnosis/${image_report_id}`);
                        TextElement.classList.remove("not-completed")
                        TextElement.classList.add("completed")
                    } else if (res.status === true && res.success === false) {
                        clearInterval(intervalId)
                        divElement.classList.add('error');
                        divElement.classList.remove('spinner-border');
                    }
                },
                error: function (xhr, status, error) {
                    // İkinci isteğin hata durumunda yapılacak işlemleri burada gerçekleştirin
                }
            });
            }, 3000); // 3 saniyede bir isteği tekrarlayacak şekilde ayarlayın
        }
        },
        error: function (xhr, status, error) {
        }
    });
    }

</script>

<script>
    var csrfmiddlewaretoken = $('input[name=csrfmiddlewaretoken]').val();
    var image_report_id = {{image_report_id}}
</script>

<script>
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))

    try {
            var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
            var target = document.querySelector(tooltipTriggerEl.dataset.bsTarget)

            return new bootstrap.Tooltip(tooltipTriggerEl, {
                title: target.innerHTML,
                html: true
            })
        })
    }catch (e) {
    }

</script>

<script>
    var dimensionChange = false;
    $("[data-event-type='collapse-section']").click(function (event) {
        // radyografiyi büyültüp küçültür
        $(".teeth-and-treatment-section").toggleClass("active ")
        $("[data-event-type='collapse-section'] i").toggleClass("active")
        $("svg.leaflet-zoom-animated").remove()
        $("#back-img-frame .loading").removeClass("d-none")
        if($(".teeth-and-treatment-section").hasClass("active")) {
            setTimeout(function() {
               $(".tooth-chart-illnesses-by-tooth").css("opacity", "1")
            }, 500)
        } else {
            $(".tooth-chart-illnesses-by-tooth").css("opacity", "0")
        }
        setTimeout(function (){
            draw_leaflet();
            if(!dimensionChange) {
                dimensionChange = true;
            }else {
                dimensionChange = false;
            }
        },500)
    })
    $("[data-event-type='collapse-section-diagnosis-list']").click(function (event) {
        // radyografiyi büyültüp küçültür
        $("svg.leaflet-zoom-animated").remove()
        $("#back-img-frame .loading").removeClass("d-none")
        let diagnosis_area = $(".diagnosis-content")
        let collapseIcon = $(".collapse-icon")
        $(".diagnosis-content-wrapper").toggleClass("expand")

        if($(".diagnosis-content-wrapper").hasClass("expand")){
            collapseIcon.removeClass('fa-angles-left').addClass('fa-angles-right');
        }else{
            collapseIcon.removeClass('fa-angles-right').addClass('fa-angles-left');

        }

        setTimeout(function (){
            draw_leaflet();
            if(!dimensionChange) {
                dimensionChange = true;
            }else {
                dimensionChange = false;
            }
        },500)
    })

    $(".see-all-teeth-detail").click(function (event) {
        $(".tooth .item").removeClass("active")
        if($(event.target).attr("data-eye") === "open") {
            // hastalıklar gösteriliyor artık kapat
            $(event.target).attr("data-eye","close").removeClass("fa-eye-slash").addClass("fa-eye")
            $(".tooth-detail").css("display","none")
        } else {
            // hastalıklar gösterilmiyor onları aç
            $(event.target).attr("data-eye","open").removeClass("fa-eye").addClass("fa-eye-slash")
            $(".tooth-detail").css("display","block")
        }
    })
</script>

<script>
    function toggleDropSection(event) {
        // aşağıdan açılır menünün açılıp kapanmasını sağlayan fonksiyon
        let dropSection = $("#bottom-drop-section")
        let iconSection = $(event.target)
        dropSection.toggleClass("active")
        iconSection.toggleClass("active")
    }
</script>


<script>
    function approve_status_change(event) {
        let data_id = event.target.getAttribute("data-id")
        let image_report_id = {{image_report_id}}
        var iconStatus = event.target.getAttribute('data-icon-status');
        var approveStatus = event.target.getAttribute('data-approve-status');
        let parentElement = event.target.parentElement;


        // AJAX ile sunucuya yeni onay durumunu gönderme
        if (iconStatus === '1') {
            if (approveStatus === '1') {
                approveStatus = '0';  // Beğeni durumunu geri almak için 0
            } else {
                approveStatus = '1';  // Beğenme durumunu ayarlamak için 1
            }
        } else if (iconStatus === '2') {
            if (approveStatus === '2') {
                approveStatus = '0';  // Beğenmeme durumunu geri almak için 0
            } else {
                approveStatus = '2';  // Beğenmeme durumunu ayarlamak için 2
            }
        }

       $.ajax({
            type: "POST",
            url: "{% url 'changetoothapprovedstatusviewApi' %}",
            data: {
                csrfmiddlewaretoken: $('input[name=csrfmiddlewaretoken]').val(),
                data_id: data_id,
                data_approve_status: approveStatus,
                image_report_id: image_report_id
            },
            success: function (response) {
                let newApproveStatus = response["new_approve_status"]
                let otherIcons = parentElement.querySelectorAll('[data-approve-status]'); // istek başarılı geldiğinde istekten dönen new_approve statusu ikonların ikisi için de güncelliyoruz
                //foreach ile ikon sayısı ilerde artarsa her ikonun data-approve-status değerini viewden dönen sonuçla güncellemiş olacağız
                let approveIcon = parentElement.querySelector('[data-icon-status="1"]');
                let rejectIcon = parentElement.querySelector('[data-icon-status="2"]');
                otherIcons.forEach(function(icon) {
                    icon.setAttribute('data-approve-status', newApproveStatus);
            });
                if (response["new_approve_status"] === "1"){
                    event.target.src = "{% static 'img/like-active.png' %}"
                    rejectIcon.src = "{% static 'img/dislike.png' %}"
                }
                else if (response["new_approve_status"]==="2"){
                    event.target.src = "{% static 'img/like-passive.png' %}"
                    approveIcon.src = "{% static 'img/like.png' %}"
                }
                else{
                    rejectIcon.src = "{% static 'img/dislike.png' %}"
                    approveIcon.src = "{% static 'img/like.png' %}"
                }
            },
            error: function (xhr, status, error) {
                alert("An error occurred: " + error); // Hata durumunda bir uyarı mesajı gösteriliyor.
            }
        });
    }
</script>

<script>
    function save_tooth_note(event) {
        let tooth = event
        let tooth_note = $(`#tooth_note_${tooth}`).val()
        let image_report_id = {{image_report_id}}
        $.ajax({
            type: "POST",
            url: "{% url 'saveToothNoteApi' %}",
            data: {
                csrfmiddlewaretoken: $('input[name=csrfmiddlewaretoken]').val(),
                tooth_number: tooth,
                tooth_note: tooth_note,
                image_report_id: image_report_id,
            },
            success: function (response) {
                if (response["status"] === true) {
                    Toastify({
                        text: "{% trans 'Success' %}",
                        gravity: "bottom", // `top` or `bottom`
                        position: "right", // `left`, `center` or `right`
                        duration: 3000,
                        backgroundColor: "green",
                        icon: "<i class='fa-solid fa-check'></i>"
                    }).showToast();
                } else {
                    Toastify({
                        text: "{% trans 'Error' %}",
                        gravity: "bottom", // `top` or `bottom`
                        position: "right", // `left`, `center` or `right`
                        duration: 3000,
                        backgroundColor: "red",
                        icon: "<i class='fa-solid fa-xmark'></i>"
                    }).showToast();
                }
            },
            error: function (xhr, status, error) {
                alert("An error occurred: " + error); // Hata durumunda bir uyarı mesajı gösteriliyor.
            }
        });
    }
</script>

<script>
    function tools() {
        let zoom = 1
        let map = $('#back-img-frame')
        let mapImg = $("img#back-img")

        function contrastReset() {
            mapImg.css("filter", "contrast(100%)")
            $("#contrast-btn").nextAll('.range-marker').first().css("left", "20%");
            $("#contrast-btn").nextAll('.range-value').first().css("width", "20%");
            $("#contrast-value").html("+100");
        }

        function brightnessReset() {
            mapImg.css("filter", "brightness(100%)")
            $("#brightness-btn").nextAll('.range-marker').first().css("left", "33.3%");
            $("#brightness-btn").nextAll('.range-value').first().css("width", "33.3%");
            $("#brightness-value").html("+100");
        }

        // zoom + butonuna tıklayınca zoom işlemi yapar
        $("#zoomin-btn").click(function() {
            if(zoom <= 3) {
                // zoom 3 katı kadar yapsın en fazla
                zoom += 0.1;
                map.css('transform', `scale(${zoom})`);
                if($("#drawTeethBoxesDraw").is(":checked")) {
                    $("#drawTeethBoxesDraw").click() // eğer ki diş numaraları açıksa kapat
                }
            }
        })

        // zoom - butonuna tıklayınca zoom işlemi yapar
        $("#zoomout-btn").click(function() {
            if(zoom >= 0.5) {
                // zoom yarıya kadar yapsın en fazla
                zoom -= 0.1;
                map.css('transform', `scale(${zoom})`);
                if($("#drawTeethBoxesDraw").is(":checked")) {
                    $("#drawTeethBoxesDraw").click() // eğer ki diş numaraları açıksa kapat
                }
            }
        })

        // zoom contrast ve parlaklık sıfırla
        $("#reset-btn").click(function() {
            zoom = 1
            map.css('transform', `scale(${zoom})`);
            contrastReset()
            brightnessReset()
        })


        // contrast değerini değiştir
        $("#contrast-btn").on("input", function() {
            var contrastValue = this.value;
            var contrastCSS = 'contrast(' + contrastValue + '%)';
            $("#contrast-value").html(contrastValue != 0 ? `+ ${contrastValue}` : 0);
            mapImg.css("filter", contrastCSS)
            $(this).nextAll('.range-marker').first().css("left", `${contrastValue / 5}%`);
            $(this).nextAll('.range-value').first().css("width", `${contrastValue / 5}%`);
        })

        // brightness değerini değiştir
        $("#brightness-btn").on("input", function() {
            var brightnessValue = this.value;
            var brightnessCSS = 'brightness(' + brightnessValue + '%)';
            $("#brightness-value").html(brightnessValue != 0 ? `+ ${brightnessValue}` : 0);
            mapImg.css("filter", brightnessCSS)
            $(this).nextAll('.range-marker').first().css("left", `${brightnessValue / 3}%`);
            $(this).nextAll('.range-value').first().css("width", `${brightnessValue / 3}%`);
        })

        $("#dimension-btn").on("input", function() {
            var dimensionValue = parseInt(this.value * g_original_shape.width_rate);
            $(this).nextAll('.range-marker').first().css("left", `${dimensionValue / 3}%`);
            $(this).nextAll('.range-value').first().css("width", `${dimensionValue / 3}%`);
            $("#dimensionValue").text(dimensionValue)
            $(".active_impcrw_img")[0].style.width = dimensionValue + 'px';
            $(".active_impcrw_img")[0].style.height = dimensionValue + 'px';
            $(".leaflet-pane.leaflet-marker-pane i.delete-icon").remove()
            
        })

        $("#dimension-btn").on("mouseup",function() {
            updateImpCrown($(".active_impcrw_img").attr("data-slug"));
        })
        
        $("#rotate-implant-btn").on("input", function() {
            var implantRotateValue = parseInt(this.value);
            degree = implantRotateValue;
            $(this).nextAll('.range-marker').first().css("left", `${implantRotateValue / 3.6}%`);
            $(this).nextAll('.range-value').first().css("width", `${implantRotateValue / 3.6}%`);
            $("#rotateImplantValue").text(implantRotateValue)
            var nowTransform = $(".active_impcrw_img")[0].style.transform.split("rotate")[0];
            $(".active_impcrw_img").css('transform', nowTransform + " rotate(" + implantRotateValue + "deg)");
            $(".active_impcrw_img").css('-moz-transform-origin', '50% 50%');
            $(".active_impcrw_img").css('-webkit-transform-origin', '50% 50%');
            $(".active_impcrw_img").css('-o-transform-origin', '50% 50%');
            $(".active_impcrw_img").css('-ms-transform-origin', '50% 50%');
        })

        $("#rotate-implant-btn").on("mouseup",function() {
            updateImpCrown($(".active_impcrw_img").attr("data-slug"));
        })

        $("#download-btn").click(function() {

            $.ajax({
                url: "{% url 'downloadDrawedRadiographyButton' %}", // Post isteği yapılacak URL'yi buraya ekleyin
                type: 'GET',
                data: {
                    csrfmiddlewaretoken: csrfmiddlewaretoken,
                    image_report_id: image_report_id,
                }, // Seçilen öğeleri 'selected_items' adıyla gönderin
                success: function (res) {
                    if (res["status"] === "True"){
                        let yol = res["output_path"]
                        // console.log("output", yol)
                        var link = document.createElement('a');
                        // let yol = mapImg.attr("src")
                        link.href = yol; // Resmin URL'sini buraya ekleyin
                        link.download = yol; // İndirilecek dosya adını buraya ekleyin
                        link.target = '_blank'; // Yeni sekmede açmak için "_blank" kullanın
                        link.click();
                    }
                    // Başarılı yanıt durumunda yapılacak işlemler
                },
                error: function (xhr, status, error) {
                    // Hata durumunda yapılacak işlemler
                }
            });
        })

    }

    tools()
</script>

<script>
    function sendSelectedItems(event) {
        var selectedItems = []; // Seçilen öğeleri depolamak için bir dizi oluşturun
        var checkboxes2 = document.getElementsByClassName('weekstrong-checkbox'); // Checkbox öğelerini seçin
        var csrfmiddlewaretoken = $('input[name=csrfmiddlewaretoken]').val();
        // Checkbox öğelerini döngüyle kontrol edin
        for (var i = 0; i < checkboxes2.length; i++) {
            var checkbox = checkboxes2[i];
            if (checkbox.checked) {
                selectedItems.push(checkbox.getAttribute('data-type')); // İşaretlenen öğeyi diziye ekleyin
            }
        }
        // Seçilen öğeleri post etmek için Ajax isteği gönderin
        $.ajax({
            url: "{% url 'illnessDraw' %}", // Post isteği yapılacak URL'yi buraya ekleyin
            type: 'GET',
            data: {
                selected_items: selectedItems,
                csrfmiddlewaretoken: csrfmiddlewaretoken,
                image_report_id: image_report_id,
                first_draw: "True"
            }, // Seçilen öğeleri 'selected_items' adıyla gönderin
            success: function (res) {
                if (res["status"] === "continues"){

                }
                // Başarılı yanıt durumunda yapılacak işlemler
                draw_function(res)
            },
            error: function (xhr, status, error) {
                // Hata durumunda yapılacak işlemler
            }
        });
    }

    // Checkboxların değişikliklerini dinlemek için event listener ekleyin
    var checkboxes2 = document.getElementsByClassName('weekstrong-checkbox');
    for (var i = 0; i < checkboxes2.length; i++) {
        checkboxes2[i].addEventListener('change', sendSelectedItems);
    }
</script>

<script>
    var toothNumber; // toothNumber değişkenini global olarak tanımladım
    function setDiagnosisId(tooth_number) {
        $("#modal-add-diagnosis").attr("data-tooth-number", tooth_number)
        toothNumber = tooth_number; // toothNumber değerini aşağıdaki scriptte kullanmak üzere güncelledim
    }
    //tedavi ekle butonuna tıklandıktan sonra açılacak olan modalın içeriğini gelen datadan çekme ve modala gönderme kısmı
    function setTreatmentId(tooth_number) {
        $("#modal-add-treatment").attr("data-tooth-number", tooth_number)
        toothNumber = tooth_number;
        var treatmentRecommendation = {{treatment_recommendation_manual|safe}}

        // var treatmentMethods = treatmentRecommendation[toothNumber].treatment_methods;
        var treatmentMethods = treatmentRecommendation.treatment_methods;
        let items = "" //modala eklenecekler
        let spanItems = "" //modal kapandıktan sonra dişlere eklenecekler
        treatmentMethods.forEach(function(method){
            items+= `
                <div class="patient-item px-2 mb-2 rounded align-items-center" style="background-color: #2B3863; display: flex;">
                    <div class="checkbox d-flex">
                        <input type="checkbox" name="AddTreatment" slug="${method.slug}" id="${method.slug}">
                        <i class="fa-solid fa-check"></i>
                    </div>
                    <label for="${method.slug}" class="w-100 py-2 ps-2 m-0 patient-text" slug="${method.slug}" data-treatment-name="{% if '/tr/' in request.path %} ${method.tr_treatment_method}" style="user-select: none">${method.tr_treatment_method} {% elif '/uz/' in request.path %} ${method.uz_treatment_method}" style="user-select: none">${method.uz_treatment_method} {% elif '/ru/' in request.path %} ${method.ru_treatment_method}" style="user-select: none">${method.ru_treatment_method} {% elif '/nl/' in request.path %} ${method.nl_treatment_method}" style="user-select: none">${method.nl_treatment_method}{% else %} ${method.en_treatment_method}" style="user-select: none">${method.en_treatment_method} {% endif %}</label>
                </div>
            `

        })
        $("#modalAddTreatment").html(items)
        // var treatmentMethods = treatment_recommendation[tooth_number].treatment_methods;
        // console.log("methods",treatmentMethods)

    }
</script>

<script>
    var allPoints = [];
    $(document).ready(function() {

        // CSRF token değerini al
        var csrfToken = $('input[name=csrfmiddlewaretoken]').val();

        $('.save-diagnosis').on('click', function() {
            var selectedIllnesses = [];
            // toothNumber = $('#modal-add-diagnosis').data('tooth-number');

            // İşaretlenen checkbox'ları toplayın
            $('input[name="AddDiagnosis"]:checked').each(function() {
                var illnessId = $(this).attr('id');
                selectedIllnesses.push(illnessId);
            });

            // AJAX isteği gönder
            $.ajax({
                url: "{% url 'add_diagnosis' %}",
                type: 'POST',
                headers: { 'X-CSRFToken': csrfToken },
                data: {
                    'selectedIllnesses[]': selectedIllnesses,
                    'image_type': "{{image_type}}",
                    'tooth_number': toothNumber,
                    'image_report_id':"{{image_report_id}}",
                },
                success: function(response) {
                    // console.log("kaydetme response u", response)
                    if(response.error){
                        Swal.fire({
                        position: 'top-end',
                        icon: 'error',
                    title: "{% trans 'The disease you are trying to add already exists' %}",
                        showConfirmButton: false,
                        timer: 3000
                        })
                        return false
                    }
                    else{
                        // Hastalık isimlerini al
                    var selectedIllnesses = response.selected_illnesses;
                    var toothNumber = response.tooth_number;

                    // Hastalık isimlerini HTML içeriğine ekle
                    var diseasesContainer = $('.tooth-detail[data-tooth-id="' + toothNumber + '"] .diseases');
                    var probability = response.probability
                    for (var i = 0; i < selectedIllnesses.length; i++) {
                    if (window.location.href.includes("/tr/")){
                            var illness = selectedIllnesses[i].tr_name;

                    }else if(window.location.href.includes("/uz/")){
                        var illness = selectedIllnesses[i].uz_name;

                    }
                    else if(window.location.href.includes("/ru/")){
                        var illness = selectedIllnesses[i].ru_name;

                    }else{
                        var illness = selectedIllnesses[i].en_name;
                        }

                        var probability = 'normal'; // Örnek bir varsayılan sınıf

                        // Hastalık olasılığına göre sınıf belirle
                        

                        // Hastalık ismi ve olasılığı içeren HTML'i ekle
                        // var html = '<span class="tooth-percent high">' + illness + "" + "(-)" + '</span>';
                        var html = `
                            <span class="delete-illness-parent">
                                ${illness}
                                <span 
                                    class="tooth-percent high" 
                                    data-delete-illness="${selectedIllnesses[i].en_name}" 
                                    data-tooth-id="${response.report_tooth_obj_id}" 
                                    data-tooth-number-for-illness-delete="${response.tooth_number}"
                                    data-illness-slug="${response.slug}"
                                    > (-) </span>
                            </span>`
                        diseasesContainer.append(html);
                    }
                        closeModal()
                    }
                    Swal.fire({
                    position: 'top-end',
                    icon: 'success',
                    title: "{% trans 'Diagnosis added successfully' %}",
                    showConfirmButton: false,
                    timer: 2000
                    })
                },
                error: function(xhr, status, error) {
                }
            });
        });
    });

</script>

<script>
    $(document).ready(function() {

        // CSRF token değerini al
        var csrfToken = $('input[name=csrfmiddlewaretoken]').val();

        $('#saveTreatment').on('click', function() {
            var selectedTreatments = [];
            let selectedTreatmentNames = [];
            // toothNumber = $('#modal-add-diagnosis').data('tooth-number');

            // İşaretlenen checkbox'ları toplayın
            $('input[name="AddTreatment"]:checked').each(function() {
                var treatmentSlug = $(this).attr('slug');
                let treatmentName = $(this).parent().next().attr('data-treatment-name')
                selectedTreatments.push(treatmentSlug);
                selectedTreatmentNames.push(treatmentName)
            });

            // AJAX isteği gönder
            $.ajax({
                url: "{% url 'add_treatment' %}",
                type: 'POST',
                headers: { 'X-CSRFToken': csrfToken },
                data: {
                    'selectedTreatments[]': selectedTreatments,
                    'image_type': "{{image_type}}",
                    'tooth_number': toothNumber,
                    'image_report_id':"{{image_report_id}}",
                },
                success: function(response) {
                    // console.log("res",response)
                    if (response.error === "already exists"){
                        swal.fire({
                            position: 'top-end',
                            icon: 'error',
                            title:"{% trans 'Treatment is already exists' %}",
                            showConfirmButton: false,
                            timer: 2000
                        })
                    }
                    else {
                        // console.log("gelen cevap budur : ", response)
                        var treatmentRecommendation = {{treatment_recommendation_auto|safe}}
                        var treatmentMethods = treatmentRecommendation[toothNumber].treatment_methods;
                        let spanItems = "" //modal kapandıktan sonra dişlere eklenecekler
                    let currentLanguage = ""
                    if (window.location.href.includes("/tr/")) {
                        currentLanguage = "tr";
                    } else if (window.location.href.includes("/uz/")) {
                        currentLanguage = "uz";
                    } else if (window.location.href.includes("/ru/")) {
                        currentLanguage = "nl";
                    }else if (window.location.href.includes("/nl/")) {
                        currentLanguage = "ru";
                    }else{
                        currentLanguage = "en";
                    }                    
                        spanItems += `${$(`[data-tooth-id="${toothNumber}"] .treatmentForTooth span`).length ? " , " : ""}`
                        selectedTreatmentNames.forEach(function(treatmentName, index){
                            // console.log("index : ", index, treatmentName)
                            spanItems += `
                                <span 
                                    style="cursor:pointer"
                                    data-delete-treatment-id="treatmentDeleteForTooth" 
                                    data-open-modal-pk="delete-treatment-from-tooth" 
                                    data-tooth-number-for-treatment-delete="${toothNumber}"
                                    data-tooth-id="${response.tooth_id}"
                                    data-method-slug="${response.recommendations[index].slug}">
                                ${currentLanguage === "tr" ? response.recommendations[index].tr_name : response.recommendations[index].en_name}
                                </span>
                                ${(index + 1) !== selectedTreatmentNames.length ? "," : ""}
                            `
                        })
                        // console.log("ekelenecek olan spanlar : ", spanItems);
                        $(`[data-tooth-id="${toothNumber}"] .treatmentForTooth`).append(spanItems)
                        swal.fire({
                            position: 'top-end',
                            icon: 'success',
                            title:"{% trans 'Treatment has been added successfully' %}",
                            showConfirmButton: false,
                            timer: 2000
                        }).then(function () {
                            // window.location.reload()
                            });
                    closeModal()
                    }



                },
                error: function(xhr, status, error) {
                }
            });
        });
    });

</script>

<script>
    var csrfmiddlewaretoken = $('input[name=csrfmiddlewaretoken]').val()
    function uuidv4() {
        return ([1e7]+1e3+4e3+8e3+1e11).replace(/[018]/g, c =>
            (c ^ crypto.getRandomValues(new Uint8Array(1))[0] & 15 >> c / 4).toString(16)
        );
    }
    
    var parametre
    url = "{% url 'dicom_image_upload'%}";
    Dropzone.autoDiscover = false;
    var image_response_type = null;
    var file_url = null;
    var progress_slug;
    var check_dicom_uploaded_before = false
    var u_can_upload = false
    var file_name = null;
    var totalAddedFiles = 0;
    var uploadedTotalFiles = 0;
    var myDropzone2 = new Dropzone('#dicomDropzone', {
        autoProcessQueue: false,
        url: url,
        maxFiles: 100000000,
        maxFilesize: 99999,
        acceptedFiles: '.dcm',
        timeout: 9999999999,
        chunking: true,
        previewsContainer: false,
        chunkSize: 2000000,
        clickable: "#dicomDropzone",
        parallelChunkUploads: false,
        retryChunks: true,
        retryChunksLimit: 5,
        forceChunking: true,
        init: function() {
            $('#CBCTUpload').click(function(){
                parametre = uuidv4()
                myDropzone2.processQueue();
                $('#CBCTUpload').hide();
                $('#progress').show();
                $('#modal-radyografy-upload div[data-modal-close]').css("pointer-events", "none");
                $('#modal-radyografy-upload div[data-modal-close]').css("background-color", "grey");
                $('#open-new-tab').removeClass("d-none");
                $('#close-upload-modal').addClass("d-none");
                $('#radiography_types').prop("disabled", true);
            })
            
            this.on("addedfile", function(file) {
                totalAddedFiles++;
                // console.log("Toplam Eklenen Dosya Sayısı: " + totalAddedFiles);
                $('#dicomDropzone').removeClass("d-flex");
                $('#dicomDropzone').hide();
                $('#cbtcContainer').css("display", "block");
    
                totalAddedFiles==1 ? $('#cbtcContainer').text(`${totalAddedFiles} file selected.`) : $('#cbtcContainer').text(`${totalAddedFiles} files selected.`);
            });
            this.on("sending", function(file, xhr, formData) {
                // Gönderilecek diğer parametreleri burada belirtebilirsiniz
                formData.append('slug', parametre);
                if (file.upload.totalChunkCount!=1){
                    $('#progressBar').css("width", `${file.upload.progress}%`);
                    $('#progressText').text(`${parseInt(file.upload.progress)}%`);
                }
                
            });

            this.on("success", function(file, response) {
                // Dosya yükleme başarılı olduğunda yapılacak işlemleri burada tanımlayabilirsiniz
                uploadedTotalFiles++;
                // console.log("Dosya başarıyla yüklendi:", response);
                if (uploadedTotalFiles<totalAddedFiles){
                    myDropzone2.processQueue();
                    // console.log("Process in queue", "Uploaded: ", uploadedTotalFiles, "Total: ", totalAddedFiles);
                }
                $('#progressBar').css("width", `${uploadedTotalFiles/totalAddedFiles*100}%`);
                $('#progressText').text(`${parseInt(uploadedTotalFiles/totalAddedFiles*100)}%`);

            });

            //this.on("error", function(file, errorMessage) {
                // Dosya yükleme hatası durumunda yapılacak işlemleri burada tanımlayabilirsiniz
            //    console.error("Dosya yüklenirken hata oluştu:", errorMessage);
            //});
    
            this.on("queuecomplete", function() {
                // Tüm dosyalar yüklendikten sonra API isteğini burada yapabilirsiniz
                // console.log("Tüm dosyalar yüklendi. API isteği gönderilecek.");
                // Örnek olarak jQuery kullanarak bir POST isteği gönderelim
                var csrfmiddlewaretoken = $('input[name=csrfmiddlewaretoken]').val();
                $.ajax({
                    url: "{% url 'convert_niftii_and_panoramic' %}",
                    method: 'POST',
                    headers: { 'X-CSRFToken': csrfmiddlewaretoken },
                    data: {
                        // Burada gerekli verileri ve dosya bilgilerini gönderebilirsiniz
                        // Ekstra verileri burada ekleyebilirsiniz
                        slug: parametre,
                        image_report_id: "{{image_report_id}}"
                    },
                    success: function(response) {
                        totalAddedFiles = 0
                        uploadedTotalFiles = 0
                        $('#bildirim').click();
                        myDropzone2.removeAllFiles();
                        $('modal_radiography_upload').removeClass("active");
                        $('#modal-radyografy-upload div[data-modal-close]').css("pointer-events", "auto");
                        $('#modal-radyografy-upload div[data-modal-close]').css("background-color", "#FF7979");
                        $('#CBCTUpload').show();
                        $('#progress').hide();
                        $('#open-new-tab').removeClass("d-block");
                        $('#open-new-tab').addClass("d-none");
                        $('#close-upload-modal').removeClass("d-none");
                        $('#radiography_types').prop("disabled", false);
                        $('#dicomDropzone').addClass("d-flex");
                        $('#dicomDropzone').show();
                        $('#cbtcContainer').css("display", "none");

                        // API isteği başarılı olduğunda yapılacak işlemleri burada tanımlayabilirsiniz
                    },
                    error: function(xhr, status, error) {
                        console.error("API isteği sırasında hata oluştu:", error);
                        // API isteği sırasında hata durumunda yapılacak işlemleri burada tanımlayabilirsiniz
                    }
                });
            });
        }
    })
</script>
<script>
    function filepondInit() {
        // dropzone alternatifi bir dosya yükleme kütüphanesi
        // FilePond'u yükle
        const inputElement      = document.getElementById('filepond');
        const previewElement    = document.getElementById('previewFilePond');
        const uploadButton      = document.getElementById('filepondUploadButton');

    const allowedFileTypes  = ['.png', '.jpg', '.jpeg', '.tiff', '.bmp', '.PNG','.JPG','.JPEG','.TIFF','.BMP'];
        const allowedMimeTypes  = ['image/png', 'image/jpeg', 'image/tiff', 'image/bmp'];

        var fileThatFilepond
        const pond = FilePond.create(inputElement, {
            acceptedFileTypes: allowedFileTypes,
            instantUpload: false,
            allowMultiple: false,
            credits: '',
            dropValidation: true,
            labelIdle: `
            <div class="text-light">
                <i class="fa-solid fa-upload border" style="border-radius: 50%; padding: 10px;"></i>
                <p class="m-0 my-2">Drag &amp; Drop or Choose file upload</p>
            <p class="m-0">JPG, PNG, JPEG, TIFF or BMP</p>
            </div>
            `,
            onaddfile: (error, file) => {
                if (!error) {
                    const fileExtension = file.file.name.split('.').pop();
                    const fileType = file.file.type;
                    fileThatFilepond = file.file
                    // console.log(file.file)
                    if (allowedFileTypes.includes('.' + fileExtension) && allowedMimeTypes.includes(fileType)) {
                        // Geçerli dosya uzantısı ve MIME türüne sahip dosyayı kabul et
                        if (fileExtension.toLowerCase() === 'tiff') {
                            // Eğer dosya uzantısı .tiff ise önizleme mesajını göster
                            previewElement.innerHTML = '<p>Tiff file uploaded.</p>';
                    }else if (fileExtension.toLowerCase() === 'bmp') {
                        // Eğer dosya uzantısı .tiff ise önizleme mesajını göster
                        previewElement.innerHTML = '<p>BMP dosyası yüklendi</p>';
                        } else {
                            // Diğer resim dosyaları için önizlemeyi göster
                            const img = new Image();
                            img.src = URL.createObjectURL(file.file);
                            previewElement.innerHTML = '';
                            previewElement.appendChild(img);

                            // Dosya adını ve boyutunu görüntüle
                            const fileInfo = document.createElement('div');
                            fileInfo.innerHTML = `<p>${file.file.name}</p><p>${formatBytes(file.file.size)}</p>`;
                            previewElement.appendChild(fileInfo);
                        }
                    } else {
                        // Geçerli dosya uzantısı veya MIME türüne sahip değil, dosyayı reddet
                        pond.removeFile(file.id);
                        // console.log("Lütfen geçerli bir dosya seçiniz: .png, .jpg, .jpeg veya .tif");
                    }
                } else {
                    console.error('Dosya yüklenirken bir hata oluştu:', error);
                }
            }
        });
        var csrfmiddlewaretoken= $('input[name=csrfmiddlewaretoken]').val()
        // ##############################
            //data: {
            //    "patientId": patientId,
        //
        //  },
            //###################################
        // Yükleme butonuna tıklanınca
        uploadButton.addEventListener('click', () => {
            // console.log("tamamdır",fileThatFilepond)
            const files = pond.getFiles();
            const patientSlug = $("#modal-radyografy-upload").attr("data-patient-slug")
            // console.log("files", files)
            if( $("#radiography_types").val() === '' ) {
                // radyografi tipi seçilmemiş
                swal.fire({
                    position: 'top-end',
                    icon: 'error',
                    title:"Select a type of upload file",
                    showConfirmButton: false,
                    timer: 2000,
                })
            }
            else if (files.length > 0) {
                // Dosyaları sunucuya gönderme
                const formData = new FormData();
                var radiographyTypesSelect = document.querySelector("#radiography_types");
                var selectedRadiographyTypeId = radiographyTypesSelect.value;
                formData.append("radiography_type", selectedRadiographyTypeId);
                formData.append('image_report_id', "{{image_report_id}}");
                formData.append('file', fileThatFilepond);
                // console.log("formdata", formData)
                $("#page-loading").show()
                // files.forEach(file => {
                //     formData.append('files', file.file);
                // });

                fetch("{% url 'upload_radyografi' %}", {
                    method: 'POST',
                    body: formData,
                    headers: { "X-CSRFToken": csrfmiddlewaretoken },
                })
                .then(response => response.json())
                .then(data => {
                    // console.log("data", data)
                    if (data["code"] === "image_limit_exceeded"){
                        Swal.fire({
                            position: 'top-end',
                            icon: 'error',
                            title: data['message'],
                            showConfirmButton: false,
                            timer: 3000
                        })
                        return false
                    }
                    if (data["code"] === "analyse_limit_exceeded"){
                        Swal.fire({
                            position: 'top-end',
                            icon: 'error',
                            title: data['message'],
                            showConfirmButton: false,
                            timer: 3000
                        })
                        return false
                    }
                    if (data["success"]=== false){
                        $("#page-loading").hide()
                        alert(data['message'])
                    } else if (data["success"]=== true){
                        $("#page-loading").hide()
                        pond.removeFiles();
                        $('#previewFilePond').html("")
                        $('#modal-radyografy-upload').removeClass("active")
                        document.getElementById('bildirim').click()
                    }
                })
                .catch(error => {
                    $("#page-loading").hide()
                    console.error('Hata:', error);
                });

                radiographyTypesSelect.value = '';
                $('#radiography_types option:first').prop('selected', true);
            } else {
                // dosya yüklenmeden butona tıklandı
                swal.fire({
                    position: 'top-end',
                    icon: 'error',
                    title:"Select a file",
                    showConfirmButton: false,
                    timer: 2000,
                })
            }
        });
        $("#page-loading").hide()

        // Byte cinsinden dosya boyutunu formatlama işlevi
        function formatBytes(bytes, decimals = 2) {
            if (bytes === 0) return '0 Bytes';

            const k = 1024;
            const dm = decimals < 0 ? 0 : decimals;
            const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB', 'PB', 'EB', 'ZB', 'YB'];

            const i = Math.floor(Math.log(bytes) / Math.log(k));

            return parseFloat((bytes / Math.pow(k, i)).toFixed(dm)) + ' ' + sizes[i];
        }

    }
        
    $(document).ready(function () {
        filepondInit() // dosya yükleme panoramic bitewing vs için
    });

    $(document).ready(function () {

        $("#radiography_types").on("change",function() {
            let selectValue = $(this).val()
            if(selectValue === '3') {
                // cbct

                // butonları göster gizle
                $("#CBCTUpload").removeClass("d-none")
                $("#filepondUploadButton").addClass("d-none")

                // formları göster gizle
                $("#dicomDropzone").removeClass("d-none")
                $("#uploadFilepond").addClass("d-none")
            } else {
                // diğerleri

                // butonları göster gizle
                $("#CBCTUpload").addClass("d-none")
                $("#filepondUploadButton").removeClass("d-none")

                // formları göster gizle
                $("#dicomDropzone").addClass("d-none")
                $("#uploadFilepond").removeClass("d-none")
            }
        })
        
    })
</script>
<script> // kullanıcı dicom yüklerken yeni sekmede sayfa açtıram kodu
    document.addEventListener("DOMContentLoaded", function() {
        var openButton = document.getElementById("open-new-tab");
        
        openButton.addEventListener("click", function() {
            var newPageURL = openButton.getAttribute("data-open-new-page");
            window.open(newPageURL, "_blank");
        });
    });
</script>

<script> // LABELLERİ ARAPÇA YAPAR
    var labels_for_arabic = {{diagnosis_section.labels|safe}}
    let lang = window.location.href.includes("/en/") ? "en" : "tr"
    var ar_button =  $('#ar_labels')
    ar_button.click(function () {
        if ($('#ar_labels').prop('checked')) {
            checked = true
        } else {
            checked = false  
        }
        $.ajax({
            url:"{% url 'activeArabic' %}",
            type:"POST",
            headers: { 'X-CSRFToken': csrfToken },
            data: {
                    'checked': checked,
                },
            success:function(res){
                
                if (res.status == true){
                    if (res.value == "1"){
                        for (const [key, value] of Object.entries(labels_for_arabic)) {
                            var labelElement = document.querySelector(`[data-disease-name="${key}"]`);
                            labelElement.textContent = value.ar_name;
                        }
                    }else{
                        for (const [key, value] of Object.entries(labels_for_arabic)) {
                            var labelElement = document.querySelector(`[data-disease-name="${key}"]`);
                            lang == "tr" ? labelElement.textContent = value.tr_name : labelElement.textContent = key
                        }
                    }
                    
                }
                $('.diagnosis_area .number').toggleClass("m-l-auto")
                $('.diagnosis_area label').toggleClass("m-l-auto")
            },
            error:function(xhr, status, error){
            }
        })
    })

</script>

{% endblock %}

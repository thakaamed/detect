{% extends 'base.html' %}
{% load static %}
{% load i18n %}
{% block customCss %}
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="{% static 'css/bootstrap.css' %}">
    <link rel="stylesheet" href="{% static 'css/fontawesome.css' %}">
    <link rel="stylesheet" href="{% static 'css/diagnosis.css' %}">
    <link rel="stylesheet" href="{% static 'css/patients_exstra.css' %}">
    <title>{{specs.title}} - Diagnosis</title>
    <link rel="icon" type="image/png" href="{% static specs.favicon %}" />
    <link rel="stylesheet" href="{% static 'css/exstra.css' %}"/>
    <link rel="stylesheet" href="{% static 'css/exstra2.css' %}"/>
    <link rel="stylesheet" href="{% static 'css/dicom.css' %}"/>
    <script src="{% static 'js/jquery.js' %}"></script>
    <script src="{% static 'js/ckeditor2.js' %}"></script>
    <style>
        .process {
            color: #125cc7;
            transform: rotate(0deg);
            animation: spin 1s infinite linear;
        }
        .completed-ok {
            color: #1cf171;
        }
        .completed-no {
            color: #ff2727;
        }
        .treatment-section {
            position: absolute;
            width: 100%;
            height: 100%;
            overflow-y: auto;
            border-radius: 10px;
        }
        .treatment-section.chapter-1,
        .treatment-section.chapter-2 {
            transition: top ease-in-out 500ms;
        }
        .treatment-section.chapter-1 {
            top: -200%;
        }
        .treatment-section.chapter-1 .half {
            background-color: #1A264E;
        }
        .treatment-section.chapter-1 .half:not(:first-child) {
            background-color: white;
        }
        .treatment-section.chapter-1.active {
            top: 0;
        }

        .treatment-section.chapter-2 {
            display: none !important;
        }

        .treatment-section.chapter-2.active {
            display: flex!important;
        }
        #exam_questions {
            padding: 27px;
        }
        .custom-hr {
            width: 100%;
            height: 1px;
            background-color: #3B4978;
            margin: 20px 0;
        }
    </style>
{% endblock %}
{% block headerButtons %}
{% endblock %}
{% block content %}
{% csrf_token %}
<div id="page-loading" class="position-fixed align-items-center justify-content-center" style="inset: 0; z-index: 9999999999;">
    <i class="fa-solid fa-spinner fs-1"></i>
</div>
<div class="map-hover-popup__root"></div>
<div id="modal-dicom-analysis-types" class="modal-container">
    <div class="modal-box px-4 d-flex flex-column text-light" style="min-width: 350px; height: auto; max-height: 100vh; max-width: 100vw; background-color: #1A264E;">
        <div class="modal-box__close">
            <div class="close-icon" data-modal-close>
                <i class="fa-solid fa-xmark"></i>
            </div>
        </div>
        <p class="my-2" style="font-size: 22px;">{% trans 'Choose Analysis Type' %}</p>
        <select name="radiography_types" id="radiography_types">
            <option value="" selected>{% trans 'Select Analysis Type...' %}</option>
            {% for type_id, values in analysis_types_section.items %}
                <option 
                    id="analysis_type_id_{{type_id}}" 
                    value="{{values.slug}}" 
                    {% if type_id == 2 or type_id == 3 or type_id == 5 %} style="background-color: grey; color:white;" disabled {% endif %}> 
                    {%if 'STL Report' in values.name %}{{values.name}} (BETA){%else%}{{values.name}}{%endif%}
                </option>
            {% endfor %}
        </select>
        <button id="start_analysis" class="save-treatment custom btn-blue mb-2">{% trans 'Start Analysis' %}</button>
        <button class="save-treatment custom">{% trans 'Cancel' %}</button>
    </div>
</div>
<main class="d-flex">
    <div class="container-fluid">
        <div class="adjustable-content py-1" style="overflow: auto;">
            <div class="row h-100 g-0">
                <div class="d-flex align-items-center pt-3">
                    <div class="d-flex main-chart mt-2 me-0">
                        <div class="chart-element mb-3">
                            <h2>Slice Thickness - 0.4mm | Slice step - 4mm</h2>
                            <h5>Implantology Report</h5>
                        </div>
                        <div class="tooth-chart-illnesses-by-tooth pb-3 mt-3" style="position: relative; opacity: 1;">
                            <div class="position-relative overflow-hidden chart-element">
                                <div class="teeth adult">
                                    {% for tooth_number, value in tooth_chart_section.items %}
                                        <div class="tooth" data-tooth="{{tooth_number}}" data-index="{{value.index}}">
                                            <div class="item">
                                                <img src="{{value.path}}" class="imgToChange" alt="" data-tooth-type="{{value.name}}">
                                                <span class="tooth-cursor" onclick="toggleToothDiv({{value.index}})">{{tooth_number}}</span>
                                                <div class="tooth-menu" data-tooth-menu="{{tooth_number}}">
                                                    <div data-icon-type="None" onclick="changeToothType({{tooth_number}} ,`{% static 'img/Vector.png' %}`,this, 'auto-height')">
                                                        <img src="{% static 'img/Vector.png' %}" class="auto-height" alt="">
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                        <div class="chart-element slice-img-chart">
                            <img id="chartImg" src="{{main_image.path}}" alt="Main Image" style="width: 100%; position: relative">
                            <canvas id="lineCanvas"></canvas>
                        </div>
                        <button id="btnShowSlice" class="custom btn-blue mt-3">Show Slice</button>
                    </div>
                    <div class="d-flex right-chart row h-100 mt-2 me-5">
                        <div class="h-100 teeth-and-treatment-section position-relative active" style="transition: width ease-in-out 500ms;">
                            <div class="tooth-chart-illnesses-by-tooth px-2 py-3" style="position: relative; opacity: 1;">
                                <h3 class="heading d-flex">
                                    <span>{% trans 'Tooth Chart' %}</span>
                                    <div class="ms-auto me-2 doctor-comment">
                                        {% if not doctor_note %}
                                            <i class="fa-regular fa-comment" style="cursor: pointer"></i>
                                        {% else %}
                                        <!-- NOTTTTTTT : eğerki içinde yorum varsa aşağıdaki ikon gözüksün yorum yoksa yukarıdaki -->
                                            <i class="fa-solid fa-comment" style="cursor: pointer"></i>
                                        {% endif %}
                                    </div>
                                    <i class="fa-solid fa-eye-slash see-all-teeth-detail" data-eye="open"></i>
                                </h3>
                                <div class="position-relative overflow-hidden py-2">
                                    <div id="doctor-comment-area" class="position-absolute bg-light d-flex flex-column p-2" style="width: 100%; height: 100%; overflow-y: auto; z-index: 99; top: -100%">
                                        <p class="text-dark mb-1">{% trans 'Doctor Comment' %}</p>
                                        <textarea name="" id="doctorNoteArea" rows="4" class="form-control" style="overflow-y: auto!important; font-size: 12px!important; flex:1;">{% if doctor_note %}{{doctor_note}}{%else%} {%endif%}</textarea>
                                        <div class="py-2 d-flex justify-content-end" style="gap: 7px;">
                                            <button id="doctor-comment-save-btn" class="custom transparent blue-hover" style="color: #111;">
                                                <i class="fa-solid fa-floppy-disk"></i>
                                                {% trans 'Save' %}
                                            </button>
                                            <button id="doctor-comment-cancel-btn" class="custom transparent blue-hover" style="color: #111;">
                                                <i class="fa-solid fa-xmark"></i>
                                                {% trans 'Close' %}
                                            </button>
                                        </div>
                                    </div>
                                    <div class="teeth child-1 {% if is_kid_status %}{% else %}d-none{% endif %}">
                                    </div>
                                    <div class="teeth adult">
                                    </div>
                                    <div class="teeth child-2 {% if is_kid_status %}{% else %}d-none{% endif %}">
                                    </div>
                                </div>
                                    <div class="tooth-details">
                                    </div>
                                </div>
                                {% if not grouped_treatments %}
                                    <div id="first-planning" class="treatment-section d-flex flex-column chapter-1">
                                        <div class="half d-flex align-items-center justify-content-center py-4">
                                            <img src="{% static 'img/panel-circle.png' %}" class="img-fluid" alt="">
                                        </div>
                                        <div id="emptyView" class="half d-flex flex-column align-items-center justify-content-center" style="gap: 10px; flex: 1;">
                                            <p class="m-0 text-dark font-weight-bold fs-5">{% trans 'Treatment Planning' %}</p>
                                            <p class="m-0 text-dark fs-6 text-muted text-center">{% trans 'Here you can add and view treatment planning' %}</p>
                                            <button class="custom text-light" style="background: linear-gradient(90deg, #0E2D58 0%, #203F6C 100%);" data-pass-two-chapter>{% trans 'Start Planning' %}</button>
                                        </div>
                                        <div id="planning-item-container" class="px-3 w-100 bg-light" style="overflow-y: auto;">
                                            <div></div>
                                        </div>
                                    </div>
                                {% else %}
                                    <div id="other-plannings" class="treatment-section d-flex flex-column chapter-1 active">
                                        <div class="half d-flex flex-column align-items-center justify-content-center py-4">
                                            <img src="{% static 'img/panel-circle.png' %}" class="img-fluid" alt="">
                                            <p class="m-0 font-weight-bold fs-5 text-light my-2">{% trans 'Treatment Planning' %}</p>
                                            <p class="m-0 fs-6 text-muted text-center">{% trans 'Here you can add and view treatment planning' %}</p>
                                        </div>
                                        <div class="half d-flex flex-column align-items-center justify-content-center" style="gap: 10px; flex: 1;">
                                            <div class="position-sticky d-flex justify-content-end w-100 top-0" style="background-color: white;">
                                                <button class="custom text-light m-2" style="background: linear-gradient(90deg, #0E2D58 0%, #203F6C 100%);" data-pass-two-chapter>{% trans 'Start Planning' %}</button>
                                            </div>
        
                                            <div id="planning-item-container" class="px-3 py-1 w-100" style="flex: 1; overflow-y: auto;">
                                                {% if 'Today' in grouped_treatments %}
                                                    <div class="planning-item">
                                                        <p class="m-0 text-dark fs-6"><strong>Today</strong></p>
                                                    </div>
                                                    {% for item in grouped_treatments.Today %}
                                                            <div class="planning-item">
                                                                <div class="rounded p-3 text-dark my-3 d-flex planning-item-box" style="box-shadow: 0 0 30px rgba(0, 0, 0, .15);">
                                                                    <span style="width: 12px; height: 12px; border-radius: 50%; background-color: lime;"></span>
                                                                    <div class="mx-3">
                                                                        <p data-treatment-id="{{ item.id }}" class="m-0 mb-1" data-pass-two-chapter=""><strong>Treatments Plan {{item.counter}} </strong></p>
                                                                        <p class="m-0">{{ item.modified_date }}</p>
                                                                    </div>
                                                                    <span class="ms-auto d-flex align-items-end">
                                                                        <i data-open-modal-pk="modal-delete-treatment"
                                                                        data-modal-type="treatment-delete" class="fa-solid fa-trash fs-6" style="cursor: pointer;"></i>
                                                                    </span>
                                                                </div>
                                                            </div>
                                                    {% endfor %}
                                                {% endif %}
                                                {% for date, items in grouped_treatments.items %}
                                                    {% if date != 'Today' %}
                                                        <div class="planning-item">
                                                            <p class="m-0 text-dark fs-6"><strong>{{ date }}</strong></p>
                                                        </div>
                                                        {% for item in items %}
                                                                <div class="planning-item">
                                                                    <div class="rounded p-3 text-dark my-3 d-flex planning-item-box" style="box-shadow: 0 0 30px rgba(0, 0, 0, .15);">
                                                                        <span style="width: 12px; height: 12px; border-radius: 50%; background-color: lightgray;"></span>
                                                                        <div class="mx-3">
                                                                            <p data-treatment-id="{{ item.id }}" class="m-0 mb-1" data-pass-two-chapter=""><strong>Treatments Plan {{ item.counter }}</strong></p>
                                                                            <p class="m-0">{{ item.modified_date }}</p>
                                                                        </div>
                                                                        <span class="ms-auto d-flex align-items-end">
                                                                            <i data-open-modal-pk="modal-delete-treatment"
                                                                            data-modal-type="treatment-delete" class="fa-solid fa-trash fs-6" style="cursor: pointer;"></i>
                                                                        </span>
                                                                    </div>
                                                                </div>
                                                        {% endfor %}
                                                    {% endif %}
                                                {% endfor %}
                                                <div id="planning-items-list"></div>
                                            </div>
        
                                        </div>
                                    </div>
                                {% endif %}
                                <div class="treatment-section bg-light chapter-2 p-3 d-flex flex-column">
                                    <h3 class="text-dark fs-3">{% trans 'Treatment Planning' %}</h3>
                                    <p class="text-muted">{% trans 'You can add or update treatment planning' %}</p>
                                    <form id="treatment-planning">
                                        <textarea name="ck-editor" id="editor"></textarea>
                                        <div class="d-flex justify-content-end mt-2">
                                            <button class="custom text-dark me-2" data-pass-one-chapter type="button">{% trans 'Cancel' %}</button>
                                            <button type="submit" class="save-treatment-planning custom btn-blue" data-treatment-save>{% trans 'Save' %}</button>
                                        </div>
                                    </form>
                                </div>
                            </div>
                    </div>
                </div>
                <div id="downChart" class="d-flex align-items-center pt-3" style="">
                    <div class="main-chart-down mt-5 me-0">
                        <div class="chart-element mb-3">
                            <h2>Slice Thickness - 0.4mm | Slice step - 4mm</h2>
                            <h5>Implantology Report</h5>
                        </div>
                        <div class="image-container" style="display: flex; flex-wrap: wrap; max-width: 100%; justify-content: flex-start;">
                            {% for dicom_slice, value in dicom_result_dict.result_dict.items %}
                                <div id="slice_{{dicom_slice}}" class="slice-img-chart" style="max-width: 100%; height: auto;margin-right: 25px; margin-bottom: 25px;">
                                    <img class="slice_cvs" id="slice_img_{{dicom_slice}}" src="{{value.path}}" alt="Image 1" style="width: 100%;" >
                                    <canvas id="lineCanvas_slice_{{dicom_slice}}"style="position: absolute;width: 100%;left: 0;height: 100%;top: 0;"></canvas>
                                    <canvas id="lineCanvas_text_{{dicom_slice}}"style="position: absolute;width: 100%;left: 0;height: 100%;top: 0;"></canvas>
                                </div>
                            {% endfor %}
                        </div>
                    </div>
                    <div class="d-flex right-chart-down mt-5 pt-3 me-5">
                        <div class="chart-element mb-3">
                            <h2>Slice Thickness - 0.4mm | Slice step - 4mm</h2>
                            <h5>Implantology Report</h5>
                        </div>
                        <div class="image-container">
                            <img id="mini-slice" src="https://dcm.craniocatch.com/media/2d_slice_images/289/e788935c-7369-11ee-b1b5-8753cfb2b1a2/239.png" alt="Image 1">
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</main>
{% endblock %}

{% block customJs %}
<script src="{% static 'js/bootstrap.js' %}"></script>
<script src="{% static 'js/toastify.js' %}"></script>
<script src="{% static 'js/wheelzoom.js' %}"></script>
<script src="{% static 'js/app.js' %}"></script>
<script src="{% static 'js/dicom.js' %}"></script>


<script>
    var image_report_id = "{{image_report_id}}"
    let csrfToken = $('input[name=csrfmiddlewaretoken]').val()
    var csrfmiddlewaretoken = $('input[name=csrfmiddlewaretoken]').val();
    var dicomResult = {{dicom_result|safe}}
    console.log(dicomResult, typeof(dicomResult))
</script>

<script>
    $(document).ready(function() {
        $("#page-loading").hide()
    })
</script>

<script>
    function closeModal() {
        var modal = document.querySelector(".modal-container.active");
        modal.classList.remove("active");
        var checkboxesForDiagnosis = document.querySelectorAll('.patient-item input[type="checkbox"]:checked');
        checkboxesForDiagnosis.forEach(function(checkbox) {
        checkbox.checked = false;
        })
    }
    //function toggleToothDiv(id) {

    //     if ($(".see-all-teeth-detail").attr("data-eye") === "open") {
    //         // tüm dişler gösteriliyor açık şekilde ise filtreleme tarzı bişey yap
    //         $(".see-all-teeth-detail").attr("data-eye", "close").removeClass("fa-eye-slash").addClass("fa-eye")
    //         $(".tooth-detail").css("display", "none")

    //         $(`.tooth-detail[data-tooth-id='${id}']`).css("display", "block")
    //         $(`.teeth .tooth[data-tooth='${id}'] .item`).addClass("active");
    //     } else {
    //         // tüm dişler açık değilse normal işlemi neyse onu yap
    //         if ($(`.tooth-detail[data-tooth-id='${id}']`).css("display") === "block") {
    //             // div açıktır o zaman kapat 
    //             $(`.tooth-detail[data-tooth-id='${id}']`).css("display", "none");
    //             $(`.teeth .tooth[data-tooth='${id}'] .item`).removeClass("active");
    //         } else {
    //             // kapalıdır o zaman aç, ama göz aktifse rengi mavi yapma
    //             $(`.tooth-detail[data-tooth-id='${id}']`).css("display", "block");
    //             if ($(".see-all-teeth-detail").attr("data-eye") !== "open") {
    //                 $(`.teeth .tooth[data-tooth='${id}'] .item`).addClass("active");
    //             }
    //         }
    //     }
 //}

 var selectedTooth = [];

function toggleToothDiv(toothNumber) {
    if (isToothValid(toothNumber)) {
        var index = selectedTooth.indexOf(toothNumber);

        if (index === -1) {
            // Eğer toothNumber seçili değilse, ekleyin
            selectedTooth.push(toothNumber);
        } else {
            // Eğer toothNumber zaten seçiliyse, kaldırın
            selectedTooth.splice(index, 1);
        }

        updateToothClasses();
    }
}

function updateToothClasses() {
    var toothDivs = document.querySelectorAll('.tooth');

    toothDivs.forEach(function (toothDiv) {
        var toothNumber = parseInt(toothDiv.getAttribute('data-index'));
        var itemDiv = toothDiv.querySelector('.item');

        // Eğer seçili dişler arasında ise 'active' class'ını ekleyin, değilse kaldırın
        if (isToothInRange(toothNumber)) {
            itemDiv.classList.add('active');
        } else {
            itemDiv.classList.remove('active');
        }
    });
}

function isToothInRange(toothNumber) {
    if (selectedTooth.length === 0) {
        return false;
    }

    var start = Math.min.apply(null, selectedTooth);
    var end = Math.max.apply(null, selectedTooth);

    return (toothNumber >= start && toothNumber <= end);
}

function isToothValid(toothNumber) {
    if (selectedTooth.length === 1) {
        var firstSelectedTooth = selectedTooth[0];

        if ((firstSelectedTooth >= 11 && firstSelectedTooth <= 28 && toothNumber >= 11 && toothNumber <= 28) ||
            (firstSelectedTooth >= 31 && firstSelectedTooth <= 48 && toothNumber >= 31 && toothNumber <= 48)) {
            return true;
        } else {
            return false;
        }
    } else if (selectedTooth.length > 1) {
        // Eğer daha önce seçilmiş dişler varsa, yeni seçimle uyumlu olup olmadığını kontrol et
        var isValid = selectedTooth.every(function (selectedToothNumber) {
            return (
                (selectedToothNumber >= 11 && selectedToothNumber <= 28 && toothNumber >= 11 && toothNumber <= 28) ||
                (selectedToothNumber >= 31 && selectedToothNumber <= 48 && toothNumber >= 31 && toothNumber <= 48)
            );
        });

        return isValid;
    }

    return true;
}

// Tüm seçimleri temizle
function clearSelection() {
    selectedTooth = [];
    updateToothClasses();
}

$("#btnShowSlice").click(function() {
    $("#downChart").show();
})


</script>

<script>
    function initCkEditor(data = '') {
        ClassicEditor
            .create( document.querySelector( '#editor', {
                toolbar: [
                'heading', 'bold', 'italic', 'link', 'bulletedList', 'numberedList',
                'blockQuote', 'imageUpload', 'insertTable', 'undo', 'redo'
            ],
            }))
            .then( newEditor => {
                myCkEditor = newEditor
                $("[data-pass-two-chapter]").click(function() {
                    // newEditor.setData("<p style='color:red;'>2.<strong>adım</strong> a geçildi</p>")
                    let id = $(this).attr("data-treatment-id")
                    var csrfToken = $('input[name=csrfmiddlewaretoken]').val();
                    if(id !== undefined){
                        console.log("SETTED")
                        setCustomCkEditor(id, csrfToken, myCkEditor)
                        // aslında bir id geldi
                        // $("#editor").attr("data-editor-treatment-id",id)
                        // $.ajax({
                        //     url:"{% url 'get_content_of_treatment_planning' %}",
                        //     type:"GET",
                        //     headers: { 'X-CSRFToken': csrfToken },
                        //     data:{'id':id},
                        //     success:function(response){
                        //         newEditor.setData(response.content)
                        //     },
                        //     error:function(xhr, status, error){
                        //     }

                        // })
                    } else {
                        // start planning diyip yeni ekleme yapılcağı zaman
                        // if (selectedItemsCount > selectedItems.length){
                        //     items_for_send = selectedItems
                        // }else{
                        //     items_for_send = null
                        // }
                        $.ajax({
                            url:"{% url 'get_content_of_ai_treatment_planning' %}",
                            type:"GET",
                            headers: { 'X-CSRFToken': csrfToken },
                            data:{
                                "image_report_id":image_report_id,
                                // "selected_items": items_for_send
                            },
                            success:function(response){
                                
                                $("#editor").attr("data-editor-treatment-id", "null");

                                // let treatment_recommendations_from_AI = {{treatment_planning_from_AI|safe}};
                                let content = '';

                                for (var key in response.treatment_planning_from_AI) {
                                    console.log("KEYYY", key)
                                    var treatmentMethods = response.treatment_planning_from_AI[key];
                                    content += `<p><strong>${key}</strong> - `;

                                    if (window.location.href.includes("/en/")) {
                                        var treatmentMethod = treatmentMethods['en_treatment_method'];
                                    } else {
                                        var treatmentMethod = treatmentMethods['tr_treatment_method'];
                                    }
                                    content += treatmentMethod;
                                    content += '</p>';
                                }

                                newEditor.setData(content);
                            },
                            error:function(xhr, status, error){
                            }

                        })
                        

                    }
                })
            })
            .catch( error => {
                console.error( error );
            } );
    }
    initCkEditor()
</script>

<script>
    var tooth_spacing = {{tooth_spacing}}

    
    tooth_spacing.forEach(selectedSpacingTooths);
    function selectedSpacingTooths(item) {
        var toothElements = document.querySelectorAll(`.tooth[data-tooth="${item}"]`);
        data_index = toothElements[0].getAttribute("data-index")        
        toggleToothDiv(data_index)

    }
</script>

<script>
    function closeTreatment() {
            $("[data-open-treatment]").toggleClass("transparent btn-blue")
            $(".treatment-section.chapter-2").removeClass("active")
        }
        function openTreatment() {
            $("[data-open-treatment]").toggleClass("transparent btn-blue")
            $(".treatment-section.chapter-1").toggleClass("active")
        }
        function passSecondChapter() {
            $(".treatment-section.chapter-1").removeClass("active")
            $(".treatment-section.chapter-2").addClass("active")
        }
        function passFirstChapter() {
            $(".treatment-section.chapter-2").removeClass("active")
            $(".treatment-section.chapter-1").addClass("active")
        }
        $("[data-open-treatment]").click(function() {
            if($(".treatment-section.chapter-2").hasClass("active")) {
                // aslında ikinci adım açıksa ve yukarıdaki treatment butonunua tıklanırsa
                // kompkle kapat aslında
                closeTreatment()
            } else {
                // hiçbişey açık değilse treatmentı aç
                if(!$(".teeth-and-treatment-section").hasClass("active")) {
                    // treatment butonuna tıklandıysa ve sağ panel açık değilse paneli de aç
                    $(".teeth-and-treatment-section").toggleClass("active ")
                    $("[data-event-type='collapse-section'] i").toggleClass("active")
                    $("svg.leaflet-zoom-animated").remove()
                    $("#back-img-frame .loading").removeClass("d-none")
                    if($(".teeth-and-treatment-section").hasClass("active")) {
                        setTimeout(function() {
                        $(".tooth-chart-illnesses-by-tooth").css("opacity", "1")
                        }, 500)
                    } else {
                        $(".tooth-chart-illnesses-by-tooth").css("opacity", "0")
                    }
                    setTimeout(function (){
                        draw_leaflet()
                    },500)
                }
                openTreatment()
            }
        })
        $("[data-pass-one-chapter]").click(function() {
            passFirstChapter()
        })
        $("[data-pass-two-chapter]").click(function() {
            passSecondChapter()
        })
        $("[data-treatment-close]").click(function() {
            closeTreatment()
        })
        $("[data-treatment-save]").click(function() {
            passFirstChapter()
        })
</script>

<!-- TREATMENT EKLEME VEYA GÜNCELLEME SCRIPTI -->
<script>
    $("#treatment-planning").on("submit", function(event) {
        event.preventDefault()
        let image_report_id = {{image_report_id}}
        let data = decodeURIComponent($(event.target).serialize()).replace("ck-editor=", "")
        let csrfToken = $('input[name=csrfmiddlewaretoken]').val()
        let id = $("#editor").attr("data-editor-treatment-id")
        var planningItem = $('#planning-items-list');
        var firstPlanningItem = $('#first-planning')

        $.ajax({
            url : "{% url 'add_treatment_planning' %}",
            type:"POST",
            headers:{'X-CSRFToken':csrfToken},
            data:{
                content:data,
                image_report_id: image_report_id,
                treatment_id:id
            },
            success:function(response){
                // swal.fire({
                //     position: 'top-end',
                //     icon: 'success',
                //     title:"{% trans 'Treatment planning successfully saved' %}",
                //     showConfirmButton: false,_reports[i]['id']}" class="m-0 mb-1" data-pass-two-cha
                //     timer: 2000
                // }).then(function(){
                //     // window.location.reload()
                // })
                Toastify({
                        gravity:"top",
                        position:"right",
                        duration:1000,
                        icon: "<i class='fa-solid fa-check'></i>",
                        backgroundColor: "green",
                        text: "{% trans 'Treatment planning successfully saved' %}"
                    }).showToast()

                if(response.status === "new-treatment") {
                    // yeni bir treatment eklenmiş ise DOM a ekle
                    if($("#emptyView").length) {
                        $("#emptyView p").remove()
                        $("#planning-item-container").css("flex","1")
                        $("#emptyView").css("flex","0").addClass("p-2 justify-content-end").removeClass("justify-content-center flex-column")
                        $("#planning-item-container > :first-child").html("<p class='m-0 my-2 text-dark'><strong>Today</strong></p>")
                    }
                    $(`
                    <div class="planning-item">
                        <div class="rounded p-3 text-dark my-3 d-flex planning-item-box" style="box-shadow: 0 0 30px rgba(0, 0, 0, .15);">
                            <span style="width: 12px; height: 12px; border-radius: 50%; background-color: lime;"></span>
                            <div class="mx-3">
                                <p data-treatment-id="${response.treatment_id}" class="m-0 mb-1" data-pass-two-chapter=""><strong style="pointer-events: none">Treatments Plan </strong></p>
                                <p class="m-0">${response.modified_date}</p>
                            </div>
                            <span class="ms-auto d-flex align-items-end">
                                <i data-open-modal-pk="modal-delete-treatment" data-modal-type="treatment-delete" class="fa-solid fa-trash fs-6" style="cursor: pointer;"></i>
                            </span>
                        </div>
                    </div>
                    `).insertAfter("#planning-item-container > :first-child");
                }
            },

            error:function(xhr, errmsg, err){
                // console.log("ckeditörden data gitti geldi ama hata")
            }
        })
    })

</script>

<script>
    $("#planning-item-container").click(function(event) {
        let targetElementType = $(event.target).prop('tagName')
        if(targetElementType === 'P' && $(event.target).attr("data-treatment-id")) {
            // console.log("aç işlemi")
            let id = $(event.target).attr("data-treatment-id")
            let csrfToken = $('input[name=csrfmiddlewaretoken]').val();
            setCustomCkEditor(id, csrfToken, myCkEditor)
            passSecondChapter()
        } else if(targetElementType === 'I') {
            // console.log("silme işlemi")
            let dataTreatmentId = $(event.target).closest(".planning-item").find("p[data-treatment-id]").attr("data-treatment-id")
            treatmentId = dataTreatmentId
            $("#modal-delete-treatment").addClass("active").attr("data-modal-treatment-id", dataTreatmentId)
        }

    })
</script>

{% endblock %}


{% extends 'base.html' %}
{% load static %}
{% load i18n %}
{% block customCss %}
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
        integrity="sha512-iecdLmaskl7CVkqkXNQ/ZH/XLlvWZOJyj7Yy7tcenmpD1ypASozpmT/E0iPtmFIB46ZmdtAc9eNBvH0H/ZpiBw=="
        crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="stylesheet" href="{% static 'css/patients.css' %}">
    <link rel="stylesheet" href="{% static 'css/patients_exstra.css' %}">
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.4/css/jquery.dataTables.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.4/jquery.min.js"
        integrity="sha512-pumBsjNRGGqkPzKHndZMaAG+bir374sORyzM3uulLV14lN5LyykqNk8eEeUlUkB3U0M4FApyaHraT65ihJhDpQ=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <title>{{specs.title}}</title>
    <link rel="icon" type="image/png" href="{% static specs.favicon %}" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/dropzone/5.9.3/dropzone.css" integrity="sha512-7uSoC3grlnRktCWoO4LjHMjotq8gf9XDFQerPuaph+cqR7JC9XKGdvN+UwZMC14aAaBDItdRj3DcSDs4kMWUgg==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <style>
        body.dark #example_length option{
            background-color: #333!important;
            color: #fff!important;
            
        }
        .dropzone.dz-started .dz-message {
            display: block !important;
        }

        #dropZone {
            padding: 10px;
            width: 100%;
            border-radius: 10px;
            background-color: transparent;
        }

        .dropzone {
            border: 2px dashed #526092!important;
            background-color: transparent;
            border-radius: 10px;
            cursor: pointer;
        }
        .dropzone .dz-preview:not(.dz-processing) .dz-progress {
            display: none;
        }
        .dropzone .dz-preview.dz-image-preview {
            background-color: transparent;
            margin: 5px 0;
        }
    </style>
{% endblock %}
{% block headerButtons %}
<!--<button class="custom transparent blue-hover text-light" data-open-modal-pk="modal-radyografy-upload">-->
<!--    <i class="fa-solid fa-upload" style="pointer-events: none;"></i>-->
<!--    <span style="pointer-events: none;">Upload Radiograpfy</span>-->
<!--</button>-->
{% endblock %}

{% block content %}

    

    <main class="position-relative" style="left: 0; height: calc(100vh - 110px);">
        <div id="thanksDiv" class="container p-5 bg-light rounded shadow-lg my-5">
            <!-- <h1>{% trans 'Health Tourism Form' %} {{patient_dict.full_name}}</h1> -->
            <p class="text-muted fs-6 my-3"><span class="my-3 d-block fs-6">{% trans 'Dear Patient,' %}</span>{% trans 'To enhance your personalized care, we request you to upload your dental X-rays and fill out this short questionnaire. This information, kept confidential, allows us to accurately assess your oral health and tailor your dental care based on your health history, lifestyle, and financial situation. Your cooperation aids in early disease detection, prevention, and improves your overall wellbeing.' %}</p>
            <form action="">
                <div class="row">
                    <div class="col-md-6">
                        <label for="patient-full-name" class="fs-6"><span class="text-danger me-2">*</span>Patient Full Name</label>
                        <input id="patient-full-name" type="text" class="form-control" placeholder="Write patient full name..." name="patientFullName" required>
                    </div>
                    <div class="col-md-6">
                        <label for="age" class="fs-6"><span class="text-danger me-2">*</span>What is your age?</label>
                        <select name="age" id="age" class="form-control" required>
                            <option value="0" disabled selected>Choose your answer</option>
                            <option value="-18">Below 18</option>
                            <option value="18-24">18-24</option>
                            <option value="25-34">25-34</option>
                            <option value="35-44">35-44</option>
                            <option value="45-54">45-54</option>
                            <option value="55-64">55-64</option>
                            <option value="+65">65 or Above</option>
                        </select>
                    </div>
                    <div class="col-md-6">
                        <label for="mail" class="fs-6"><span class="text-danger me-2">*</span>E-Mail</label>
                        <input id="mail" type="email" class="form-control" placeholder="Write patient mail..." name="mail" required>
                    </div>
                    <div class="col-md-6">
                        <label for="phone" class="fs-6"><span class="text-danger me-2">*</span>Phone</label>
                        <input id="phone" type="email" class="form-control" placeholder="Write phone..." name="phone" required>
                    </div>
                    <div class="col-md-6">
                        <label for="gender" class="fs-6"><span class="text-danger me-2">*</span>What is your gender?</label>
                        <select name="gender" id="gender" class="form-control" required>
                            <option value="0" disabled selected>Choose your answer</option>
                            <option value="male">Male</option>
                            <option value="female">Female</option>
                            <option value="mixed">Prefer Not To Say</option>
                        </select>
                    </div>
                    <div class="col-md-6">
                        <label for="allergies" class="fs-6">Please list any known allergies</label>
                        <input id="allergies" type="text" class="form-control" placeholder="(drug, food, environmental)" name="allergies">
                    </div>
                    <div class="col-md-6">
                        <label for="chronicDiseases" class="fs-6">Have you ever been diagnosed with any chronic diseases? If so, please specify.</label>
                        <select name="chronicDiseases" id="chronicDiseases" class="form-control" multiple data-is-required-specify>
                            <option value="diabetes">Diabetes</option>
                            <option value="hypertension">Hypertension</option>
                            <option value="heartDisease">Heart Disease</option>
                            <option value="asthma">Asthma</option>
                            <option value="cancer">Cancer</option>
                            <option value="autoimmuneDisease">Autoimmune Disease</option>
                            <option value="specify">Other (Please specify)</option>
                        </select>
                        <input type="text" name="chronicDiseasesSpecify" class="bg-light" placeholder="If so, please specify." data-operation="specify">
                    </div>
                    <div class="col-md-6">
                        <label for="smoke" class="fs-6"><span class="text-danger me-2">*</span>Do you smoke?</label>
                        <select name="smoke" id="smoke" class="form-control" required>
                            <option value="0" disabled selected>Choose your answer</option>
                            <option value="yes">Yes</option>
                            <option value="no">No</option>
                            <option value="formerSmoker">Former Smoker</option>
                        </select>
                    </div>
                    <div class="col-md-6">
                        <label for="weeklyPhysicalActivity" class="fs-6"><span class="text-danger me-2">*</span>How would you describe your weekly physical activity?</label>
                        <select name="weeklyPhysicalActivity" id="weeklyPhysicalActivity" class="form-control" required>
                            <option value="0" disabled selected>Choose your answer</option>
                            <option value="Sedentary (little or no exercise)">Sedentary (little or no exercise)</option>
                            <option value="Lightly active (light exercise/sports 1-3 days/week)">Lightly active (light exercise/sports 1-3 days/week)</option>
                            <option value="Moderately active (moderate exercise/sports 3-5 days/week)">Moderately active (moderate exercise/sports 3-5 days/week)</option>
                            <option value="Very active (hard exercise/sports 6-7 days a week)">Very active (hard exercise/sports 6-7 days a week)</option>
                            <option value="Super active (very hard exercise/physical job)">Super active (very hard exercise/physical job)</option>
                        </select>
                    </div>
                    <div class="col-md-6">
                        <label for="alcohol" class="fs-6"><span class="text-danger me-2">*</span>Do you drink alcohol?</label>
                        <select name="alcohol" id="alcohol" class="form-control" required>
                            <option value="0" disabled selected>Choose your answer</option>
                            <option value="Never">Never</option>
                            <option value="Rarely (once a month or less)">Rarely (once a month or less)</option>
                            <option value="Occasionally (2-4 times a month)">Occasionally (2-4 times a month)</option>
                            <option value="Often (2-3 times a week)">Often (2-3 times a week)</option>
                            <option value="Very often (4 or more times a week)">Very often (4 or more times a week)</option>
                        </select>
                    </div>
                    <div class="col-md-6">
                        <label for="dentalInsurance" class="fs-6"><span class="text-danger me-2">*</span>Do you currently have Do you currently have dental insurance?</label>
                        <select name="dentalInsurance" id="dentalInsurance" class="form-control" required>
                            <option value="0" disabled selected>Choose your answer</option>
                            <option value="Yes">Yes</option>
                            <option value="No">No</option>
                        </select>
                    </div>
                    <div class="col-md-6">
                        <label for="employmentStatus" class="fs-6"><span class="text-danger me-2">*</span>What is your employment status?</label>
                        <select name="employmentStatus" id="employmentStatus" class="form-control" required>
                            <option value="0" disabled selected>Choose your answer</option>
                            <option value="Employed for wages">Employed for wages</option>
                            <option value="Self-employed">Self-employed</option>
                            <option value="Out of work and looking for work">Out of work and looking for work</option>
                            <option value="Out of work but not currently looking for work">Out of work but not currently looking for work</option>
                            <option value="A homemaker">A homemaker</option>
                            <option value="A student">A student</option>
                            <option value="Military">Military</option>
                            <option value="Retired">Retired</option>
                            <option value="Unable to work">Unable to work</option>
                        </select>
                    </div>
                    <div class="col-md-6">
                        <label for="annualHouseholdIncome" class="fs-6"><span class="text-danger me-2">*</span>What is your annual household income?</label>
                        <select name="annualHouseholdIncome" id="annualHouseholdIncome" class="form-control" required>
                            <option value="0" disabled selected>Choose your answer</option>
                            <option value="0-25k">Below $25,000</option>
                            <option value="25k-50k">$25,000 to $49,999</option>
                            <option value="50k-75k">$50,000 to $74,999</option>
                            <option value="75k-100k">$75,000 to $99,999</option>
                            <option value="100k-150k">$100,000 to $149,999</option>
                            <option value="150k+">$150,000 or more</option>
                        </select>
                    </div>
                    <div class="col-md-6">
                        <label for="surgeryHistory" class="fs-6">Have you ever had any dental surgery or procedure done in the past? If yes, please specify.</label>
                        <textarea name="surgeryHistory" id="surgeryHistory" class="form-control shadow" placeholder="Have you ever had any dental surgery or procedure done in the past?"></textarea>
                    </div>
                    <div class="col-md-6">
                        <label for="regularlyCheckups" class="fs-6">What is your dietary preference?</label>
                        <select name="regularlyCheckups" id="regularlyCheckups" class="form-control" required>
                            <option value="0" disabled selected>Choose your answer</option>
                            <option value="Yes">Yes</option>
                            <option value="No">No</option>
                        </select>
                    </div>
                    <div class="col-md-6">
                        <label for="dietaryPreference" class="fs-6">What is your dietary preference?</label>
                        <select name="dietaryPreference" id="dietaryPreference" class="form-control" required data-is-required-specify>
                            <option value="0" disabled selected>Choose your answer</option>
                            <option value="Omnivore">Omnivore</option>
                            <option value="Vegetarian">Vegetarian</option>
                            <option value="Vegan">Vegan</option>
                            <option value="Pescatarian">Pescatarian</option>
                            <option value="Gluten-free">Gluten-free</option>
                            <option value="specify">Other (please specify)</option>
                        </select>
                        <input type="text" name="dietaryPreferenceSpecify" class="bg-light d-none" placeholder="Please specify" data-operation="specify">
                    </div>
                    <div class="col-md-6">
                        <label for="takingAnyMedication" class="fs-6">Are you currently taking any medication? If yes, please specify.</label>
                        <textarea name="takingAnyMedication" id="takingAnyMedication" class="form-control shadow" placeholder="Are you currently taking any medication?"></textarea>
                    </div>
                    <div class="col-md-6">
                        <label for="allergicReactions" class="fs-6">Have you ever experienced any adverse or allergic reactions to dental treatments?</label>
                        <select name="allergicReactions" id="allergicReactions" class="form-control" required data-is-required-specify>
                            <option value="0" disabled selected>Choose your answer</option>
                            <option value="specify">Yes (please specify)</option>
                            <option value="No">No</option>
                        </select>
                        <input type="text" name="allergicReactionsSpecify" class="bg-light d-none" placeholder="Please specify" data-operation="specify">
                    </div>
                    <div class="col-md-6">
                        <label for="historyOfDentalIssues" class="fs-6">Do you have any family history of dental issues? (e.g., gum disease, tooth decay)</label>
                        <select name="historyOfDentalIssues" id="historyOfDentalIssues" class="form-control" required data-is-required-specify>
                            <option value="0" disabled selected>Choose your answer</option>
                            <option value="specify">Yes (please specify)</option>
                            <option value="No">No</option>
                        </select>
                        <input type="text" name="historyOfDentalIssuesSpecify" class="bg-light d-none" placeholder="Please specify" data-operation="specify">
                    </div>
                </div>
            </form>
            <p class="fs-6 m-0 mt-4">{% trans 'Radiology Upload' %}</p>
            <select name="radiography_types" id="radiography_types" class="w-50 m-0 mt-2">
                <option value="" selected>{% trans 'Select Radiography Type...' %}</option>
                {% for type_id, type_name in image_type_dict.items %}
                    
                    <option {% if type_name == "CBCT" %} style="background-color: grey; color:white;" disabled {% endif %} value="{{type_id}}">{{type_name}}</option>
                {% endfor %}
            </select>
            <div id="fileUploadContainer" class="mb-4">
                <div class="row p-1">
                    <div class="col-md-6 p-3">
                        <div id="dropZone">
                            {% csrf_token %}
                            <form action="{% url 'upload_radyografi' %}" class="dropzone" id="my-great-dropzone"></form>
                        </div>
                    </div>
                    <div class="col-md-6 p-3">
                    </div>
                </div>
            </div>
            
            <p id="clarificationText">{% trans 'I have read and understood the' %} <a href="{% static specs.clarification_text %}" target="_blank"><u>{% trans 'Clarification text' %}</u></a> {% trans  'on the Processing of Personal Data and the' %} <a href="{% static specs.privacy_policy %}" target="_blank"><u>{% trans 'Personal Data Protection Policy' %}</u></a> 
                {{specs.login_page_content}}
            </p>
            <div class="d-flex align-items-center" style="gap: 5px;">
                <input type="checkbox" name="" id="portalTerms">
                <label for="portalTerms">{% trans 'I have read and accept the Portal Terms of Use.' %}</label>
            </div>
            <div class="d-flex justify-content-center my-2">
                <button id="upload-form" type="submit" form="my-great-dropzone" class="custom btn-blue py-2 w-50">{% trans 'Send' %}</button>
            </div> 
        </div>
        
        
    </main>
{% endblock %}

{% block customJs %}
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM"
        crossorigin="anonymous"></script>
    <script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/swiper@9/swiper-bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dropzone/5.9.3/dropzone.js" integrity="sha512-9e9rr82F9BPzG81+6UrwWLFj8ZLf59jnuIA/tIf8dEGoQVu7l5qvr02G/BiAabsFOYrIUTMslVN+iDYuszftVQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
    $("select[data-is-required-specify]").change(function() {
    var selectedValue = $(this).val();
    console.log(selectedValue);
    
    // Gelen değer "specify" ise işlem yapabilirsiniz
    if (selectedValue === "specify") {
      $(this).next("input[data-operation='specify']").removeClass("d-none");
    } else {
      $(this).next("input[data-operation='specify']").addClass("d-none");
    }
  });
</script>

<script>
    var csrfmiddlewaretoken = $('input[name=csrfmiddlewaretoken]').val()
    // dosya yükleme ayarları
    var myDropzone = Dropzone.options.myGreatDropzone = {
        autoProcessQueue: false,
        paramName: "file",
        maxFilesize: 2,
        clickable: "#dropZone", // the ID of our parent wrapper div
        maxFiles: 1 // Sadece 1 dosya seçimine izin ver
    };
    setTimeout(function () {
        $(".dz-default.dz-message").html(`
        <i class="fa-solid fa-upload border" style="border-radius: 50%; padding: 10px;"></i>
        <p class="m-0 my-2">Drag & Drop or Choose file upload</p>
        <p class="m-0">JPG, PNG, DCM or JPEG</p>
    `)
        $("form.dropzone").addClass("d-flex flex-column align-items-center")
    }, 1000)

    // Form submit olayını engelleyin ve dosyaları AJAX ile gönderin
    document.querySelector("#upload-form").addEventListener("click", function (event) {
        event.preventDefault();
        patientDict = {{patient_dict|safe}}
        console.log("patientDict",patientDict)
        console.log("patient_slug",patientDict.slug)
        var myDropzone = Dropzone.forElement("#my-great-dropzone");
        var radiographyTypesSelect = document.querySelector("#radiography_types");
        var selectedRadiographyTypeId = radiographyTypesSelect.value;
        console.log("selectedRadiographyTypeId",selectedRadiographyTypeId)
        patient_slug = patientDict.slug
        doctor_id = patientDict.doctor_id 
        if(!selectedRadiographyTypeId){
            Swal.fire({
                position: 'top-end',
                icon: 'error',
                title: "{% trans 'Please select radiography type' %}",
                showConfirmButton: false,
                timer: 3000
            });
            return false;
        }
        if (!document.querySelector("#portalTerms").checked) {
            Swal.fire({
                position: 'top-end',
                icon: 'error',
                title: "{% trans 'Accept the Terms of Use!' %}",
                showConfirmButton: false,
                timer: 3000
            });
            return false;
        }
        if (myDropzone.files.length > 0) {
            // Dosyaları AJAX ile göndermek için FormData oluşturun
            
            var formData = new FormData();
            for (var i = 0; i < myDropzone.files.length; i++) {
                formData.append("file", myDropzone.files[i]);
            }
            formData.append("radiography_type", selectedRadiographyTypeId);
            formData.append('image_report_id', "{{image_report_id}}");
            formData.append('patient_slug', patient_slug);
            formData.append('doctor_id', doctor_id);
            // AJAX isteği gönder
            fetch("{% url 'upload_radyografi' %}", {
                method: "POST",
                body: formData,
                headers: { 'X-CSRFToken': csrfmiddlewaretoken },
            })
                .then(response => response.json())
                .then(data => {
                    console.log(data);
                    if (data["code"] === "image_limit_exceeded"){
                        Swal.fire({
                            position: 'top-end',
                            icon: 'error',
                            title: data['message'],
                            showConfirmButton: false,
                            timer: 3000
                        })
                        return false
                    }
                    if (data["code"] === "analyse_limit_exceeded"){
                        Swal.fire({
                            position: 'top-end',
                            icon: 'error',
                            title: data['message'],
                            showConfirmButton: false,
                            timer: 3000
                        })
                        return false
                    }
                    if (data["success"]=== false){
                        alert(data['message'])
                    } else if (patient_slug){
                        myDropzone.removeAllFiles();
                        // $('#modal-radyografy-upload').removeClass("active")
                        document.getElementById('bildirim').click()
                    }
                    // İşlem tamamlandığında yapılacak işlemleri buraya ekleyebilirsiniz
                })
                .catch(error => {
                    console.error("Hata oluştu:", error);
                    // Hata durumunda yapılacak işlemleri buraya ekleyebilirsiniz
                });
                $('#thanksDiv').html("")
                $('#thanksDiv').append(`
                <h2 class="text-center">{% trans 'Thanks!' %}</h2>
                <p class="text-center">{% trans 'Your radiography image has been uploaded to our system.' %}</p>
                `)

        } else {
            Swal.fire({
                position: 'top-end',
                icon: 'error',
                title: "{% trans 'Please upload a radiography' %}",
                showConfirmButton: false,
                timer: 3000
            });
            return false;
        }
        // İşlem tamamlandığında yapılacak işlemleri buraya ekleyebilirsiniz
        // Dropzone içeriğini temizlem
        // Select'i güncelleme
        radiographyTypesSelect.value = '';
        $('#radiography_types option:first').prop('selected', true);
    });
</script>
{% endblock %}
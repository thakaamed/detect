{% extends 'base.html' %}
{% load static %}
{% load i18n %}
{% block customCss %}
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
        integrity="sha512-iecdLmaskl7CVkqkXNQ/ZH/XLlvWZOJyj7Yy7tcenmpD1ypASozpmT/E0iPtmFIB46ZmdtAc9eNBvH0H/ZpiBw=="
        crossorigin="anonymous" referrerpolicy="no-referrer" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.4/jquery.min.js"
    integrity="sha512-pumBsjNRGGqkPzKHndZMaAG+bir374sORyzM3uulLV14lN5LyykqNk8eEeUlUkB3U0M4FApyaHraT65ihJhDpQ=="
    crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <link rel="stylesheet" href="{% static 'css/patients.css' %}">
    <link rel="stylesheet" href="{% static 'css/patients_exstra.css' %}">
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.4/css/jquery.dataTables.min.css">
    <title>{{specs.title}} - {% trans 'Patients' %}</title>
    <link rel="icon" type="image/png" href="{% static specs.favicon %}" />
    <style>
        body.dark #example_length option{
            background-color: #333!important;
            color: #fff!important;
            
        }
    </style>
{% endblock %}


{% block content %}
    <div id="modal-delete-patient" class="modal-container">
        <div class="modal-box">
            <div class="modal-box__close">
                <div class="close-icon" data-modal-close>
                    <i class="fa-solid fa-xmark"></i>
                </div>
            </div>
            <div class="modal-big-icon">
                <i class="fa-regular fa-trash-can shadow"></i>
            </div>
            <p class="main-text w-75 mx-auto text-center">{% trans 'Are you sure you want to delete the patient?' %}</p>
            <div class="modal-container__buttons d-flex justify-content-center">
                <button class="custom yes" data-btn-operation="delete-patient">{% trans 'Yes' %}</button>
                <button class="custom no" data-modal-close>{% trans 'No' %}</button>
            </div>
        </div>
    </div>
    <main>
        <!-- veri varsa d-none class kaldır, yoksa d-none kalsın -->
        <div class="views container {% if patients_list is None %}d-none{% endif %}">
            <div class="heading-and-items container-fluid d-flex justify-content-between align-items-center my-3">
                <h1 class="m-0">{% trans 'Patients' %}</h1>
                <div class="heading-and-items_right d-flex">
                    <input type="text" id="mySearchBox" class="search-input" placeholder="Search">
                    <div class="datatable-length-selectbox"></div>
                    <div class="view-icon {% if view_type == '0' %}active{% else %}{% endif %}" data-view_type="0" data-type="#patients-table-view">
                        <i class="fa-solid fa-bars-staggered"></i>
                    </div>
                    <div class="view-icon {% if view_type == '1' %}active{% else %}{% endif %}" data-view_type="1" data-type="#patients-card-view">
                        <i class="fa-solid fa-table-cells-large"></i>
                    </div>
                    <!-- <select class="patients-list-count-select" name="" id="">
                        <option value="10">10</option>
                        <option value="10">20</option>
                        <option value="10">50</option>
                        <option value="10">100</option>
                        <option value="-1">All</option>
                    </select> -->
                </div>
            </div>
            <div id="patients-table-view" class="patient-view-container container-fluid mt-3 mb-5" style="{% if view_type == '0' %} display: block;{% else %} display: none;{% endif %}">
                <div class="contents">
                    <table id="example" class="patients-table table table-borderless display" style="width: 100%;">
                        <thead>
                            <tr>
                                <th>{% trans 'Favorite' %}</th>
                                <th>{% trans 'Patient ID' %}</th>
                                <th>{% trans 'Patient Name' %}</th>
                                <th>{% trans 'Image' %}</th>
                                <th>{% trans 'Date of Birth' %}</th>
                                <th>{% trans 'Created Date' %}</th>
                                <th>{% trans 'Last Process' %}</th>
                                <th>{% trans 'X-Ray Types' %}</th>
                                <th>{% trans 'Operation' %}</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for patient_key in patients_list %}
                                <tr data-patient-id="{{patient_key.patient.id}}">
                                    <td>
                                        <i data-patient-slug="{{patient_key.patient.slug}}" class="fa-solid fa-star star-icon {% if patient_key.patient.favorited %} active {% else %} {% endif %}"></i>
                                        <span data-star-span-slug="{{patient_key.patient.slug}}" class="star-icon-value">{% if patient_key.patient.favorited %} 1 {% else %} 0 {% endif %}</span>
                                    </td>
                                    <td>{{patient_key.patient.id}}</td>
                                    <td>{{patient_key.patient.first_name}} {{patient_key.patient.last_name}}</td>
                                    <td>
                                        <img src="{% if patient_key.cover_image is None and lang == 'tr' %} {% static 'img/addradio_tr.svg' %} {% elif patient_key.cover_image is None and lang == 'en'%} {% static 'img/addradio_ing.svg' %} {% else %} https://aiv2.craniocatch.com/media/{{patient_key.cover_image}} {% endif %}" width="100" style="height:49px; background: white" class="img-fluid" alt="">
                                    </td>
                                    <td>{{patient_key.patient.date_of_birth}}</td>
                                    <td>{{patient_key.patient.created_date}}</td>
                                    <td>{{patient_key.patient.modified_date}}</td>
                                    <td>
                                        <div class="spans d-flex flex-wrap">
                                            {% for radiography_types in patient_key.image_types %}
                                                <span>{{radiography_types}}</span>
                                            {% endfor %}
                                        </div>
                                    </td>
                                    <td>
                                        <div class="operations-buttons d-flex">
                                            <a href="">
                                                <i class="fa-solid fa-play" data-bs-toggle="tooltip" data-bs-placement="top"
                                                    title="Tooltip on top"></i>
                                            </a>
                                            <a href="{% url 'addpatientPageSlug' patient_key.patient.slug %}">
                                                <i class="fa-solid fa-pencil" data-bs-toggle="tooltip"
                                                    data-bs-placement="top" title="Tooltip on top"></i>
                                            </a>
                                            <a href="">
                                                <i class="fa-solid fa-eye" data-bs-toggle="tooltip" data-bs-placement="top"
                                                    title="Tooltip on top"></i>
                                            </a>
                                            <a href="">
                                                <i class="fa-solid fa-paper-plane" data-bs-toggle="tooltip"
                                                    data-bs-placement="top" title="Tooltip on top"></i>
                                            </a>
                                            
                                            <i class="fa-solid fa-trash-can" data-bs-toggle="tooltip"
                                                data-bs-placement="top" title="Tooltip on top"
                                                data-open-modal-pk="modal-delete-patient"
                                                data-modal-type="patient-delete"></i>
                                        </div>
                                    </td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
            <div id="patients-card-view" class="patient-view-container container-fluid mt-3 mb-5"
                style="{% if view_type == '1' %} display: block;{% else %} display: none;{% endif %}">
                <div class="cards" style="margin-bottom: 50px;">
                    {% for patient_key in patients_list %}
                        <div class="card-item" data-patient-id="{{patient_key.patient.id}}">
                            <div class="img-container position-relative">
                                <img src="{% if patient_key.cover_image is None and lang == 'tr' %} {% static 'img/addradio_tr.svg' %} {% elif patient_key.cover_image is None and lang == 'en'%} {% static 'img/addradio_ing.svg' %} {% else %} https://aiv2.craniocatch.com/media/{{patient_key.cover_image}} {% endif %}"
                                    class="card-item-img" width="218" style="height:129px" alt="">
                                <div class="number position-absolute">{{patient_key.patient.id}}</div>
                            </div>
                            <div class="content-container">
                                <p>
                                    <i data-patient-slug="{{patient_key.patient.slug}}" class="fa-solid fa-star star-icon {% if patient_key.patient.favorited %} active {% else %} {% endif %}"></i>
                                    <span style="font-size:15px">{{patient_key.patient.first_name}} {{patient_key.patient.last_name}}</span>
                                </p>
                                <p>{{patient_key.patient.date_of_birth}}</p>
<!--                                <p>This is a short description about the card.</p>-->
                                <div class="tags justify-content-start">
                                    {% for radiography_types in patient_key.image_types %}
                                        {% if forloop.counter|divisibleby:2 %}
                                            <span style="background-color: #0EA89C;">{{radiography_types}}</span>
                                        {% else %}
                                            <span style="background-color: #0E489C;">{{radiography_types}}</span>
                                        {% endif %}
                                    {% endfor %}
                                </div>
                            </div>
                            <div class="action-btn-container d-inline-flex align-items-center">
                                <a href="">
                                    <i class="fa-solid fa-play" data-bs-toggle="tooltip" data-bs-placement="top"
                                    title="Tooltip on top"></i>
                                </a>
                                <a href="{% url 'addpatientPageSlug' patient_key.patient.slug %}">
                                    <i class="fa-solid fa-pencil" data-bs-toggle="tooltip" data-bs-placement="top"
                                    title="Tooltip on top"></i>
                                </a>
                                <a href="">
                                    <i class="fa-solid fa-eye" data-bs-toggle="tooltip" data-bs-placement="top"
                                    title="Tooltip on top"></i>
                                </a>
                                <a href="">
                                    <i class="fa-solid fa-paper-plane" data-bs-toggle="tooltip" data-bs-placement="top"
                                    title="Tooltip on top"></i>
                                </a>
                                <i class="fa-solid fa-trash-can" data-bs-toggle="tooltip" data-bs-placement="top"
                                    title="Tooltip on top" data-open-modal-pk="modal-delete-patient"
                                    data-modal-type="patient-delete-with-card"></i>
                            </div>
                        </div>
                    {% endfor %}
                </div>
                <div class="patients-pagination d-flex justify-content-center d-flex my-2">
                    {% if page_obj.has_previous %}
                        <a href="?page=1">
                            <button class="custom">
                                <i class="fa-solid fa-angle-left"></i>
                                <span>First</span>
                            </button>
                        </a>
                        <a href="?page={{ page_obj.previous_page_number }}">
                            <button class="custom">{{ page_obj.previous_page_number }}</button>
                        </a>
                    {% endif %}

                    <button class="custom active">{{ page_obj.number }}</button>

                    {% if page_obj.has_next %}
                        <a href="?page={{ page_obj.next_page_number }}">
                            <button class="custom">{{ page_obj.next_page_number }}</button>
                        </a>
                        <a href="?page={{ page_obj.paginator.num_pages }}">
                            <button class="custom">
                                <span>Last</span>
                                <i class="fa-solid fa-angle-right">
                                </i>
                            </button>
                        </a>
                    {% endif %}


                </div>
            </div>
        </div>
        {% csrf_token %}
        <!-- burada hiç veri yoksa d-none classını kaldır, veri varsa d-none kalacak -->
        <div class="no-data-container h-100 d-flex align-items-center justify-content-center {% if patients_list is not None %}d-none{% endif %}">
            <div id="no-data" class="shadow text-center p-5">
                <img src="{% static 'img/nodata.png' %}" class="img-fluid" alt="">
                <h3>{% trans 'Welcome'%} {{full_name}}!</h3>
                <h4>{% trans 'Hi' %} {{full_name}}, {% trans 'you can continue by starting to <strong>Add Favorite Patients!</strong>'%}</h4>
                <a href="{% url 'patientsPage' %}">
                    <button class="custom">{% trans "Let's Go!" %}</button>
                </a>
            </div>
        </div>
    </main>
{% endblock %}

{% block customJs %}
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM"
        crossorigin="anonymous"></script>

    <script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/swiper@9/swiper-bundle.min.js"></script>

    <script src="{% static 'js/app.js' %}"></script>
    <script>
        // base html den zaten çekiliyor
        // var userThemeChoices = JSON.parse('{{ user_theme_choices_json|escapejs }}');
    </script>
    <script src="{% static 'js/patients.js' %}"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
        $(document).ready(function() {
            // patients sayfasında patient silmek için kullanılan fonksiyon
            $("[data-btn-operation='delete-patient']").click(function (event) {
                var csrfmiddlewaretoken= $('input[name=csrfmiddlewaretoken]').val()
                let patientId = $(event.target).closest(".modal-container").attr("data-patient-id")
                $.ajax({
                    url: "/api/delete-patient-api",
                    method: "POST",
                    headers: { "X-CSRFToken": csrfmiddlewaretoken },
                    data: {
                        "patientId": patientId,

                    },
                    success: function (response) {
                        Swal.fire({
                        position: 'top-end',
                        icon: 'success',
                        title: '{% trans "Patient deleted successfully." %}',
                        showConfirmButton: false,
                        timer: 2000
                    }).then(function() {
                        window.location.reload()
                    });
                        
                    },
                    error: function (xhr, errmsg, err) {
                        console.log(xhr.status + ": " + xhr.responseText)
                        
                    }
                })
                $(event.target).closest(".modal-container").removeClass("active")
            })
        })
    </script>
{% endblock %}